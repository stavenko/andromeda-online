var CelestialCalculatorGetter = (function(){
var PredefinedOrbitalPlanes = [[0,1,0],[0,1,0],[0,1,0],[0,1,0],[0,1,0],[0,1,0],[0,1,0],[0,1,0],[0,1,0],[0,1,0],[0,1,0],
    [-0.3090169943749474,0.9510565162951535,0],
    [-0.24999999999999994,0.9510565162951535,0.1816356320013402],
    [-0.09549150281252627,0.9510565162951535,0.2938926261462365],
    [0.09549150281252627,0.9510565162951535,0.2938926261462365],
    [0.24999999999999992,0.9510565162951535,0.18163563200134025],
    [0.3090169943749474,0.9510565162951535,3.784366729417715e-17],
    [0.24999999999999994,0.9510565162951535,-0.18163563200134017],
    [0.09549150281252632,0.9510565162951535,-0.2938926261462365],
    [-0.09549150281252623,0.9510565162951535,-0.2938926261462365],[-0.24999999999999992,0.9510565162951535,-0.18163563200134025],[-0.3090169943749474,0.9510565162951535,-7.56873345883543e-17],

    [-0.5877852522924731,0.8090169943749473,0],
    [-0.47552825814757677,0.8090169943749473,0.3454915028125263],[-0.1816356320013402,0.8090169943749473,0.5590169943749475],[0.1816356320013402,0.8090169943749473,0.5590169943749475],[0.47552825814757665,0.8090169943749473,0.3454915028125264],[0.5877852522924731,0.8090169943749473,7.198293276126593e-17],
    [0.47552825814757677,0.8090169943749473,-0.3454915028125262],[0.1816356320013403,0.8090169943749473,-0.5590169943749473],[-0.18163563200134014,0.8090169943749473,-0.5590169943749475],[-0.47552825814757665,0.8090169943749473,-0.3454915028125264],
    [-0.5877852522924731,0.8090169943749473,-1.4396586552253185e-16],[-0.8090169943749473,0.5877852522924731,0],[-0.6545084971874736,0.5877852522924731,0.47552825814757677],[-0.24999999999999994,0.5877852522924731,0.7694208842938133],
    [0.24999999999999994,0.5877852522924731,0.7694208842938133],[0.6545084971874735,0.5877852522924731,0.4755282581475768],[0.8090169943749473,0.5877852522924731,9.907600723509855e-17],[0.6545084971874736,0.5877852522924731,-0.47552825814757665],
    [0.2500000000000001,0.5877852522924731,-0.7694208842938132],[-0.24999999999999986,0.5877852522924731,-0.7694208842938133],[-0.6545084971874735,0.5877852522924731,-0.4755282581475768],[-0.8090169943749473,0.5877852522924731,-1.981520144701971e-16],
    [-0.9510565162951535,0.3090169943749474,0],[-0.7694208842938133,0.3090169943749474,0.5590169943749475],[-0.2938926261462365,0.3090169943749474,0.9045084971874736],[0.2938926261462365,0.3090169943749474,0.9045084971874736],
    [0.7694208842938132,0.3090169943749474,0.5590169943749476],[0.9510565162951535,0.3090169943749474,1.1647083181762659e-16],[0.7694208842938133,0.3090169943749474,-0.5590169943749473],[0.2938926261462367,0.3090169943749474,-0.9045084971874735],
    [-0.2938926261462364,0.3090169943749474,-0.9045084971874736],[-0.7694208842938132,0.3090169943749474,-0.5590169943749476],[-0.9510565162951535,0.3090169943749474,-2.3294166363525317e-16],[-1,0,0],[-0.8090169943749473,0,0.5877852522924731],
    [-0.3090169943749474,0,0.9510565162951535],
    [0.3090169943749474,0,0.9510565162951535],[0.8090169943749472,0,0.5877852522924732],[1,0,1.224646798818428e-16],
    [0.8090169943749473,0,-0.587785252292473],[0.30901699437494756,0,-0.9510565162951534],
    [-0.3090169943749473,0,-0.9510565162951535],
    [-0.8090169943749472,0,-0.5877852522924732],[-1,0,-2.449293597636856e-16]]
var G = 6.6738480 * Math.pow(10, -11);

    var CelestialCalculator = function(){
        this.celestials = {};
        this.positions = {};
        
        this.addCelestial = function(celestialDescription, timeOut){
            this.celestials[celestialDescription.GUID] = celestialDescription;
            this.celestials[celestialDescription.GUID].timeout = timeout;
            this.celestialNames[celestialDescription.name] = celestialDescription.GUID;
        }

        this.getRelatedPosition = function( position, celestialName ){
            var celestialPosition = this.getPosition(celestialName);
            return celestialPosition.sub(position);
        }

        this.getPosition = function(celestialName){
            var guid = this.celestialNames[celestialName];
            var position = this._getPosition(guid);
        }

        this._getPosition = function(guid){
            var n = Date.now();
            var c = this.celestials[guid];
            var t = c.timeout;
            var pos = this.positions[guid];
            if(n - pos.time > t){
                pos = {vector: this._calculate(guid, n),
                       time:n
                };
                this.positions[guid] = pos;
            }
            return this.positions[guid].vector;
           
        }

        this._calculate = function(guid, n){
            var C = this.celestials[guid];
            if(C.orbit){
                var position = this._position(C, n); // Zero-relative;
                var parentPosition = _getPosition(C.C)
                return parentPosition.clone().add(position);
            }else{
                return new THREE.Vector3().fromArray( position ) ;
            }
        }

        this._calcE = function(e, M, accuracy){
            var Enew=1;
            var Eold=0;
            var Etemp=0;
            var E=0;
            while(Math.abs(Enew-Eold) > accuracy){
                Etemp=Enew;
                Enew=M+e*Math.sin(Eold);
                Eold=Etemp;
            }
            E=Enew;
            return E;
        }

        this.trueAnom = function (ec,E,dp) {
            var S=Math.sin(E);
            var C=Math.cos(E);
            var fak=Math.sqrt(1.0-ec*ec);
            var phi=Math.atan2(fak*S,C-ec) //  /K;
            return Math.round(phi*Math.pow(10,dp))/Math.pow(10,dp);
        }

        this._planeCoords = function(celestial, time){

            if(celestial.orbit == undefined){
                console.error("orbit is not defined for", celestial.name);
                return;
            }
            if(celestial.orbit.is_predefined){
                // we need some additional parameters to calculate orbit params;
                var parentCelectial = this.celestials[celestial.orbit.C];
                var min_height = parentCelectial.R * 0.05; // %5 of planet radius - minimum height of orbit;
                var height_step = parentCelectial.R * 0.01; // height step is 1% of planet R
                var n = PredefinedOrbitalPlanes[celestial.orbit.n];
                var e = 1;
                var a = min_height + celestial.orbit.a * height_step;
                var mu = G * parentCelectial.M;
                var T = 2 * Math.PI * Math.sqrt( a*a*a / mu )
                var P = 0;
                var ph  = celestial.orbit.t0 * T/5;  
            }else{
                var ph = celestial.orbit.t0 ; // + time of last sightSeeing
                var e = celestial.orbit.e;
                if(e == undefined ){ e = 1.0; }
                var a = celestial.orbit.a;
                var T = celestial.orbit.T ;
                var P =celestial.orbit.P;
            }
            var ptime = time + ph;
            var M = ptime * Math.PI / (T/2) ;
            var E = this._calcE(e, M, 0.0000001) ;
            var phi = this.trueAnom(e, E, 7) ;
            var R   = a*(1-e*e)/(1+e*Math.cos(phi));
            phi += P;
            var pos = new THR.Vector3(R * Math.cos(phi), R* Math.sin(phi), 0);
            return pos;
        }

        this._position = function(celestial, time){
            if(celestial.orbit == undefined){
                console.error("orbit is not defined for", celestial.name);
                return;
            }
            var m = this._getRotationMatrix(celestial.orbit.n);
            var q = new THR.Quaternion();
            q.setFromRotationMatrix(m);
            var pos = this._planeCoords(celestial, time);
            pos.applyQuaternion(q);
            return pos;
        }

        this._getRotationMatrix = function(normal){
            // rotation relative to z axis;
            var n = new THR.Vector3().fromArray(normal);
            n.normalize();
            var Z = new THR.Vector3(0,0,-1);
            var axis = Z.clone().cross(n.clone() ) ;
            axis.normalize();
            var angl = Math.acos(Z.dot(n));
            var m = new THR.Matrix4();
            m.makeRotationAxis(axis, angl);
            return m;
        }

    }

    var ccc = null;

    return function(){
        if(ccc == null){
            ccc = new CelestialCalculator();
        }
    }



})()

var CustomUpdaterGetter = (function (){
    
    var customUpdaterCache = null;

    var CustomUpdater = function(){
        this.updaterList = {};
        this.add = function( name, updater ){
            this.updaterList[name] = updater;
        }
        this.remove = function(name){
            delete this.updaterList[name]
        }
        this.update = function(){
            _.each(this.updaterList, function(func, name){
                func();
            })
        }
    }
    var updaterGetter = function(){
        if(customUpdaterCache == null){
            customUpdaterCache = new CustomUpdater();
        }
        return customUpdaterCache;
    }
    return updaterGetter;
})()

window.GameContextLoader = function(socketService){

    var scenePromises  = [];
    var celestialPromises = [];

    var scenes_in_process = [];

    var contextActors = [];
    var returnDefer = Q.defer();

    socketService.request("CTX", {user_id:true})
        .then(function(context){
            console.log("CONTEXT", context);
            _.each(context.contexts, function(scene_desc, actor_guid){
                var objectPromises = [];
                contextActors.push(actor_guid);
                var scene_guid = scene_desc.GUID;
                var sceneDef = Q.defer();
                if(scenes_in_process.indexOf( scene_guid  ) !== -1){
                    return;
                }else{

                    scenes_in_process.push(scene_guid);
                    scenePromises.push(sceneDef.promise)
                }
                var objects = scene_desc.objects;
                var scene_actors = scene_desc.actors;
                if(scene_desc.location.g.orbit){
                    celestialPromises.push(
                        socketService.get("celectial-recursive", {GUID: scene_desc.location.g.orbit.C})
                    );
                }
                _.each(objects, function(oguid) {
                    var p = socketService.get("A", {id: oguid})
                        .then(function (obj) {
                            return socketService.get("T", {type: obj.sub_type})
                                .then(function (t) {
                                    obj.sub_type = t;
                                    return obj;
                                })
                        });
                    objectPromises.push(p);
                });
                Q.all(celestialPromises).spread(function( celestials ){
                    console.log("Loaded celetestials", celestials );
                })


                Q.all(objectPromises).then(function(objects){
                    console.log("II", objects);
                    var threeScene =  new THREE.Scene();
                    var scene = new Scene(threeScene, self);
                    scene.GUID = scene_guid;
                    scene.onLoadCallback = function(){
                        sceneDef.resolve({
                            scene:scene,
                            threeScene: threeScene,
                            actors: scene_desc.actors
                        });
                    };
                    _.each(scene_actors, function(act){
                        scene.join_actor(act);
                    });

                    _.each(objects, function(obj){
                        scene.join_object(obj, obj.GUID);
                    });
                }).catch(function(e){
                    console.error(e);
                });
            });

            if( scenePromises.length == 0){
                returnDefer.reject("No scenes to load");
            }else{
                Q.all( scenePromises).then(function(scenes){
                    returnDefer.resolve({scenes:scenes, currentUserActors: contextActors});
                });
            }

        })
        .catch(function(e){
            console.error(e);
        });




    return returnDefer.promise;

}

var KeyMapper = function( viewPorts){
    this.viewPorts = viewPorts
    _.each(this.viewPorts, function(vp){
        if(vp.doDrawUI()){
            vp.view.actors
        }
    })

    

}

var InputServiceGetter = (function(){
    var InputService = function( ){
        var mouseState = {x:0, y:0};
        this.mouseState = mouseState;
        var that = this;
        document.addEventListener( 'mousemove', function(e){
            mouseState.x = e.x;
            mouseState.y = e.y;
        }, false );
        RendererGetter().domElement().addEventListener('mouseup', function(e){
            that.input( 'lmouse', false)
            
        });
        RendererGetter().domElement().addEventListener('mousedown', function(e){
            that.input( 'lmouse', true)
        });
        document.addEventListener('keydown', function(e){
            var code = e.keyCode;
            that.input( code, true)
        }, false);
        document.addEventListener('keyup', function(e){
            var code = e.keyCode;
            that.input(code, false)
        }, false);
        this.keyCodes = {};
        this.keyMap = null;
        this.setKeyMap = function(keyMap){
            this.keyMap = keyMap;
        }
        this.viewportService = ViewportServiceGetter()

        this.getMouseProjectionArray = function(){
            return this.viewportService.project(this.mouseState);
        }
        this.viewports = null;
        this.setActiveScene = function(scene){
            this.scene = scene;

        }
        this.input = function(keycode, up_or_down){
            var ts = new Date().getTime();
            if(up_or_down) {// down == true
                this.keyCodes[keycode] = {in_action:true, ts:ts};
            }else{
                if(this.keyCodes[keycode]){
                    var t = this.keyCodes[keycode].ts;
                    this.keyCodes[keycode].in_action = false;
                    this.keyCodes[keycode].ts = ts;
                    this.keyCodes[keycode].delta = ts - t;
                }
            }
        }
        var syncronizer = SynchronizerGetter();
        this.getLatestActions = function( sceneGuid, now ){
            if( this.scene.sceneGuid != sceneGuid){
                console.info("wrong scene for input");
                return [] ;
            }
            if(this.keyMap == null){ 
                console.warn("no keymap");
                return; 
            }
            var actions = [];
            var that = this;
            _.each(this.keyCodes, function(k_action, keycode){
                if(k_action.in_action){
                    var delta = now - k_action.ts;
                    var ts = now;
                    k_action.ts = now;
                }else{
                    var delta = k_action.delta;
                    var ts = k_action.ts;
                    delete this.keyCodes[keycode];
                }
                var action = _.clone(self.actions[keycode]);
                if(keycode in that.keyMap){
                    var act_desc  = that.keyMap[keycode];
                    var new_action = {
                        mesh : act_desc.mesh,
                        dev : act_desc.device,
                        name: act_desc.name,
                        ts :ts,
                        ident: ts + synchronizer.getCurrentTimeDiff() + synchronizer.getAverageLatencity(),
                        delta: delta/1000,
                        wmouse: that.getMouseProjectionArray()
                    }
                    actions.push(new_action);
                }
            });
            return actions;
        }
    };
    var InputServiceCache = null;
    var getter = function(){
        if(InputServiceCache == null){
            InputServiceCache = new InputService();
        }
        return InputServiceCache;
    }
    return getter;
})();


window.RendererGetter = (function(){
    "use strict";
    var Renderer = function(){
        var width   = document.body.clientWidth;
        var body = document.body,
            html = document.documentElement;
        var height = Math.max( body.scrollHeight, body.offsetHeight, 
                               html.clientHeight, html.scrollHeight, 
                               html.offsetHeight );

        this.height = height;
        this.width = width;
        console.info('Init renderer', width, height, document.body);
        this.glRenderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
        this.glRenderer.setSize( width, height );
        this.glRenderer.setClearColor(new THREE.Color(0x000000));
        document.body.appendChild(this.glRenderer.domElement);

        this.glRenderer.gammaInput = true;
        this.glRenderer.gammaOutput = true;
        this.glRenderer.autoClear = true ;

        this.glRenderer.physicallyBasedShading = true;
        
                                            


        this.domElement = function(){
            return this.glRenderer.domElement;
        }

        this.render = function ( viewPort ){
            this.glRenderer.setViewport(viewPort.config.l, viewPort.config.t, viewPort.config.w, viewPort.config.h)
            this.renderSkyBox( viewPort );
            this.renderCelestialScene( viewPort );
            this.renderScene( viewPort );
        }

        this.renderSkyBox = function( viewport ){
            var matrixOfPlayer = viewport.camera.parent.matrix.clone();
            var matrixOfCamera = viewport.camera.matrix.clone();
            matrixOfPlayer.multiply(matrixOfCamera);
            var rotationMatrix = new THREE.Matrix4().extractRotation(matrixOfPlayer);
            var q = new THREE.Quaternion().setFromRotationMatrix(rotationMatrix);
            viewport.skyBoxCamera.rotation.setFromQuaternion(q);


            
            // console.warn("Skybox is not rendered yet");
        }
        this.renderCelestialScene = function(){
            // console.warn("Celestial objects is not rendered yet");
        }
        this.renderScene = function(viewport){
            var scene = viewport.view.scene.three_scene;
            var camera = viewport.camera;
            this.glRenderer.render(scene, camera);
        }
         
    }

    var sc = null;
    return function(){
        if(sc == null ){
            sc = new Renderer();
        }
        return sc;
    }

})();

var Settings = (function(){

    var Service = function(){
        var USER_SETTINGS_KEY = "user-settings";
        var settings = JSON.parse(localStorage.getItem(USER_SETTINGS_KEY));
        if(settings){
            this.config = settings;
        }else{
            this.config = {};
        }


        this.getViewportBindings = function(){
            if (!(this.config['viewPortBindings'] )){
                this.config.viewPortBindings = this.defaultViewPortBindings;
                localStorage.setItem(USER_SETTINGS_KEY, JSON.stringify( this.config ));
            }
            return this.config.viewPortBindings
        }
        this.defaultViewPortBindings = {
            "ship.rookie_ship.Piloting.front" : "default"
        }
    }
    var sc = null;
    return function(){
        if(sc == null){
            sc = new Service();
        }
        return sc;
    }


})()


var SocketServiceGetter = (function(){
    "use strict";
    var SocketService = function(){
        var authHashF = function(cb){
            var d = Q.defer();
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/my-auth-hash/', true);
            xhr.send();

            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) {
                    if(xhr.status == 200) {
                        var js = JSON.parse(xhr.responseText);
                        cb(js);
                    }
                }
            };
        };
        var socket = io.connect();
        var is_ready = false;
        var Queue = [];

        var is_authenticated = Q.defer();
        socket.on('connected', function(){
            //console.log("reconnection");
            authHashF(function(json){
                // console.log(">>>",json);
                socket.emit("auth_hash", {auth: json.hash});
            })
        });
        socket.on("auth_completed", function(msg){
            if(msg.err){
                is_authenticated.reject(msg.err);
            }else{
                //console.log(">>");
                is_authenticated.resolve(true);
                //$rootScope.$apply(function(){is_authenticated.resolve(true)})
            }

        });
        // console.log(is_authenticated);
        is_authenticated.promise.then(function(s,e){
            // console.log(is_authenticated, s,e);
            is_ready = true;
            for(var i =0;i <Queue.length; i++){
                socket.emit(Queue[i].T, Queue[i].p);
            }
        });

        var S = {};
        var cbs = {};
        var incomingListeners = {};
        var curcbix = 0;
        function getCBIx(){
            curcbix+=1;
            return curcbix % 10000;
        };

        var Req = function(mt, t, p){
            var d = Q.defer(),
                cbix =  getCBIx();
            cbs[cbix] = {
                cb: d
            };
            var o = {p:p};
            o.cbix = cbix;
            o.T = t;
            if(!is_ready){
                Queue.push({T:mt,p:o});
            }else{
                socket.emit(mt, o);
            }

            return d.promise;
        };

        var messages_to_hear = ["Q", "R", 'S'];
        _.each(messages_to_hear, function(message_type){
            socket.on(message_type, function(msg){
                var cbix = msg.cbix;
                if(cbs.hasOwnProperty(cbix)) {
                    cbs[cbix].cb.resolve(msg.d);
                    delete cbs[cbix];
                }else{
                    console.warn("No such cbix in callbacks", cbix, message_type );
                }
            })

        });

        var specialEvents = ["F", "ALM"];

        _.each(specialEvents, function(event){
            socket.on(event, function(data){
                if(event in incomingListeners){
                    _.each(incomingListeners[ event ], function(listener){
                        listener(event, data);
                    })
                }
            });

        });
        S.get = function(t,p){
            return Req("Q", t,p)
        };
        S.sync = function(){
            return Req("S",'',{})
        };
        S.request = function(t,p){
            return Req("R", t,p)
        };
        S.action =function(mess){
            socket.emit("A",mess)
        };
        S.addListener = function(event, func){
            if(!(event in incomingListeners)){
                incomingListeners[event] = [];
            }
            incomingListeners[event].push(func);
        }
        return S;
    };

    var socketServiceCache = null;
    var getter = function(){
        if( socketServiceCache == null ) {
           socketServiceCache = SocketService();
        }
        return socketServiceCache;
    }
    return getter;
})();

var SynchronizerGetter = (function(){

    var synchronizerCache = null;

    var Synchronizer = function(socketService){
        var MAX_DIFF_LENGTH = 10;
        var DROP_FIRST_DIFFS = 4;
        var SYNC_TIMEOUT = 1000;
            
        var that = this;

        this.lastTimestamp = 0;
        this.latencities = []
        this.timeDiffs = [];
        this.diffCount = 0;
        this.isStopped = false;
         

        this.socketSyncClosure = function(syncData){
            var currentTimeStamp = Date.now();
            var ping = currentTimeStamp - that.lastTimestamp;
            that.latencities.push(ping / 2);
            that.averageLatencity = Math.floor(that.average(that.latencities) );
            var timeDiff = syncData.ts - that.lastTimestamp;
            that.diffCount += 1;
            if(DROP_FIRST_DIFFS > that.diffCount){
                that.timeDiffs.push(timeDiff);
            }
            if(that.timeDiffs.length > MAX_DIFF_LENGTH){that.timeDiffs.splice(0,1) }
            that.timeDiff = that.average(that.timeDiffs);
            if(! that.isStopped ){
                setTimeout(function(){
                    that.syncLoop();
                }, SYNC_TIMEOUT);
            };
        }

        this.average = function(array){
            return _.reduce(array, function(a,b){return a+b}, 0) / array.length;
        }
        
        this.syncLoop = function(){
            // console.info("sync");
            this.lastTimestamp = Date.now();
            socketService.sync( ).then( this.socketSyncClosure );
        }
        
        this.getCurrentTimeDiff = function(){
            return this.timeDiff;
        }
        this.getAverageLatencity = function(){
            return this.averageLatencity;
        };
        this.start = function(){
            if (this.isStopped){
                this.isStopped = false;
                this.syncLoop();
            }
             
        }
        this.stop = function(){
            this.isStopped = true;
             
        }
    }
    var getter = function(){
        if(synchronizerCache == null){
            synchronizerCache = new Synchronizer( SocketServiceGetter() );
        }

        return synchronizerCache;
    }
    return getter;

})()

window.View = function(scene, viewName, controllableObject, controllabelMesh){
    this.actors = {};
    this.UIS = [];
    this.scene= scene;
    this.viewName = viewName;
    this.object = controllableObject;
    this.mesh = controllabelMesh;

    this.skyboxScene = new THREE.Scene();
    this.celestialScene = new THREE.Scene();


    this.bind = function(vp){
        this.viewport = vp;
    }
    this.unbindViewport = function(){
        this.mesh.remove(this.viewport.camera)
        this.viewport = undefined;
    }


    this.addActor = function( actor ){
        this.actors[actor.GUID] = actor;

    };
    this.addUI = function( ui ){
        this.UIS.push( ui );
    }


}

var ViewCollection = function(){
    this.views={},
    this.viewOrder= [],
    this.identityMap = {},
    this.byGlobalName ={},
    this.add= function(identity, globalName ,view, actor, UI){
        if(!(identity  in this.views)){
            this.views[identity] = view;
            this.viewOrder.push(identity);
        }
        this.byGlobalName[globalName] = view;
        this.views[identity].addActor( actor );
        this.views[identity].addUI( UI );
    },
    this.get= function(id){
        return this.views[id];

    },
    this.getByGlobalName = function(name){
        return this.byGlobalName[name];
    },
    this.getIx =function(ix){
        var n = this.viewOrder[ix];
        return this.get(n);
    }

}

window.Viewport = function( config ){

    this.config = config;
    this.name = config.name;
    this.keyMap = {};
    this.actions = {};


    this.doDrawUI = function(){
        return this.config.drawUI;
    };

    this.makeCamera = function(){
        var cameraBaseVector = new THREE.Vector3(0,0,-1);
        console.log("making camera" , this.config);
        var camera = new THREE.PerspectiveCamera(45, this.config.w / this.config.h, 1, 1000);
        var axis = new THREE.Vector3();
        var vpRotation = this.view.object.cameras[this.view.viewName].direction;
        var vpPosition = this.view.object.cameras[this.view.viewName].position;

        axis.crossVectors(cameraBaseVector, new THREE.Vector3().fromArray(vpRotation) );
        var rotAngle = Math.acos(cameraBaseVector.dot(new THREE.Vector3().fromArray( vpRotation) ) );
        camera.position.fromArray(vpPosition);


        camera.rotateOnAxis(axis, rotAngle);
        this.camera = camera;
        this.skyBoxCamera    = new THREE.PerspectiveCamera(45, this.config.w / this.config.h, 1, 1000) 
        this.celestialCamera = new THREE.PerspectiveCamera(45, this.config.w / this.config.h, 1, 1000) 
        this.view.mesh.add(camera);
    }

    this.bind = function( view ){
        console.info("BIND", this.view);
        if(this.view){
            this.view.unbindViewport();
        }

        this.view = view;
        var that = this;
        _.each(view.actors, function(a){
            var actions = view.scene.getActions()[a.control.object_guid];
            _.each(actions, function(action){
                if(action.default_key){
                    that.keyMap[action.default_key] = action;
                }
                that.actions[action.name] =  action;
            })
        });
        this.makeCamera();
        this.view.bind(this);
    }

    this.unprojectCoords = function(x, y){
        var vpGeometry = this.config;
        var vpX = x - vpGeometry.l;
        var vpY = y - vpGeometry.t;
        var X = (vpX / vpGeometry.w *2) -1;
        var Y = (vpY / vpGeometry.h *2) +1;
        var result = new THREE.Vector3(X, Y, 0.99 )
        this.projector.unprojectVector(result, this.camera);
        return result.clone();
    }
}

var ViewportServiceGetter = (function(){

    var Service = function(){
        this.viewports = {};
        this.renderer = RendererGetter();

        this.readConfig = function(){
            var w34 = this.renderer.width/4 * 3;
            var w4  = this.renderer.width/4;
            var h3  = this.renderer.height/2;

            return [
                {
                    l:0, t:0, 
                    w:this.renderer.width, h:this.renderer.height, 
                    drawUI: true, name:"default"
                },
                {l:w34, t:h3*2, w:w4, h:h3, name:"topleft"},
                {l:w34, t:h3, w:w4, h:h3, name:"centerleft"},
                {l:w34, t:0, w:w4, h:h3, name:"bottomleft"}
            ];
        }
        this.setup = function(){
            var that = this;
            _.each(this.readConfig(), function(config){
                var viewport = new Viewport(config);
                that.viewports[config.name] = viewport;
            });
        }
        this.project = function( mouseState ){
            console.warn("mouse projection over viewports is not implemented");
        }

    
        this.getViewports= function(){
            return this.viewports; 
        }
        this.bindViews = function( viewsCollection ){
            var bindConfig = Settings().getViewportBindings();
            var that = this;
            _.each(bindConfig, function(viewportName, bindString ){
                var vp = that.viewports[viewportName];
                var v  = viewsCollection.getByGlobalName(bindString);
                vp.bind( v );
            })
            // InputServiceGetter().setViewports( this.getViewports());
            InputServiceGetter()
            .setActiveScene( this.viewports["default"].view.scene);


        }
    }

    var sc = null;
    return function(){
        if(sc == null){
            sc = new Service();
        }
        return sc;
    }
   

})()

window.World = function(auth_hash, user_id){
    this.auth_hash = auth_hash;
    this.user_id = user_id;

    this.isStopped = false; 


    this.initRenderer();
    this.initCustomUpdater();
    this.setupViewports();

    var checkContext = function(){
        var that = this;

        this.startSceneLoading()
        .then(function(){
            console.info("Go loading");
            that.initViews();
            console.info("Views inited");
            that.initSyncing();
            console.info("Syncing inited");
            that.setupNetworkListeners();
            console.info("network listeners set up");
        })
        .then(function(){
            console.info("Go simulation");
            that.startSimulation();
        })
        .fail(function(reason){
            console.warn( reason );
            setTimeout( checkContext, 3000 );
            that.clear();
            delete that;

        })
        .catch(function(e){
            console.error(e);
            that.clear();
        }).done();
    };

    checkContext = checkContext.bind(this);
    checkContext();

};

window.World.prototype = _.extend(window.World.prototype, {
    
    clear: function(){
        if (this.scenes){
            console.info('clearing scenes');
            for (var i in this.scenes){
                this.scenes[i].clear();
                this.scenes[i]= null;
                delete this.scenes[i];
            }
            
        }

        if(! (this.synchronizer)){
            this.synchronizer = SynchronizerGetter();

        }
        this.synchronizer.stop();

    },
    initRenderer : function(){
        this.renderer = new RendererGetter();
    },
    setupViewports : function(){
        this.viewportService = ViewportServiceGetter();
        this.viewportService.setup();

    },

    startSceneLoading : function(){
        var scenePromise = GameContextLoader ( SocketServiceGetter() )
        var that = this;
        that.scenes = {};
        that.actors = {};
        that.actorScene = {};
        return scenePromise.then(function(context){
            _.each(context.scenes, function(sceneDescription){
                that.scenes[sceneDescription.scene.GUID] = sceneDescription.scene;
                _.each(sceneDescription.actors, function(actor){
                    if(context.currentUserActors.indexOf(actor.GUID) !== -1){ // actor.GUID in context.currentUserActors
                        that.actors[actor.GUID] = actor;
                        that.actorScene[actor.GUID] = sceneDescription.scene;
                    }
                });
            });
        })
    },

    initViews: function(){
        var that = this;
        var viewCollection = new ViewCollection();
        _.each(this.actors, function(actor){
            var scene = that.actorScene[actor.GUID];
            var views = scene
                .get_object(actor.control.object_guid)
                .workpoints[actor.control.workpoint].views;
            var object = scene.get_object(actor.control.object_guid)
            var mesh = scene.meshes[actor.control.object_guid];
            var uis = mesh.getUIForWP(actor.control.workpoint);
            _.each(views, function(viewName){
                var viewGlobalName = [object.type, object.sub_type, actor.control.workpoint, viewName].join('.');
                var viewIdentity = scene.GUID + actor.control.object_guid + viewName;
                var view = new View(scene, viewName, object, mesh );
                viewCollection.add(viewIdentity, viewGlobalName, view, actor, uis );

            });

        });

        this.viewCollection = viewCollection;
        this.viewportService.bindViews(this.viewCollection);

    },

    initSyncing: function(){

        console.info("Syncronizer inited");

        this.synchronizer = SynchronizerGetter();
        this.synchronizer.start();
    },

    setupNetworkListeners: function(){

        var socketService = SocketServiceGetter();
        var that = this;
        socketService.addListener("F", function( data ){
            if(data.scene in that.scenes){
                that.scenes[data.scene]
                    .addNetworkMessage(data.a)
            }

        });
        socketService.addListener("ALM", function( data ){
            if(data.scene in that.scenes){
                that.scenes[data.scene].sync(data.almanach);
            }
        });
    },
    initCustomUpdater : function(){
    
        this.customUpdaters = CustomUpdaterGetter();
    },
    makeSceneTicks : function(){
        _.each(this.scenes, function( scene, guid ){
            scene.tick();
        })
    },
    animate: function(){
        this.makeSceneTicks();
        this.customUpdaters.update();
        var that = this;
        _.each(this.viewportService.getViewports(), function(viewPort){
            // console.log("animate");
            if(viewPort.view){
                that.renderer.render(viewPort);
            }
        })
        if(!this.isStopped){
            requestAnimationFrame(this.animate.bind(this) );

        }
            

    },
    startSimulation: function(){
        if(this.isStopped){
            this.isStopped = false;
        }
        requestAnimationFrame(this.animate.bind(this));
    },
    stopAnimation : function(){
        this.isStopped = true;
    }
});

(function (){
    var StaticLogger = function(){
        this._vals = {}
        this.setValue = function(param, val){
            // console.log(param, val);
            this._vals[param] = val;
        }
        this.init = function(){
            this.cont = $("<div>").css({
                'position':'fixed',
                'top':0,
                'right':0,
                'width':400,
                'bottom':0,
                'background-color':"rgba(0,200,100,0.7)"
            }).appendTo('body');
            // 	console.log(this.cont);

        }
        this.redraw = function(){
            this.cont.find('*').remove();
            //console.log(this._vals);
            for(var i in this._vals){
                //console.log('asda');
                c = $('<div>').appendTo(this.cont)
                l = $('<span>').html(i + "&nbsp;: &nbsp;").css('font-weight','bold').appendTo(c);
                v = $('<span>').text( this._vals[i] ).appendTo(c);
            }
        };
    }
    window.SL = new StaticLogger();

})();


//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkNlbGVzdGlhbENhbGN1bGF0b3JHZXR0ZXIuanMiLCJDdXN0b21VcGRhdGVyLmpzIiwiR2FtZUNvbnRleHRMb2FkZXIuanMiLCJLZXlNYXBwZXIuanMiLCJLZXlTdGF0ZU1hbmFnZXIuanMiLCJOZXR3b3JrTWFuYWdlci5qcyIsIlJlbmRlcmVyLmpzIiwiU2V0dGluZ3MuanMiLCJTb2NrZXRTZXJ2aWNlR2V0dGVyLmpzIiwiU3luY2hyb25pemVyLmpzIiwiVmlldy5qcyIsIlZpZXdDb2xsZWN0aW9uLmpzIiwiVmlld3BvcnQuanMiLCJWaWV3cG9ydFNlcnZpY2VHZXR0ZXIuanMiLCJXb3JsZC5qcyIsInN0YXRpY0xvZ2dlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzNLQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMxQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzNGQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNYQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNyR0E7QUNBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdEVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDakNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNySUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMzRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQy9CQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzNCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDaEVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDL0RBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNyTEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJjbGllbnQubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIENlbGVzdGlhbENhbGN1bGF0b3JHZXR0ZXIgPSAoZnVuY3Rpb24oKXtcbnZhciBQcmVkZWZpbmVkT3JiaXRhbFBsYW5lcyA9IFtbMCwxLDBdLFswLDEsMF0sWzAsMSwwXSxbMCwxLDBdLFswLDEsMF0sWzAsMSwwXSxbMCwxLDBdLFswLDEsMF0sWzAsMSwwXSxbMCwxLDBdLFswLDEsMF0sXG4gICAgWy0wLjMwOTAxNjk5NDM3NDk0NzQsMC45NTEwNTY1MTYyOTUxNTM1LDBdLFxuICAgIFstMC4yNDk5OTk5OTk5OTk5OTk5NCwwLjk1MTA1NjUxNjI5NTE1MzUsMC4xODE2MzU2MzIwMDEzNDAyXSxcbiAgICBbLTAuMDk1NDkxNTAyODEyNTI2MjcsMC45NTEwNTY1MTYyOTUxNTM1LDAuMjkzODkyNjI2MTQ2MjM2NV0sXG4gICAgWzAuMDk1NDkxNTAyODEyNTI2MjcsMC45NTEwNTY1MTYyOTUxNTM1LDAuMjkzODkyNjI2MTQ2MjM2NV0sXG4gICAgWzAuMjQ5OTk5OTk5OTk5OTk5OTIsMC45NTEwNTY1MTYyOTUxNTM1LDAuMTgxNjM1NjMyMDAxMzQwMjVdLFxuICAgIFswLjMwOTAxNjk5NDM3NDk0NzQsMC45NTEwNTY1MTYyOTUxNTM1LDMuNzg0MzY2NzI5NDE3NzE1ZS0xN10sXG4gICAgWzAuMjQ5OTk5OTk5OTk5OTk5OTQsMC45NTEwNTY1MTYyOTUxNTM1LC0wLjE4MTYzNTYzMjAwMTM0MDE3XSxcbiAgICBbMC4wOTU0OTE1MDI4MTI1MjYzMiwwLjk1MTA1NjUxNjI5NTE1MzUsLTAuMjkzODkyNjI2MTQ2MjM2NV0sXG4gICAgWy0wLjA5NTQ5MTUwMjgxMjUyNjIzLDAuOTUxMDU2NTE2Mjk1MTUzNSwtMC4yOTM4OTI2MjYxNDYyMzY1XSxbLTAuMjQ5OTk5OTk5OTk5OTk5OTIsMC45NTEwNTY1MTYyOTUxNTM1LC0wLjE4MTYzNTYzMjAwMTM0MDI1XSxbLTAuMzA5MDE2OTk0Mzc0OTQ3NCwwLjk1MTA1NjUxNjI5NTE1MzUsLTcuNTY4NzMzNDU4ODM1NDNlLTE3XSxcblxuICAgIFstMC41ODc3ODUyNTIyOTI0NzMxLDAuODA5MDE2OTk0Mzc0OTQ3MywwXSxcbiAgICBbLTAuNDc1NTI4MjU4MTQ3NTc2NzcsMC44MDkwMTY5OTQzNzQ5NDczLDAuMzQ1NDkxNTAyODEyNTI2M10sWy0wLjE4MTYzNTYzMjAwMTM0MDIsMC44MDkwMTY5OTQzNzQ5NDczLDAuNTU5MDE2OTk0Mzc0OTQ3NV0sWzAuMTgxNjM1NjMyMDAxMzQwMiwwLjgwOTAxNjk5NDM3NDk0NzMsMC41NTkwMTY5OTQzNzQ5NDc1XSxbMC40NzU1MjgyNTgxNDc1NzY2NSwwLjgwOTAxNjk5NDM3NDk0NzMsMC4zNDU0OTE1MDI4MTI1MjY0XSxbMC41ODc3ODUyNTIyOTI0NzMxLDAuODA5MDE2OTk0Mzc0OTQ3Myw3LjE5ODI5MzI3NjEyNjU5M2UtMTddLFxuICAgIFswLjQ3NTUyODI1ODE0NzU3Njc3LDAuODA5MDE2OTk0Mzc0OTQ3MywtMC4zNDU0OTE1MDI4MTI1MjYyXSxbMC4xODE2MzU2MzIwMDEzNDAzLDAuODA5MDE2OTk0Mzc0OTQ3MywtMC41NTkwMTY5OTQzNzQ5NDczXSxbLTAuMTgxNjM1NjMyMDAxMzQwMTQsMC44MDkwMTY5OTQzNzQ5NDczLC0wLjU1OTAxNjk5NDM3NDk0NzVdLFstMC40NzU1MjgyNTgxNDc1NzY2NSwwLjgwOTAxNjk5NDM3NDk0NzMsLTAuMzQ1NDkxNTAyODEyNTI2NF0sXG4gICAgWy0wLjU4Nzc4NTI1MjI5MjQ3MzEsMC44MDkwMTY5OTQzNzQ5NDczLC0xLjQzOTY1ODY1NTIyNTMxODVlLTE2XSxbLTAuODA5MDE2OTk0Mzc0OTQ3MywwLjU4Nzc4NTI1MjI5MjQ3MzEsMF0sWy0wLjY1NDUwODQ5NzE4NzQ3MzYsMC41ODc3ODUyNTIyOTI0NzMxLDAuNDc1NTI4MjU4MTQ3NTc2NzddLFstMC4yNDk5OTk5OTk5OTk5OTk5NCwwLjU4Nzc4NTI1MjI5MjQ3MzEsMC43Njk0MjA4ODQyOTM4MTMzXSxcbiAgICBbMC4yNDk5OTk5OTk5OTk5OTk5NCwwLjU4Nzc4NTI1MjI5MjQ3MzEsMC43Njk0MjA4ODQyOTM4MTMzXSxbMC42NTQ1MDg0OTcxODc0NzM1LDAuNTg3Nzg1MjUyMjkyNDczMSwwLjQ3NTUyODI1ODE0NzU3NjhdLFswLjgwOTAxNjk5NDM3NDk0NzMsMC41ODc3ODUyNTIyOTI0NzMxLDkuOTA3NjAwNzIzNTA5ODU1ZS0xN10sWzAuNjU0NTA4NDk3MTg3NDczNiwwLjU4Nzc4NTI1MjI5MjQ3MzEsLTAuNDc1NTI4MjU4MTQ3NTc2NjVdLFxuICAgIFswLjI1MDAwMDAwMDAwMDAwMDEsMC41ODc3ODUyNTIyOTI0NzMxLC0wLjc2OTQyMDg4NDI5MzgxMzJdLFstMC4yNDk5OTk5OTk5OTk5OTk4NiwwLjU4Nzc4NTI1MjI5MjQ3MzEsLTAuNzY5NDIwODg0MjkzODEzM10sWy0wLjY1NDUwODQ5NzE4NzQ3MzUsMC41ODc3ODUyNTIyOTI0NzMxLC0wLjQ3NTUyODI1ODE0NzU3NjhdLFstMC44MDkwMTY5OTQzNzQ5NDczLDAuNTg3Nzg1MjUyMjkyNDczMSwtMS45ODE1MjAxNDQ3MDE5NzFlLTE2XSxcbiAgICBbLTAuOTUxMDU2NTE2Mjk1MTUzNSwwLjMwOTAxNjk5NDM3NDk0NzQsMF0sWy0wLjc2OTQyMDg4NDI5MzgxMzMsMC4zMDkwMTY5OTQzNzQ5NDc0LDAuNTU5MDE2OTk0Mzc0OTQ3NV0sWy0wLjI5Mzg5MjYyNjE0NjIzNjUsMC4zMDkwMTY5OTQzNzQ5NDc0LDAuOTA0NTA4NDk3MTg3NDczNl0sWzAuMjkzODkyNjI2MTQ2MjM2NSwwLjMwOTAxNjk5NDM3NDk0NzQsMC45MDQ1MDg0OTcxODc0NzM2XSxcbiAgICBbMC43Njk0MjA4ODQyOTM4MTMyLDAuMzA5MDE2OTk0Mzc0OTQ3NCwwLjU1OTAxNjk5NDM3NDk0NzZdLFswLjk1MTA1NjUxNjI5NTE1MzUsMC4zMDkwMTY5OTQzNzQ5NDc0LDEuMTY0NzA4MzE4MTc2MjY1OWUtMTZdLFswLjc2OTQyMDg4NDI5MzgxMzMsMC4zMDkwMTY5OTQzNzQ5NDc0LC0wLjU1OTAxNjk5NDM3NDk0NzNdLFswLjI5Mzg5MjYyNjE0NjIzNjcsMC4zMDkwMTY5OTQzNzQ5NDc0LC0wLjkwNDUwODQ5NzE4NzQ3MzVdLFxuICAgIFstMC4yOTM4OTI2MjYxNDYyMzY0LDAuMzA5MDE2OTk0Mzc0OTQ3NCwtMC45MDQ1MDg0OTcxODc0NzM2XSxbLTAuNzY5NDIwODg0MjkzODEzMiwwLjMwOTAxNjk5NDM3NDk0NzQsLTAuNTU5MDE2OTk0Mzc0OTQ3Nl0sWy0wLjk1MTA1NjUxNjI5NTE1MzUsMC4zMDkwMTY5OTQzNzQ5NDc0LC0yLjMyOTQxNjYzNjM1MjUzMTdlLTE2XSxbLTEsMCwwXSxbLTAuODA5MDE2OTk0Mzc0OTQ3MywwLDAuNTg3Nzg1MjUyMjkyNDczMV0sXG4gICAgWy0wLjMwOTAxNjk5NDM3NDk0NzQsMCwwLjk1MTA1NjUxNjI5NTE1MzVdLFxuICAgIFswLjMwOTAxNjk5NDM3NDk0NzQsMCwwLjk1MTA1NjUxNjI5NTE1MzVdLFswLjgwOTAxNjk5NDM3NDk0NzIsMCwwLjU4Nzc4NTI1MjI5MjQ3MzJdLFsxLDAsMS4yMjQ2NDY3OTg4MTg0MjhlLTE2XSxcbiAgICBbMC44MDkwMTY5OTQzNzQ5NDczLDAsLTAuNTg3Nzg1MjUyMjkyNDczXSxbMC4zMDkwMTY5OTQzNzQ5NDc1NiwwLC0wLjk1MTA1NjUxNjI5NTE1MzRdLFxuICAgIFstMC4zMDkwMTY5OTQzNzQ5NDczLDAsLTAuOTUxMDU2NTE2Mjk1MTUzNV0sXG4gICAgWy0wLjgwOTAxNjk5NDM3NDk0NzIsMCwtMC41ODc3ODUyNTIyOTI0NzMyXSxbLTEsMCwtMi40NDkyOTM1OTc2MzY4NTZlLTE2XV1cbnZhciBHID0gNi42NzM4NDgwICogTWF0aC5wb3coMTAsIC0xMSk7XG5cbiAgICB2YXIgQ2VsZXN0aWFsQ2FsY3VsYXRvciA9IGZ1bmN0aW9uKCl7XG4gICAgICAgIHRoaXMuY2VsZXN0aWFscyA9IHt9O1xuICAgICAgICB0aGlzLnBvc2l0aW9ucyA9IHt9O1xuICAgICAgICBcbiAgICAgICAgdGhpcy5hZGRDZWxlc3RpYWwgPSBmdW5jdGlvbihjZWxlc3RpYWxEZXNjcmlwdGlvbiwgdGltZU91dCl7XG4gICAgICAgICAgICB0aGlzLmNlbGVzdGlhbHNbY2VsZXN0aWFsRGVzY3JpcHRpb24uR1VJRF0gPSBjZWxlc3RpYWxEZXNjcmlwdGlvbjtcbiAgICAgICAgICAgIHRoaXMuY2VsZXN0aWFsc1tjZWxlc3RpYWxEZXNjcmlwdGlvbi5HVUlEXS50aW1lb3V0ID0gdGltZW91dDtcbiAgICAgICAgICAgIHRoaXMuY2VsZXN0aWFsTmFtZXNbY2VsZXN0aWFsRGVzY3JpcHRpb24ubmFtZV0gPSBjZWxlc3RpYWxEZXNjcmlwdGlvbi5HVUlEO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5nZXRSZWxhdGVkUG9zaXRpb24gPSBmdW5jdGlvbiggcG9zaXRpb24sIGNlbGVzdGlhbE5hbWUgKXtcbiAgICAgICAgICAgIHZhciBjZWxlc3RpYWxQb3NpdGlvbiA9IHRoaXMuZ2V0UG9zaXRpb24oY2VsZXN0aWFsTmFtZSk7XG4gICAgICAgICAgICByZXR1cm4gY2VsZXN0aWFsUG9zaXRpb24uc3ViKHBvc2l0aW9uKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZ2V0UG9zaXRpb24gPSBmdW5jdGlvbihjZWxlc3RpYWxOYW1lKXtcbiAgICAgICAgICAgIHZhciBndWlkID0gdGhpcy5jZWxlc3RpYWxOYW1lc1tjZWxlc3RpYWxOYW1lXTtcbiAgICAgICAgICAgIHZhciBwb3NpdGlvbiA9IHRoaXMuX2dldFBvc2l0aW9uKGd1aWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fZ2V0UG9zaXRpb24gPSBmdW5jdGlvbihndWlkKXtcbiAgICAgICAgICAgIHZhciBuID0gRGF0ZS5ub3coKTtcbiAgICAgICAgICAgIHZhciBjID0gdGhpcy5jZWxlc3RpYWxzW2d1aWRdO1xuICAgICAgICAgICAgdmFyIHQgPSBjLnRpbWVvdXQ7XG4gICAgICAgICAgICB2YXIgcG9zID0gdGhpcy5wb3NpdGlvbnNbZ3VpZF07XG4gICAgICAgICAgICBpZihuIC0gcG9zLnRpbWUgPiB0KXtcbiAgICAgICAgICAgICAgICBwb3MgPSB7dmVjdG9yOiB0aGlzLl9jYWxjdWxhdGUoZ3VpZCwgbiksXG4gICAgICAgICAgICAgICAgICAgICAgIHRpbWU6blxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbnNbZ3VpZF0gPSBwb3M7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wb3NpdGlvbnNbZ3VpZF0udmVjdG9yO1xuICAgICAgICAgICBcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2NhbGN1bGF0ZSA9IGZ1bmN0aW9uKGd1aWQsIG4pe1xuICAgICAgICAgICAgdmFyIEMgPSB0aGlzLmNlbGVzdGlhbHNbZ3VpZF07XG4gICAgICAgICAgICBpZihDLm9yYml0KXtcbiAgICAgICAgICAgICAgICB2YXIgcG9zaXRpb24gPSB0aGlzLl9wb3NpdGlvbihDLCBuKTsgLy8gWmVyby1yZWxhdGl2ZTtcbiAgICAgICAgICAgICAgICB2YXIgcGFyZW50UG9zaXRpb24gPSBfZ2V0UG9zaXRpb24oQy5DKVxuICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnRQb3NpdGlvbi5jbG9uZSgpLmFkZChwb3NpdGlvbik7XG4gICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRIUkVFLlZlY3RvcjMoKS5mcm9tQXJyYXkoIHBvc2l0aW9uICkgO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fY2FsY0UgPSBmdW5jdGlvbihlLCBNLCBhY2N1cmFjeSl7XG4gICAgICAgICAgICB2YXIgRW5ldz0xO1xuICAgICAgICAgICAgdmFyIEVvbGQ9MDtcbiAgICAgICAgICAgIHZhciBFdGVtcD0wO1xuICAgICAgICAgICAgdmFyIEU9MDtcbiAgICAgICAgICAgIHdoaWxlKE1hdGguYWJzKEVuZXctRW9sZCkgPiBhY2N1cmFjeSl7XG4gICAgICAgICAgICAgICAgRXRlbXA9RW5ldztcbiAgICAgICAgICAgICAgICBFbmV3PU0rZSpNYXRoLnNpbihFb2xkKTtcbiAgICAgICAgICAgICAgICBFb2xkPUV0ZW1wO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgRT1FbmV3O1xuICAgICAgICAgICAgcmV0dXJuIEU7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnRydWVBbm9tID0gZnVuY3Rpb24gKGVjLEUsZHApIHtcbiAgICAgICAgICAgIHZhciBTPU1hdGguc2luKEUpO1xuICAgICAgICAgICAgdmFyIEM9TWF0aC5jb3MoRSk7XG4gICAgICAgICAgICB2YXIgZmFrPU1hdGguc3FydCgxLjAtZWMqZWMpO1xuICAgICAgICAgICAgdmFyIHBoaT1NYXRoLmF0YW4yKGZhaypTLEMtZWMpIC8vICAvSztcbiAgICAgICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHBoaSpNYXRoLnBvdygxMCxkcCkpL01hdGgucG93KDEwLGRwKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX3BsYW5lQ29vcmRzID0gZnVuY3Rpb24oY2VsZXN0aWFsLCB0aW1lKXtcblxuICAgICAgICAgICAgaWYoY2VsZXN0aWFsLm9yYml0ID09IHVuZGVmaW5lZCl7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIm9yYml0IGlzIG5vdCBkZWZpbmVkIGZvclwiLCBjZWxlc3RpYWwubmFtZSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYoY2VsZXN0aWFsLm9yYml0LmlzX3ByZWRlZmluZWQpe1xuICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgc29tZSBhZGRpdGlvbmFsIHBhcmFtZXRlcnMgdG8gY2FsY3VsYXRlIG9yYml0IHBhcmFtcztcbiAgICAgICAgICAgICAgICB2YXIgcGFyZW50Q2VsZWN0aWFsID0gdGhpcy5jZWxlc3RpYWxzW2NlbGVzdGlhbC5vcmJpdC5DXTtcbiAgICAgICAgICAgICAgICB2YXIgbWluX2hlaWdodCA9IHBhcmVudENlbGVjdGlhbC5SICogMC4wNTsgLy8gJTUgb2YgcGxhbmV0IHJhZGl1cyAtIG1pbmltdW0gaGVpZ2h0IG9mIG9yYml0O1xuICAgICAgICAgICAgICAgIHZhciBoZWlnaHRfc3RlcCA9IHBhcmVudENlbGVjdGlhbC5SICogMC4wMTsgLy8gaGVpZ2h0IHN0ZXAgaXMgMSUgb2YgcGxhbmV0IFJcbiAgICAgICAgICAgICAgICB2YXIgbiA9IFByZWRlZmluZWRPcmJpdGFsUGxhbmVzW2NlbGVzdGlhbC5vcmJpdC5uXTtcbiAgICAgICAgICAgICAgICB2YXIgZSA9IDE7XG4gICAgICAgICAgICAgICAgdmFyIGEgPSBtaW5faGVpZ2h0ICsgY2VsZXN0aWFsLm9yYml0LmEgKiBoZWlnaHRfc3RlcDtcbiAgICAgICAgICAgICAgICB2YXIgbXUgPSBHICogcGFyZW50Q2VsZWN0aWFsLk07XG4gICAgICAgICAgICAgICAgdmFyIFQgPSAyICogTWF0aC5QSSAqIE1hdGguc3FydCggYSphKmEgLyBtdSApXG4gICAgICAgICAgICAgICAgdmFyIFAgPSAwO1xuICAgICAgICAgICAgICAgIHZhciBwaCAgPSBjZWxlc3RpYWwub3JiaXQudDAgKiBULzU7ICBcbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIHZhciBwaCA9IGNlbGVzdGlhbC5vcmJpdC50MCA7IC8vICsgdGltZSBvZiBsYXN0IHNpZ2h0U2VlaW5nXG4gICAgICAgICAgICAgICAgdmFyIGUgPSBjZWxlc3RpYWwub3JiaXQuZTtcbiAgICAgICAgICAgICAgICBpZihlID09IHVuZGVmaW5lZCApeyBlID0gMS4wOyB9XG4gICAgICAgICAgICAgICAgdmFyIGEgPSBjZWxlc3RpYWwub3JiaXQuYTtcbiAgICAgICAgICAgICAgICB2YXIgVCA9IGNlbGVzdGlhbC5vcmJpdC5UIDtcbiAgICAgICAgICAgICAgICB2YXIgUCA9Y2VsZXN0aWFsLm9yYml0LlA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgcHRpbWUgPSB0aW1lICsgcGg7XG4gICAgICAgICAgICB2YXIgTSA9IHB0aW1lICogTWF0aC5QSSAvIChULzIpIDtcbiAgICAgICAgICAgIHZhciBFID0gdGhpcy5fY2FsY0UoZSwgTSwgMC4wMDAwMDAxKSA7XG4gICAgICAgICAgICB2YXIgcGhpID0gdGhpcy50cnVlQW5vbShlLCBFLCA3KSA7XG4gICAgICAgICAgICB2YXIgUiAgID0gYSooMS1lKmUpLygxK2UqTWF0aC5jb3MocGhpKSk7XG4gICAgICAgICAgICBwaGkgKz0gUDtcbiAgICAgICAgICAgIHZhciBwb3MgPSBuZXcgVEhSLlZlY3RvcjMoUiAqIE1hdGguY29zKHBoaSksIFIqIE1hdGguc2luKHBoaSksIDApO1xuICAgICAgICAgICAgcmV0dXJuIHBvcztcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX3Bvc2l0aW9uID0gZnVuY3Rpb24oY2VsZXN0aWFsLCB0aW1lKXtcbiAgICAgICAgICAgIGlmKGNlbGVzdGlhbC5vcmJpdCA9PSB1bmRlZmluZWQpe1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJvcmJpdCBpcyBub3QgZGVmaW5lZCBmb3JcIiwgY2VsZXN0aWFsLm5hbWUpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBtID0gdGhpcy5fZ2V0Um90YXRpb25NYXRyaXgoY2VsZXN0aWFsLm9yYml0Lm4pO1xuICAgICAgICAgICAgdmFyIHEgPSBuZXcgVEhSLlF1YXRlcm5pb24oKTtcbiAgICAgICAgICAgIHEuc2V0RnJvbVJvdGF0aW9uTWF0cml4KG0pO1xuICAgICAgICAgICAgdmFyIHBvcyA9IHRoaXMuX3BsYW5lQ29vcmRzKGNlbGVzdGlhbCwgdGltZSk7XG4gICAgICAgICAgICBwb3MuYXBwbHlRdWF0ZXJuaW9uKHEpO1xuICAgICAgICAgICAgcmV0dXJuIHBvcztcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2dldFJvdGF0aW9uTWF0cml4ID0gZnVuY3Rpb24obm9ybWFsKXtcbiAgICAgICAgICAgIC8vIHJvdGF0aW9uIHJlbGF0aXZlIHRvIHogYXhpcztcbiAgICAgICAgICAgIHZhciBuID0gbmV3IFRIUi5WZWN0b3IzKCkuZnJvbUFycmF5KG5vcm1hbCk7XG4gICAgICAgICAgICBuLm5vcm1hbGl6ZSgpO1xuICAgICAgICAgICAgdmFyIFogPSBuZXcgVEhSLlZlY3RvcjMoMCwwLC0xKTtcbiAgICAgICAgICAgIHZhciBheGlzID0gWi5jbG9uZSgpLmNyb3NzKG4uY2xvbmUoKSApIDtcbiAgICAgICAgICAgIGF4aXMubm9ybWFsaXplKCk7XG4gICAgICAgICAgICB2YXIgYW5nbCA9IE1hdGguYWNvcyhaLmRvdChuKSk7XG4gICAgICAgICAgICB2YXIgbSA9IG5ldyBUSFIuTWF0cml4NCgpO1xuICAgICAgICAgICAgbS5tYWtlUm90YXRpb25BeGlzKGF4aXMsIGFuZ2wpO1xuICAgICAgICAgICAgcmV0dXJuIG07XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHZhciBjY2MgPSBudWxsO1xuXG4gICAgcmV0dXJuIGZ1bmN0aW9uKCl7XG4gICAgICAgIGlmKGNjYyA9PSBudWxsKXtcbiAgICAgICAgICAgIGNjYyA9IG5ldyBDZWxlc3RpYWxDYWxjdWxhdG9yKCk7XG4gICAgICAgIH1cbiAgICB9XG5cblxuXG59KSgpXG4iLCJ2YXIgQ3VzdG9tVXBkYXRlckdldHRlciA9IChmdW5jdGlvbiAoKXtcbiAgICBcbiAgICB2YXIgY3VzdG9tVXBkYXRlckNhY2hlID0gbnVsbDtcblxuICAgIHZhciBDdXN0b21VcGRhdGVyID0gZnVuY3Rpb24oKXtcbiAgICAgICAgdGhpcy51cGRhdGVyTGlzdCA9IHt9O1xuICAgICAgICB0aGlzLmFkZCA9IGZ1bmN0aW9uKCBuYW1lLCB1cGRhdGVyICl7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZXJMaXN0W25hbWVdID0gdXBkYXRlcjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJlbW92ZSA9IGZ1bmN0aW9uKG5hbWUpe1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMudXBkYXRlckxpc3RbbmFtZV1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLnVwZGF0ZSA9IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICBfLmVhY2godGhpcy51cGRhdGVyTGlzdCwgZnVuY3Rpb24oZnVuYywgbmFtZSl7XG4gICAgICAgICAgICAgICAgZnVuYygpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgdXBkYXRlckdldHRlciA9IGZ1bmN0aW9uKCl7XG4gICAgICAgIGlmKGN1c3RvbVVwZGF0ZXJDYWNoZSA9PSBudWxsKXtcbiAgICAgICAgICAgIGN1c3RvbVVwZGF0ZXJDYWNoZSA9IG5ldyBDdXN0b21VcGRhdGVyKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGN1c3RvbVVwZGF0ZXJDYWNoZTtcbiAgICB9XG4gICAgcmV0dXJuIHVwZGF0ZXJHZXR0ZXI7XG59KSgpXG4iLCJ3aW5kb3cuR2FtZUNvbnRleHRMb2FkZXIgPSBmdW5jdGlvbihzb2NrZXRTZXJ2aWNlKXtcblxuICAgIHZhciBzY2VuZVByb21pc2VzICA9IFtdO1xuICAgIHZhciBjZWxlc3RpYWxQcm9taXNlcyA9IFtdO1xuXG4gICAgdmFyIHNjZW5lc19pbl9wcm9jZXNzID0gW107XG5cbiAgICB2YXIgY29udGV4dEFjdG9ycyA9IFtdO1xuICAgIHZhciByZXR1cm5EZWZlciA9IFEuZGVmZXIoKTtcblxuICAgIHNvY2tldFNlcnZpY2UucmVxdWVzdChcIkNUWFwiLCB7dXNlcl9pZDp0cnVlfSlcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24oY29udGV4dCl7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkNPTlRFWFRcIiwgY29udGV4dCk7XG4gICAgICAgICAgICBfLmVhY2goY29udGV4dC5jb250ZXh0cywgZnVuY3Rpb24oc2NlbmVfZGVzYywgYWN0b3JfZ3VpZCl7XG4gICAgICAgICAgICAgICAgdmFyIG9iamVjdFByb21pc2VzID0gW107XG4gICAgICAgICAgICAgICAgY29udGV4dEFjdG9ycy5wdXNoKGFjdG9yX2d1aWQpO1xuICAgICAgICAgICAgICAgIHZhciBzY2VuZV9ndWlkID0gc2NlbmVfZGVzYy5HVUlEO1xuICAgICAgICAgICAgICAgIHZhciBzY2VuZURlZiA9IFEuZGVmZXIoKTtcbiAgICAgICAgICAgICAgICBpZihzY2VuZXNfaW5fcHJvY2Vzcy5pbmRleE9mKCBzY2VuZV9ndWlkICApICE9PSAtMSl7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9ZWxzZXtcblxuICAgICAgICAgICAgICAgICAgICBzY2VuZXNfaW5fcHJvY2Vzcy5wdXNoKHNjZW5lX2d1aWQpO1xuICAgICAgICAgICAgICAgICAgICBzY2VuZVByb21pc2VzLnB1c2goc2NlbmVEZWYucHJvbWlzZSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIG9iamVjdHMgPSBzY2VuZV9kZXNjLm9iamVjdHM7XG4gICAgICAgICAgICAgICAgdmFyIHNjZW5lX2FjdG9ycyA9IHNjZW5lX2Rlc2MuYWN0b3JzO1xuICAgICAgICAgICAgICAgIGlmKHNjZW5lX2Rlc2MubG9jYXRpb24uZy5vcmJpdCl7XG4gICAgICAgICAgICAgICAgICAgIGNlbGVzdGlhbFByb21pc2VzLnB1c2goXG4gICAgICAgICAgICAgICAgICAgICAgICBzb2NrZXRTZXJ2aWNlLmdldChcImNlbGVjdGlhbC1yZWN1cnNpdmVcIiwge0dVSUQ6IHNjZW5lX2Rlc2MubG9jYXRpb24uZy5vcmJpdC5DfSlcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXy5lYWNoKG9iamVjdHMsIGZ1bmN0aW9uKG9ndWlkKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwID0gc29ja2V0U2VydmljZS5nZXQoXCJBXCIsIHtpZDogb2d1aWR9KVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKG9iaikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzb2NrZXRTZXJ2aWNlLmdldChcIlRcIiwge3R5cGU6IG9iai5zdWJfdHlwZX0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICh0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouc3ViX3R5cGUgPSB0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9iajtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBvYmplY3RQcm9taXNlcy5wdXNoKHApO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIFEuYWxsKGNlbGVzdGlhbFByb21pc2VzKS5zcHJlYWQoZnVuY3Rpb24oIGNlbGVzdGlhbHMgKXtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJMb2FkZWQgY2VsZXRlc3RpYWxzXCIsIGNlbGVzdGlhbHMgKTtcbiAgICAgICAgICAgICAgICB9KVxuXG5cbiAgICAgICAgICAgICAgICBRLmFsbChvYmplY3RQcm9taXNlcykudGhlbihmdW5jdGlvbihvYmplY3RzKXtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJJSVwiLCBvYmplY3RzKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRocmVlU2NlbmUgPSAgbmV3IFRIUkVFLlNjZW5lKCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzY2VuZSA9IG5ldyBTY2VuZSh0aHJlZVNjZW5lLCBzZWxmKTtcbiAgICAgICAgICAgICAgICAgICAgc2NlbmUuR1VJRCA9IHNjZW5lX2d1aWQ7XG4gICAgICAgICAgICAgICAgICAgIHNjZW5lLm9uTG9hZENhbGxiYWNrID0gZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjZW5lRGVmLnJlc29sdmUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjZW5lOnNjZW5lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocmVlU2NlbmU6IHRocmVlU2NlbmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0b3JzOiBzY2VuZV9kZXNjLmFjdG9yc1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIF8uZWFjaChzY2VuZV9hY3RvcnMsIGZ1bmN0aW9uKGFjdCl7XG4gICAgICAgICAgICAgICAgICAgICAgICBzY2VuZS5qb2luX2FjdG9yKGFjdCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIF8uZWFjaChvYmplY3RzLCBmdW5jdGlvbihvYmope1xuICAgICAgICAgICAgICAgICAgICAgICAgc2NlbmUuam9pbl9vYmplY3Qob2JqLCBvYmouR1VJRCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGUpe1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmKCBzY2VuZVByb21pc2VzLmxlbmd0aCA9PSAwKXtcbiAgICAgICAgICAgICAgICByZXR1cm5EZWZlci5yZWplY3QoXCJObyBzY2VuZXMgdG8gbG9hZFwiKTtcbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIFEuYWxsKCBzY2VuZVByb21pc2VzKS50aGVuKGZ1bmN0aW9uKHNjZW5lcyl7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybkRlZmVyLnJlc29sdmUoe3NjZW5lczpzY2VuZXMsIGN1cnJlbnRVc2VyQWN0b3JzOiBjb250ZXh0QWN0b3JzfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGUpe1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICAgICAgfSk7XG5cblxuXG5cbiAgICByZXR1cm4gcmV0dXJuRGVmZXIucHJvbWlzZTtcblxufVxuIiwidmFyIEtleU1hcHBlciA9IGZ1bmN0aW9uKCB2aWV3UG9ydHMpe1xuICAgIHRoaXMudmlld1BvcnRzID0gdmlld1BvcnRzXG4gICAgXy5lYWNoKHRoaXMudmlld1BvcnRzLCBmdW5jdGlvbih2cCl7XG4gICAgICAgIGlmKHZwLmRvRHJhd1VJKCkpe1xuICAgICAgICAgICAgdnAudmlldy5hY3RvcnNcbiAgICAgICAgfVxuICAgIH0pXG5cbiAgICBcblxufVxuIiwidmFyIElucHV0U2VydmljZUdldHRlciA9IChmdW5jdGlvbigpe1xuICAgIHZhciBJbnB1dFNlcnZpY2UgPSBmdW5jdGlvbiggKXtcbiAgICAgICAgdmFyIG1vdXNlU3RhdGUgPSB7eDowLCB5OjB9O1xuICAgICAgICB0aGlzLm1vdXNlU3RhdGUgPSBtb3VzZVN0YXRlO1xuICAgICAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICdtb3VzZW1vdmUnLCBmdW5jdGlvbihlKXtcbiAgICAgICAgICAgIG1vdXNlU3RhdGUueCA9IGUueDtcbiAgICAgICAgICAgIG1vdXNlU3RhdGUueSA9IGUueTtcbiAgICAgICAgfSwgZmFsc2UgKTtcbiAgICAgICAgUmVuZGVyZXJHZXR0ZXIoKS5kb21FbGVtZW50KCkuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGZ1bmN0aW9uKGUpe1xuICAgICAgICAgICAgdGhhdC5pbnB1dCggJ2xtb3VzZScsIGZhbHNlKVxuICAgICAgICAgICAgXG4gICAgICAgIH0pO1xuICAgICAgICBSZW5kZXJlckdldHRlcigpLmRvbUVsZW1lbnQoKS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBmdW5jdGlvbihlKXtcbiAgICAgICAgICAgIHRoYXQuaW5wdXQoICdsbW91c2UnLCB0cnVlKVxuICAgICAgICB9KTtcbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGZ1bmN0aW9uKGUpe1xuICAgICAgICAgICAgdmFyIGNvZGUgPSBlLmtleUNvZGU7XG4gICAgICAgICAgICB0aGF0LmlucHV0KCBjb2RlLCB0cnVlKVxuICAgICAgICB9LCBmYWxzZSk7XG4gICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgZnVuY3Rpb24oZSl7XG4gICAgICAgICAgICB2YXIgY29kZSA9IGUua2V5Q29kZTtcbiAgICAgICAgICAgIHRoYXQuaW5wdXQoY29kZSwgZmFsc2UpXG4gICAgICAgIH0sIGZhbHNlKTtcbiAgICAgICAgdGhpcy5rZXlDb2RlcyA9IHt9O1xuICAgICAgICB0aGlzLmtleU1hcCA9IG51bGw7XG4gICAgICAgIHRoaXMuc2V0S2V5TWFwID0gZnVuY3Rpb24oa2V5TWFwKXtcbiAgICAgICAgICAgIHRoaXMua2V5TWFwID0ga2V5TWFwO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudmlld3BvcnRTZXJ2aWNlID0gVmlld3BvcnRTZXJ2aWNlR2V0dGVyKClcblxuICAgICAgICB0aGlzLmdldE1vdXNlUHJvamVjdGlvbkFycmF5ID0gZnVuY3Rpb24oKXtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnZpZXdwb3J0U2VydmljZS5wcm9qZWN0KHRoaXMubW91c2VTdGF0ZSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy52aWV3cG9ydHMgPSBudWxsO1xuICAgICAgICB0aGlzLnNldEFjdGl2ZVNjZW5lID0gZnVuY3Rpb24oc2NlbmUpe1xuICAgICAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lO1xuXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5pbnB1dCA9IGZ1bmN0aW9uKGtleWNvZGUsIHVwX29yX2Rvd24pe1xuICAgICAgICAgICAgdmFyIHRzID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICBpZih1cF9vcl9kb3duKSB7Ly8gZG93biA9PSB0cnVlXG4gICAgICAgICAgICAgICAgdGhpcy5rZXlDb2Rlc1trZXljb2RlXSA9IHtpbl9hY3Rpb246dHJ1ZSwgdHM6dHN9O1xuICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgaWYodGhpcy5rZXlDb2Rlc1trZXljb2RlXSl7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcy5rZXlDb2Rlc1trZXljb2RlXS50cztcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5rZXlDb2Rlc1trZXljb2RlXS5pbl9hY3Rpb24gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5rZXlDb2Rlc1trZXljb2RlXS50cyA9IHRzO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmtleUNvZGVzW2tleWNvZGVdLmRlbHRhID0gdHMgLSB0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB2YXIgc3luY3Jvbml6ZXIgPSBTeW5jaHJvbml6ZXJHZXR0ZXIoKTtcbiAgICAgICAgdGhpcy5nZXRMYXRlc3RBY3Rpb25zID0gZnVuY3Rpb24oIHNjZW5lR3VpZCwgbm93ICl7XG4gICAgICAgICAgICBpZiggdGhpcy5zY2VuZS5zY2VuZUd1aWQgIT0gc2NlbmVHdWlkKXtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmluZm8oXCJ3cm9uZyBzY2VuZSBmb3IgaW5wdXRcIik7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFtdIDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmKHRoaXMua2V5TWFwID09IG51bGwpeyBcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oXCJubyBrZXltYXBcIik7XG4gICAgICAgICAgICAgICAgcmV0dXJuOyBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gW107XG4gICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgICAgICAgICBfLmVhY2godGhpcy5rZXlDb2RlcywgZnVuY3Rpb24oa19hY3Rpb24sIGtleWNvZGUpe1xuICAgICAgICAgICAgICAgIGlmKGtfYWN0aW9uLmluX2FjdGlvbil7XG4gICAgICAgICAgICAgICAgICAgIHZhciBkZWx0YSA9IG5vdyAtIGtfYWN0aW9uLnRzO1xuICAgICAgICAgICAgICAgICAgICB2YXIgdHMgPSBub3c7XG4gICAgICAgICAgICAgICAgICAgIGtfYWN0aW9uLnRzID0gbm93O1xuICAgICAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgICAgICB2YXIgZGVsdGEgPSBrX2FjdGlvbi5kZWx0YTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRzID0ga19hY3Rpb24udHM7XG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmtleUNvZGVzW2tleWNvZGVdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgYWN0aW9uID0gXy5jbG9uZShzZWxmLmFjdGlvbnNba2V5Y29kZV0pO1xuICAgICAgICAgICAgICAgIGlmKGtleWNvZGUgaW4gdGhhdC5rZXlNYXApe1xuICAgICAgICAgICAgICAgICAgICB2YXIgYWN0X2Rlc2MgID0gdGhhdC5rZXlNYXBba2V5Y29kZV07XG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXdfYWN0aW9uID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWVzaCA6IGFjdF9kZXNjLm1lc2gsXG4gICAgICAgICAgICAgICAgICAgICAgICBkZXYgOiBhY3RfZGVzYy5kZXZpY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBhY3RfZGVzYy5uYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHMgOnRzLFxuICAgICAgICAgICAgICAgICAgICAgICAgaWRlbnQ6IHRzICsgc3luY2hyb25pemVyLmdldEN1cnJlbnRUaW1lRGlmZigpICsgc3luY2hyb25pemVyLmdldEF2ZXJhZ2VMYXRlbmNpdHkoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhOiBkZWx0YS8xMDAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgd21vdXNlOiB0aGF0LmdldE1vdXNlUHJvamVjdGlvbkFycmF5KClcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBhY3Rpb25zLnB1c2gobmV3X2FjdGlvbik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gYWN0aW9ucztcbiAgICAgICAgfVxuICAgIH07XG4gICAgdmFyIElucHV0U2VydmljZUNhY2hlID0gbnVsbDtcbiAgICB2YXIgZ2V0dGVyID0gZnVuY3Rpb24oKXtcbiAgICAgICAgaWYoSW5wdXRTZXJ2aWNlQ2FjaGUgPT0gbnVsbCl7XG4gICAgICAgICAgICBJbnB1dFNlcnZpY2VDYWNoZSA9IG5ldyBJbnB1dFNlcnZpY2UoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gSW5wdXRTZXJ2aWNlQ2FjaGU7XG4gICAgfVxuICAgIHJldHVybiBnZXR0ZXI7XG59KSgpO1xuIiwiIiwid2luZG93LlJlbmRlcmVyR2V0dGVyID0gKGZ1bmN0aW9uKCl7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgdmFyIFJlbmRlcmVyID0gZnVuY3Rpb24oKXtcbiAgICAgICAgdmFyIHdpZHRoICAgPSBkb2N1bWVudC5ib2R5LmNsaWVudFdpZHRoO1xuICAgICAgICB2YXIgYm9keSA9IGRvY3VtZW50LmJvZHksXG4gICAgICAgICAgICBodG1sID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50O1xuICAgICAgICB2YXIgaGVpZ2h0ID0gTWF0aC5tYXgoIGJvZHkuc2Nyb2xsSGVpZ2h0LCBib2R5Lm9mZnNldEhlaWdodCwgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaHRtbC5jbGllbnRIZWlnaHQsIGh0bWwuc2Nyb2xsSGVpZ2h0LCBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sLm9mZnNldEhlaWdodCApO1xuXG4gICAgICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0O1xuICAgICAgICB0aGlzLndpZHRoID0gd2lkdGg7XG4gICAgICAgIGNvbnNvbGUuaW5mbygnSW5pdCByZW5kZXJlcicsIHdpZHRoLCBoZWlnaHQsIGRvY3VtZW50LmJvZHkpO1xuICAgICAgICB0aGlzLmdsUmVuZGVyZXIgPSBuZXcgVEhSRUUuV2ViR0xSZW5kZXJlcih7YW50aWFsaWFzOnRydWUsIGFscGhhOnRydWV9KTtcbiAgICAgICAgdGhpcy5nbFJlbmRlcmVyLnNldFNpemUoIHdpZHRoLCBoZWlnaHQgKTtcbiAgICAgICAgdGhpcy5nbFJlbmRlcmVyLnNldENsZWFyQ29sb3IobmV3IFRIUkVFLkNvbG9yKDB4MDAwMDAwKSk7XG4gICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5nbFJlbmRlcmVyLmRvbUVsZW1lbnQpO1xuXG4gICAgICAgIHRoaXMuZ2xSZW5kZXJlci5nYW1tYUlucHV0ID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5nbFJlbmRlcmVyLmdhbW1hT3V0cHV0ID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5nbFJlbmRlcmVyLmF1dG9DbGVhciA9IHRydWUgO1xuXG4gICAgICAgIHRoaXMuZ2xSZW5kZXJlci5waHlzaWNhbGx5QmFzZWRTaGFkaW5nID0gdHJ1ZTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXG5cbiAgICAgICAgdGhpcy5kb21FbGVtZW50ID0gZnVuY3Rpb24oKXtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdsUmVuZGVyZXIuZG9tRWxlbWVudDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucmVuZGVyID0gZnVuY3Rpb24gKCB2aWV3UG9ydCApe1xuICAgICAgICAgICAgdGhpcy5nbFJlbmRlcmVyLnNldFZpZXdwb3J0KHZpZXdQb3J0LmNvbmZpZy5sLCB2aWV3UG9ydC5jb25maWcudCwgdmlld1BvcnQuY29uZmlnLncsIHZpZXdQb3J0LmNvbmZpZy5oKVxuICAgICAgICAgICAgdGhpcy5yZW5kZXJTa3lCb3goIHZpZXdQb3J0ICk7XG4gICAgICAgICAgICB0aGlzLnJlbmRlckNlbGVzdGlhbFNjZW5lKCB2aWV3UG9ydCApO1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJTY2VuZSggdmlld1BvcnQgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucmVuZGVyU2t5Qm94ID0gZnVuY3Rpb24oIHZpZXdwb3J0ICl7XG4gICAgICAgICAgICB2YXIgbWF0cml4T2ZQbGF5ZXIgPSB2aWV3cG9ydC5jYW1lcmEucGFyZW50Lm1hdHJpeC5jbG9uZSgpO1xuICAgICAgICAgICAgdmFyIG1hdHJpeE9mQ2FtZXJhID0gdmlld3BvcnQuY2FtZXJhLm1hdHJpeC5jbG9uZSgpO1xuICAgICAgICAgICAgbWF0cml4T2ZQbGF5ZXIubXVsdGlwbHkobWF0cml4T2ZDYW1lcmEpO1xuICAgICAgICAgICAgdmFyIHJvdGF0aW9uTWF0cml4ID0gbmV3IFRIUkVFLk1hdHJpeDQoKS5leHRyYWN0Um90YXRpb24obWF0cml4T2ZQbGF5ZXIpO1xuICAgICAgICAgICAgdmFyIHEgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21Sb3RhdGlvbk1hdHJpeChyb3RhdGlvbk1hdHJpeCk7XG4gICAgICAgICAgICB2aWV3cG9ydC5za3lCb3hDYW1lcmEucm90YXRpb24uc2V0RnJvbVF1YXRlcm5pb24ocSk7XG5cblxuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBjb25zb2xlLndhcm4oXCJTa3lib3ggaXMgbm90IHJlbmRlcmVkIHlldFwiKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJlbmRlckNlbGVzdGlhbFNjZW5lID0gZnVuY3Rpb24oKXtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUud2FybihcIkNlbGVzdGlhbCBvYmplY3RzIGlzIG5vdCByZW5kZXJlZCB5ZXRcIik7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5yZW5kZXJTY2VuZSA9IGZ1bmN0aW9uKHZpZXdwb3J0KXtcbiAgICAgICAgICAgIHZhciBzY2VuZSA9IHZpZXdwb3J0LnZpZXcuc2NlbmUudGhyZWVfc2NlbmU7XG4gICAgICAgICAgICB2YXIgY2FtZXJhID0gdmlld3BvcnQuY2FtZXJhO1xuICAgICAgICAgICAgdGhpcy5nbFJlbmRlcmVyLnJlbmRlcihzY2VuZSwgY2FtZXJhKTtcbiAgICAgICAgfVxuICAgICAgICAgXG4gICAgfVxuXG4gICAgdmFyIHNjID0gbnVsbDtcbiAgICByZXR1cm4gZnVuY3Rpb24oKXtcbiAgICAgICAgaWYoc2MgPT0gbnVsbCApe1xuICAgICAgICAgICAgc2MgPSBuZXcgUmVuZGVyZXIoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc2M7XG4gICAgfVxuXG59KSgpO1xuIiwidmFyIFNldHRpbmdzID0gKGZ1bmN0aW9uKCl7XG5cbiAgICB2YXIgU2VydmljZSA9IGZ1bmN0aW9uKCl7XG4gICAgICAgIHZhciBVU0VSX1NFVFRJTkdTX0tFWSA9IFwidXNlci1zZXR0aW5nc1wiO1xuICAgICAgICB2YXIgc2V0dGluZ3MgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKFVTRVJfU0VUVElOR1NfS0VZKSk7XG4gICAgICAgIGlmKHNldHRpbmdzKXtcbiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gc2V0dGluZ3M7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgdGhpcy5jb25maWcgPSB7fTtcbiAgICAgICAgfVxuXG5cbiAgICAgICAgdGhpcy5nZXRWaWV3cG9ydEJpbmRpbmdzID0gZnVuY3Rpb24oKXtcbiAgICAgICAgICAgIGlmICghKHRoaXMuY29uZmlnWyd2aWV3UG9ydEJpbmRpbmdzJ10gKSl7XG4gICAgICAgICAgICAgICAgdGhpcy5jb25maWcudmlld1BvcnRCaW5kaW5ncyA9IHRoaXMuZGVmYXVsdFZpZXdQb3J0QmluZGluZ3M7XG4gICAgICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oVVNFUl9TRVRUSU5HU19LRVksIEpTT04uc3RyaW5naWZ5KCB0aGlzLmNvbmZpZyApKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbmZpZy52aWV3UG9ydEJpbmRpbmdzXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kZWZhdWx0Vmlld1BvcnRCaW5kaW5ncyA9IHtcbiAgICAgICAgICAgIFwic2hpcC5yb29raWVfc2hpcC5QaWxvdGluZy5mcm9udFwiIDogXCJkZWZhdWx0XCJcbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgc2MgPSBudWxsO1xuICAgIHJldHVybiBmdW5jdGlvbigpe1xuICAgICAgICBpZihzYyA9PSBudWxsKXtcbiAgICAgICAgICAgIHNjID0gbmV3IFNlcnZpY2UoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc2M7XG4gICAgfVxuXG5cbn0pKClcbiIsIlxudmFyIFNvY2tldFNlcnZpY2VHZXR0ZXIgPSAoZnVuY3Rpb24oKXtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB2YXIgU29ja2V0U2VydmljZSA9IGZ1bmN0aW9uKCl7XG4gICAgICAgIHZhciBhdXRoSGFzaEYgPSBmdW5jdGlvbihjYil7XG4gICAgICAgICAgICB2YXIgZCA9IFEuZGVmZXIoKTtcbiAgICAgICAgICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICAgICAgICAgIHhoci5vcGVuKCdHRVQnLCAnL215LWF1dGgtaGFzaC8nLCB0cnVlKTtcbiAgICAgICAgICAgIHhoci5zZW5kKCk7XG5cbiAgICAgICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBpZiAoeGhyLnJlYWR5U3RhdGUgPT0gNCkge1xuICAgICAgICAgICAgICAgICAgICBpZih4aHIuc3RhdHVzID09IDIwMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGpzID0gSlNPTi5wYXJzZSh4aHIucmVzcG9uc2VUZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNiKGpzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgIH07XG4gICAgICAgIHZhciBzb2NrZXQgPSBpby5jb25uZWN0KCk7XG4gICAgICAgIHZhciBpc19yZWFkeSA9IGZhbHNlO1xuICAgICAgICB2YXIgUXVldWUgPSBbXTtcblxuICAgICAgICB2YXIgaXNfYXV0aGVudGljYXRlZCA9IFEuZGVmZXIoKTtcbiAgICAgICAgc29ja2V0Lm9uKCdjb25uZWN0ZWQnLCBmdW5jdGlvbigpe1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcInJlY29ubmVjdGlvblwiKTtcbiAgICAgICAgICAgIGF1dGhIYXNoRihmdW5jdGlvbihqc29uKXtcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIj4+PlwiLGpzb24pO1xuICAgICAgICAgICAgICAgIHNvY2tldC5lbWl0KFwiYXV0aF9oYXNoXCIsIHthdXRoOiBqc29uLmhhc2h9KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pO1xuICAgICAgICBzb2NrZXQub24oXCJhdXRoX2NvbXBsZXRlZFwiLCBmdW5jdGlvbihtc2cpe1xuICAgICAgICAgICAgaWYobXNnLmVycil7XG4gICAgICAgICAgICAgICAgaXNfYXV0aGVudGljYXRlZC5yZWplY3QobXNnLmVycik7XG4gICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwiPj5cIik7XG4gICAgICAgICAgICAgICAgaXNfYXV0aGVudGljYXRlZC5yZXNvbHZlKHRydWUpO1xuICAgICAgICAgICAgICAgIC8vJHJvb3RTY29wZS4kYXBwbHkoZnVuY3Rpb24oKXtpc19hdXRoZW50aWNhdGVkLnJlc29sdmUodHJ1ZSl9KVxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pO1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhpc19hdXRoZW50aWNhdGVkKTtcbiAgICAgICAgaXNfYXV0aGVudGljYXRlZC5wcm9taXNlLnRoZW4oZnVuY3Rpb24ocyxlKXtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGlzX2F1dGhlbnRpY2F0ZWQsIHMsZSk7XG4gICAgICAgICAgICBpc19yZWFkeSA9IHRydWU7XG4gICAgICAgICAgICBmb3IodmFyIGkgPTA7aSA8UXVldWUubGVuZ3RoOyBpKyspe1xuICAgICAgICAgICAgICAgIHNvY2tldC5lbWl0KFF1ZXVlW2ldLlQsIFF1ZXVlW2ldLnApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB2YXIgUyA9IHt9O1xuICAgICAgICB2YXIgY2JzID0ge307XG4gICAgICAgIHZhciBpbmNvbWluZ0xpc3RlbmVycyA9IHt9O1xuICAgICAgICB2YXIgY3VyY2JpeCA9IDA7XG4gICAgICAgIGZ1bmN0aW9uIGdldENCSXgoKXtcbiAgICAgICAgICAgIGN1cmNiaXgrPTE7XG4gICAgICAgICAgICByZXR1cm4gY3VyY2JpeCAlIDEwMDAwO1xuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBSZXEgPSBmdW5jdGlvbihtdCwgdCwgcCl7XG4gICAgICAgICAgICB2YXIgZCA9IFEuZGVmZXIoKSxcbiAgICAgICAgICAgICAgICBjYml4ID0gIGdldENCSXgoKTtcbiAgICAgICAgICAgIGNic1tjYml4XSA9IHtcbiAgICAgICAgICAgICAgICBjYjogZFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHZhciBvID0ge3A6cH07XG4gICAgICAgICAgICBvLmNiaXggPSBjYml4O1xuICAgICAgICAgICAgby5UID0gdDtcbiAgICAgICAgICAgIGlmKCFpc19yZWFkeSl7XG4gICAgICAgICAgICAgICAgUXVldWUucHVzaCh7VDptdCxwOm99KTtcbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIHNvY2tldC5lbWl0KG10LCBvKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGQucHJvbWlzZTtcbiAgICAgICAgfTtcblxuICAgICAgICB2YXIgbWVzc2FnZXNfdG9faGVhciA9IFtcIlFcIiwgXCJSXCIsICdTJ107XG4gICAgICAgIF8uZWFjaChtZXNzYWdlc190b19oZWFyLCBmdW5jdGlvbihtZXNzYWdlX3R5cGUpe1xuICAgICAgICAgICAgc29ja2V0Lm9uKG1lc3NhZ2VfdHlwZSwgZnVuY3Rpb24obXNnKXtcbiAgICAgICAgICAgICAgICB2YXIgY2JpeCA9IG1zZy5jYml4O1xuICAgICAgICAgICAgICAgIGlmKGNicy5oYXNPd25Qcm9wZXJ0eShjYml4KSkge1xuICAgICAgICAgICAgICAgICAgICBjYnNbY2JpeF0uY2IucmVzb2x2ZShtc2cuZCk7XG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjYnNbY2JpeF07XG4gICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihcIk5vIHN1Y2ggY2JpeCBpbiBjYWxsYmFja3NcIiwgY2JpeCwgbWVzc2FnZV90eXBlICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcblxuICAgICAgICB9KTtcblxuICAgICAgICB2YXIgc3BlY2lhbEV2ZW50cyA9IFtcIkZcIiwgXCJBTE1cIl07XG5cbiAgICAgICAgXy5lYWNoKHNwZWNpYWxFdmVudHMsIGZ1bmN0aW9uKGV2ZW50KXtcbiAgICAgICAgICAgIHNvY2tldC5vbihldmVudCwgZnVuY3Rpb24oZGF0YSl7XG4gICAgICAgICAgICAgICAgaWYoZXZlbnQgaW4gaW5jb21pbmdMaXN0ZW5lcnMpe1xuICAgICAgICAgICAgICAgICAgICBfLmVhY2goaW5jb21pbmdMaXN0ZW5lcnNbIGV2ZW50IF0sIGZ1bmN0aW9uKGxpc3RlbmVyKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyKGV2ZW50LCBkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9KTtcbiAgICAgICAgUy5nZXQgPSBmdW5jdGlvbih0LHApe1xuICAgICAgICAgICAgcmV0dXJuIFJlcShcIlFcIiwgdCxwKVxuICAgICAgICB9O1xuICAgICAgICBTLnN5bmMgPSBmdW5jdGlvbigpe1xuICAgICAgICAgICAgcmV0dXJuIFJlcShcIlNcIiwnJyx7fSlcbiAgICAgICAgfTtcbiAgICAgICAgUy5yZXF1ZXN0ID0gZnVuY3Rpb24odCxwKXtcbiAgICAgICAgICAgIHJldHVybiBSZXEoXCJSXCIsIHQscClcbiAgICAgICAgfTtcbiAgICAgICAgUy5hY3Rpb24gPWZ1bmN0aW9uKG1lc3Mpe1xuICAgICAgICAgICAgc29ja2V0LmVtaXQoXCJBXCIsbWVzcylcbiAgICAgICAgfTtcbiAgICAgICAgUy5hZGRMaXN0ZW5lciA9IGZ1bmN0aW9uKGV2ZW50LCBmdW5jKXtcbiAgICAgICAgICAgIGlmKCEoZXZlbnQgaW4gaW5jb21pbmdMaXN0ZW5lcnMpKXtcbiAgICAgICAgICAgICAgICBpbmNvbWluZ0xpc3RlbmVyc1tldmVudF0gPSBbXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGluY29taW5nTGlzdGVuZXJzW2V2ZW50XS5wdXNoKGZ1bmMpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBTO1xuICAgIH07XG5cbiAgICB2YXIgc29ja2V0U2VydmljZUNhY2hlID0gbnVsbDtcbiAgICB2YXIgZ2V0dGVyID0gZnVuY3Rpb24oKXtcbiAgICAgICAgaWYoIHNvY2tldFNlcnZpY2VDYWNoZSA9PSBudWxsICkge1xuICAgICAgICAgICBzb2NrZXRTZXJ2aWNlQ2FjaGUgPSBTb2NrZXRTZXJ2aWNlKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNvY2tldFNlcnZpY2VDYWNoZTtcbiAgICB9XG4gICAgcmV0dXJuIGdldHRlcjtcbn0pKCk7XG4iLCJ2YXIgU3luY2hyb25pemVyR2V0dGVyID0gKGZ1bmN0aW9uKCl7XG5cbiAgICB2YXIgc3luY2hyb25pemVyQ2FjaGUgPSBudWxsO1xuXG4gICAgdmFyIFN5bmNocm9uaXplciA9IGZ1bmN0aW9uKHNvY2tldFNlcnZpY2Upe1xuICAgICAgICB2YXIgTUFYX0RJRkZfTEVOR1RIID0gMTA7XG4gICAgICAgIHZhciBEUk9QX0ZJUlNUX0RJRkZTID0gNDtcbiAgICAgICAgdmFyIFNZTkNfVElNRU9VVCA9IDEwMDA7XG4gICAgICAgICAgICBcbiAgICAgICAgdmFyIHRoYXQgPSB0aGlzO1xuXG4gICAgICAgIHRoaXMubGFzdFRpbWVzdGFtcCA9IDA7XG4gICAgICAgIHRoaXMubGF0ZW5jaXRpZXMgPSBbXVxuICAgICAgICB0aGlzLnRpbWVEaWZmcyA9IFtdO1xuICAgICAgICB0aGlzLmRpZmZDb3VudCA9IDA7XG4gICAgICAgIHRoaXMuaXNTdG9wcGVkID0gZmFsc2U7XG4gICAgICAgICBcblxuICAgICAgICB0aGlzLnNvY2tldFN5bmNDbG9zdXJlID0gZnVuY3Rpb24oc3luY0RhdGEpe1xuICAgICAgICAgICAgdmFyIGN1cnJlbnRUaW1lU3RhbXAgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgdmFyIHBpbmcgPSBjdXJyZW50VGltZVN0YW1wIC0gdGhhdC5sYXN0VGltZXN0YW1wO1xuICAgICAgICAgICAgdGhhdC5sYXRlbmNpdGllcy5wdXNoKHBpbmcgLyAyKTtcbiAgICAgICAgICAgIHRoYXQuYXZlcmFnZUxhdGVuY2l0eSA9IE1hdGguZmxvb3IodGhhdC5hdmVyYWdlKHRoYXQubGF0ZW5jaXRpZXMpICk7XG4gICAgICAgICAgICB2YXIgdGltZURpZmYgPSBzeW5jRGF0YS50cyAtIHRoYXQubGFzdFRpbWVzdGFtcDtcbiAgICAgICAgICAgIHRoYXQuZGlmZkNvdW50ICs9IDE7XG4gICAgICAgICAgICBpZihEUk9QX0ZJUlNUX0RJRkZTID4gdGhhdC5kaWZmQ291bnQpe1xuICAgICAgICAgICAgICAgIHRoYXQudGltZURpZmZzLnB1c2godGltZURpZmYpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYodGhhdC50aW1lRGlmZnMubGVuZ3RoID4gTUFYX0RJRkZfTEVOR1RIKXt0aGF0LnRpbWVEaWZmcy5zcGxpY2UoMCwxKSB9XG4gICAgICAgICAgICB0aGF0LnRpbWVEaWZmID0gdGhhdC5hdmVyYWdlKHRoYXQudGltZURpZmZzKTtcbiAgICAgICAgICAgIGlmKCEgdGhhdC5pc1N0b3BwZWQgKXtcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAgICAgICAgIHRoYXQuc3luY0xvb3AoKTtcbiAgICAgICAgICAgICAgICB9LCBTWU5DX1RJTUVPVVQpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuYXZlcmFnZSA9IGZ1bmN0aW9uKGFycmF5KXtcbiAgICAgICAgICAgIHJldHVybiBfLnJlZHVjZShhcnJheSwgZnVuY3Rpb24oYSxiKXtyZXR1cm4gYStifSwgMCkgLyBhcnJheS5sZW5ndGg7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHRoaXMuc3luY0xvb3AgPSBmdW5jdGlvbigpe1xuICAgICAgICAgICAgLy8gY29uc29sZS5pbmZvKFwic3luY1wiKTtcbiAgICAgICAgICAgIHRoaXMubGFzdFRpbWVzdGFtcCA9IERhdGUubm93KCk7XG4gICAgICAgICAgICBzb2NrZXRTZXJ2aWNlLnN5bmMoICkudGhlbiggdGhpcy5zb2NrZXRTeW5jQ2xvc3VyZSApO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB0aGlzLmdldEN1cnJlbnRUaW1lRGlmZiA9IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy50aW1lRGlmZjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmdldEF2ZXJhZ2VMYXRlbmNpdHkgPSBmdW5jdGlvbigpe1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXZlcmFnZUxhdGVuY2l0eTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5zdGFydCA9IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICBpZiAodGhpcy5pc1N0b3BwZWQpe1xuICAgICAgICAgICAgICAgIHRoaXMuaXNTdG9wcGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdGhpcy5zeW5jTG9vcCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIHRoaXMuc3RvcCA9IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICB0aGlzLmlzU3RvcHBlZCA9IHRydWU7XG4gICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIGdldHRlciA9IGZ1bmN0aW9uKCl7XG4gICAgICAgIGlmKHN5bmNocm9uaXplckNhY2hlID09IG51bGwpe1xuICAgICAgICAgICAgc3luY2hyb25pemVyQ2FjaGUgPSBuZXcgU3luY2hyb25pemVyKCBTb2NrZXRTZXJ2aWNlR2V0dGVyKCkgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBzeW5jaHJvbml6ZXJDYWNoZTtcbiAgICB9XG4gICAgcmV0dXJuIGdldHRlcjtcblxufSkoKVxuIiwid2luZG93LlZpZXcgPSBmdW5jdGlvbihzY2VuZSwgdmlld05hbWUsIGNvbnRyb2xsYWJsZU9iamVjdCwgY29udHJvbGxhYmVsTWVzaCl7XG4gICAgdGhpcy5hY3RvcnMgPSB7fTtcbiAgICB0aGlzLlVJUyA9IFtdO1xuICAgIHRoaXMuc2NlbmU9IHNjZW5lO1xuICAgIHRoaXMudmlld05hbWUgPSB2aWV3TmFtZTtcbiAgICB0aGlzLm9iamVjdCA9IGNvbnRyb2xsYWJsZU9iamVjdDtcbiAgICB0aGlzLm1lc2ggPSBjb250cm9sbGFiZWxNZXNoO1xuXG4gICAgdGhpcy5za3lib3hTY2VuZSA9IG5ldyBUSFJFRS5TY2VuZSgpO1xuICAgIHRoaXMuY2VsZXN0aWFsU2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTtcblxuXG4gICAgdGhpcy5iaW5kID0gZnVuY3Rpb24odnApe1xuICAgICAgICB0aGlzLnZpZXdwb3J0ID0gdnA7XG4gICAgfVxuICAgIHRoaXMudW5iaW5kVmlld3BvcnQgPSBmdW5jdGlvbigpe1xuICAgICAgICB0aGlzLm1lc2gucmVtb3ZlKHRoaXMudmlld3BvcnQuY2FtZXJhKVxuICAgICAgICB0aGlzLnZpZXdwb3J0ID0gdW5kZWZpbmVkO1xuICAgIH1cblxuXG4gICAgdGhpcy5hZGRBY3RvciA9IGZ1bmN0aW9uKCBhY3RvciApe1xuICAgICAgICB0aGlzLmFjdG9yc1thY3Rvci5HVUlEXSA9IGFjdG9yO1xuXG4gICAgfTtcbiAgICB0aGlzLmFkZFVJID0gZnVuY3Rpb24oIHVpICl7XG4gICAgICAgIHRoaXMuVUlTLnB1c2goIHVpICk7XG4gICAgfVxuXG5cbn1cbiIsInZhciBWaWV3Q29sbGVjdGlvbiA9IGZ1bmN0aW9uKCl7XG4gICAgdGhpcy52aWV3cz17fSxcbiAgICB0aGlzLnZpZXdPcmRlcj0gW10sXG4gICAgdGhpcy5pZGVudGl0eU1hcCA9IHt9LFxuICAgIHRoaXMuYnlHbG9iYWxOYW1lID17fSxcbiAgICB0aGlzLmFkZD0gZnVuY3Rpb24oaWRlbnRpdHksIGdsb2JhbE5hbWUgLHZpZXcsIGFjdG9yLCBVSSl7XG4gICAgICAgIGlmKCEoaWRlbnRpdHkgIGluIHRoaXMudmlld3MpKXtcbiAgICAgICAgICAgIHRoaXMudmlld3NbaWRlbnRpdHldID0gdmlldztcbiAgICAgICAgICAgIHRoaXMudmlld09yZGVyLnB1c2goaWRlbnRpdHkpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuYnlHbG9iYWxOYW1lW2dsb2JhbE5hbWVdID0gdmlldztcbiAgICAgICAgdGhpcy52aWV3c1tpZGVudGl0eV0uYWRkQWN0b3IoIGFjdG9yICk7XG4gICAgICAgIHRoaXMudmlld3NbaWRlbnRpdHldLmFkZFVJKCBVSSApO1xuICAgIH0sXG4gICAgdGhpcy5nZXQ9IGZ1bmN0aW9uKGlkKXtcbiAgICAgICAgcmV0dXJuIHRoaXMudmlld3NbaWRdO1xuXG4gICAgfSxcbiAgICB0aGlzLmdldEJ5R2xvYmFsTmFtZSA9IGZ1bmN0aW9uKG5hbWUpe1xuICAgICAgICByZXR1cm4gdGhpcy5ieUdsb2JhbE5hbWVbbmFtZV07XG4gICAgfSxcbiAgICB0aGlzLmdldEl4ID1mdW5jdGlvbihpeCl7XG4gICAgICAgIHZhciBuID0gdGhpcy52aWV3T3JkZXJbaXhdO1xuICAgICAgICByZXR1cm4gdGhpcy5nZXQobik7XG4gICAgfVxuXG59XG4iLCJ3aW5kb3cuVmlld3BvcnQgPSBmdW5jdGlvbiggY29uZmlnICl7XG5cbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICB0aGlzLm5hbWUgPSBjb25maWcubmFtZTtcbiAgICB0aGlzLmtleU1hcCA9IHt9O1xuICAgIHRoaXMuYWN0aW9ucyA9IHt9O1xuXG5cbiAgICB0aGlzLmRvRHJhd1VJID0gZnVuY3Rpb24oKXtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29uZmlnLmRyYXdVSTtcbiAgICB9O1xuXG4gICAgdGhpcy5tYWtlQ2FtZXJhID0gZnVuY3Rpb24oKXtcbiAgICAgICAgdmFyIGNhbWVyYUJhc2VWZWN0b3IgPSBuZXcgVEhSRUUuVmVjdG9yMygwLDAsLTEpO1xuICAgICAgICBjb25zb2xlLmxvZyhcIm1ha2luZyBjYW1lcmFcIiAsIHRoaXMuY29uZmlnKTtcbiAgICAgICAgdmFyIGNhbWVyYSA9IG5ldyBUSFJFRS5QZXJzcGVjdGl2ZUNhbWVyYSg0NSwgdGhpcy5jb25maWcudyAvIHRoaXMuY29uZmlnLmgsIDEsIDEwMDApO1xuICAgICAgICB2YXIgYXhpcyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7XG4gICAgICAgIHZhciB2cFJvdGF0aW9uID0gdGhpcy52aWV3Lm9iamVjdC5jYW1lcmFzW3RoaXMudmlldy52aWV3TmFtZV0uZGlyZWN0aW9uO1xuICAgICAgICB2YXIgdnBQb3NpdGlvbiA9IHRoaXMudmlldy5vYmplY3QuY2FtZXJhc1t0aGlzLnZpZXcudmlld05hbWVdLnBvc2l0aW9uO1xuXG4gICAgICAgIGF4aXMuY3Jvc3NWZWN0b3JzKGNhbWVyYUJhc2VWZWN0b3IsIG5ldyBUSFJFRS5WZWN0b3IzKCkuZnJvbUFycmF5KHZwUm90YXRpb24pICk7XG4gICAgICAgIHZhciByb3RBbmdsZSA9IE1hdGguYWNvcyhjYW1lcmFCYXNlVmVjdG9yLmRvdChuZXcgVEhSRUUuVmVjdG9yMygpLmZyb21BcnJheSggdnBSb3RhdGlvbikgKSApO1xuICAgICAgICBjYW1lcmEucG9zaXRpb24uZnJvbUFycmF5KHZwUG9zaXRpb24pO1xuXG5cbiAgICAgICAgY2FtZXJhLnJvdGF0ZU9uQXhpcyhheGlzLCByb3RBbmdsZSk7XG4gICAgICAgIHRoaXMuY2FtZXJhID0gY2FtZXJhO1xuICAgICAgICB0aGlzLnNreUJveENhbWVyYSAgICA9IG5ldyBUSFJFRS5QZXJzcGVjdGl2ZUNhbWVyYSg0NSwgdGhpcy5jb25maWcudyAvIHRoaXMuY29uZmlnLmgsIDEsIDEwMDApIFxuICAgICAgICB0aGlzLmNlbGVzdGlhbENhbWVyYSA9IG5ldyBUSFJFRS5QZXJzcGVjdGl2ZUNhbWVyYSg0NSwgdGhpcy5jb25maWcudyAvIHRoaXMuY29uZmlnLmgsIDEsIDEwMDApIFxuICAgICAgICB0aGlzLnZpZXcubWVzaC5hZGQoY2FtZXJhKTtcbiAgICB9XG5cbiAgICB0aGlzLmJpbmQgPSBmdW5jdGlvbiggdmlldyApe1xuICAgICAgICBjb25zb2xlLmluZm8oXCJCSU5EXCIsIHRoaXMudmlldyk7XG4gICAgICAgIGlmKHRoaXMudmlldyl7XG4gICAgICAgICAgICB0aGlzLnZpZXcudW5iaW5kVmlld3BvcnQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMudmlldyA9IHZpZXc7XG4gICAgICAgIHZhciB0aGF0ID0gdGhpcztcbiAgICAgICAgXy5lYWNoKHZpZXcuYWN0b3JzLCBmdW5jdGlvbihhKXtcbiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gdmlldy5zY2VuZS5nZXRBY3Rpb25zKClbYS5jb250cm9sLm9iamVjdF9ndWlkXTtcbiAgICAgICAgICAgIF8uZWFjaChhY3Rpb25zLCBmdW5jdGlvbihhY3Rpb24pe1xuICAgICAgICAgICAgICAgIGlmKGFjdGlvbi5kZWZhdWx0X2tleSl7XG4gICAgICAgICAgICAgICAgICAgIHRoYXQua2V5TWFwW2FjdGlvbi5kZWZhdWx0X2tleV0gPSBhY3Rpb247XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoYXQuYWN0aW9uc1thY3Rpb24ubmFtZV0gPSAgYWN0aW9uO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMubWFrZUNhbWVyYSgpO1xuICAgICAgICB0aGlzLnZpZXcuYmluZCh0aGlzKTtcbiAgICB9XG5cbiAgICB0aGlzLnVucHJvamVjdENvb3JkcyA9IGZ1bmN0aW9uKHgsIHkpe1xuICAgICAgICB2YXIgdnBHZW9tZXRyeSA9IHRoaXMuY29uZmlnO1xuICAgICAgICB2YXIgdnBYID0geCAtIHZwR2VvbWV0cnkubDtcbiAgICAgICAgdmFyIHZwWSA9IHkgLSB2cEdlb21ldHJ5LnQ7XG4gICAgICAgIHZhciBYID0gKHZwWCAvIHZwR2VvbWV0cnkudyAqMikgLTE7XG4gICAgICAgIHZhciBZID0gKHZwWSAvIHZwR2VvbWV0cnkuaCAqMikgKzE7XG4gICAgICAgIHZhciByZXN1bHQgPSBuZXcgVEhSRUUuVmVjdG9yMyhYLCBZLCAwLjk5IClcbiAgICAgICAgdGhpcy5wcm9qZWN0b3IudW5wcm9qZWN0VmVjdG9yKHJlc3VsdCwgdGhpcy5jYW1lcmEpO1xuICAgICAgICByZXR1cm4gcmVzdWx0LmNsb25lKCk7XG4gICAgfVxufVxuIiwidmFyIFZpZXdwb3J0U2VydmljZUdldHRlciA9IChmdW5jdGlvbigpe1xuXG4gICAgdmFyIFNlcnZpY2UgPSBmdW5jdGlvbigpe1xuICAgICAgICB0aGlzLnZpZXdwb3J0cyA9IHt9O1xuICAgICAgICB0aGlzLnJlbmRlcmVyID0gUmVuZGVyZXJHZXR0ZXIoKTtcblxuICAgICAgICB0aGlzLnJlYWRDb25maWcgPSBmdW5jdGlvbigpe1xuICAgICAgICAgICAgdmFyIHczNCA9IHRoaXMucmVuZGVyZXIud2lkdGgvNCAqIDM7XG4gICAgICAgICAgICB2YXIgdzQgID0gdGhpcy5yZW5kZXJlci53aWR0aC80O1xuICAgICAgICAgICAgdmFyIGgzICA9IHRoaXMucmVuZGVyZXIuaGVpZ2h0LzI7XG5cbiAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBsOjAsIHQ6MCwgXG4gICAgICAgICAgICAgICAgICAgIHc6dGhpcy5yZW5kZXJlci53aWR0aCwgaDp0aGlzLnJlbmRlcmVyLmhlaWdodCwgXG4gICAgICAgICAgICAgICAgICAgIGRyYXdVSTogdHJ1ZSwgbmFtZTpcImRlZmF1bHRcIlxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge2w6dzM0LCB0OmgzKjIsIHc6dzQsIGg6aDMsIG5hbWU6XCJ0b3BsZWZ0XCJ9LFxuICAgICAgICAgICAgICAgIHtsOnczNCwgdDpoMywgdzp3NCwgaDpoMywgbmFtZTpcImNlbnRlcmxlZnRcIn0sXG4gICAgICAgICAgICAgICAge2w6dzM0LCB0OjAsIHc6dzQsIGg6aDMsIG5hbWU6XCJib3R0b21sZWZ0XCJ9XG4gICAgICAgICAgICBdO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0dXAgPSBmdW5jdGlvbigpe1xuICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgICAgICAgICAgXy5lYWNoKHRoaXMucmVhZENvbmZpZygpLCBmdW5jdGlvbihjb25maWcpe1xuICAgICAgICAgICAgICAgIHZhciB2aWV3cG9ydCA9IG5ldyBWaWV3cG9ydChjb25maWcpO1xuICAgICAgICAgICAgICAgIHRoYXQudmlld3BvcnRzW2NvbmZpZy5uYW1lXSA9IHZpZXdwb3J0O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5wcm9qZWN0ID0gZnVuY3Rpb24oIG1vdXNlU3RhdGUgKXtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihcIm1vdXNlIHByb2plY3Rpb24gb3ZlciB2aWV3cG9ydHMgaXMgbm90IGltcGxlbWVudGVkXCIpO1xuICAgICAgICB9XG5cbiAgICBcbiAgICAgICAgdGhpcy5nZXRWaWV3cG9ydHM9IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy52aWV3cG9ydHM7IFxuICAgICAgICB9XG4gICAgICAgIHRoaXMuYmluZFZpZXdzID0gZnVuY3Rpb24oIHZpZXdzQ29sbGVjdGlvbiApe1xuICAgICAgICAgICAgdmFyIGJpbmRDb25maWcgPSBTZXR0aW5ncygpLmdldFZpZXdwb3J0QmluZGluZ3MoKTtcbiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcztcbiAgICAgICAgICAgIF8uZWFjaChiaW5kQ29uZmlnLCBmdW5jdGlvbih2aWV3cG9ydE5hbWUsIGJpbmRTdHJpbmcgKXtcbiAgICAgICAgICAgICAgICB2YXIgdnAgPSB0aGF0LnZpZXdwb3J0c1t2aWV3cG9ydE5hbWVdO1xuICAgICAgICAgICAgICAgIHZhciB2ICA9IHZpZXdzQ29sbGVjdGlvbi5nZXRCeUdsb2JhbE5hbWUoYmluZFN0cmluZyk7XG4gICAgICAgICAgICAgICAgdnAuYmluZCggdiApO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC8vIElucHV0U2VydmljZUdldHRlcigpLnNldFZpZXdwb3J0cyggdGhpcy5nZXRWaWV3cG9ydHMoKSk7XG4gICAgICAgICAgICBJbnB1dFNlcnZpY2VHZXR0ZXIoKVxuICAgICAgICAgICAgLnNldEFjdGl2ZVNjZW5lKCB0aGlzLnZpZXdwb3J0c1tcImRlZmF1bHRcIl0udmlldy5zY2VuZSk7XG5cblxuICAgICAgICB9XG4gICAgfVxuXG4gICAgdmFyIHNjID0gbnVsbDtcbiAgICByZXR1cm4gZnVuY3Rpb24oKXtcbiAgICAgICAgaWYoc2MgPT0gbnVsbCl7XG4gICAgICAgICAgICBzYyA9IG5ldyBTZXJ2aWNlKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNjO1xuICAgIH1cbiAgIFxuXG59KSgpXG4iLCJ3aW5kb3cuV29ybGQgPSBmdW5jdGlvbihhdXRoX2hhc2gsIHVzZXJfaWQpe1xuICAgIHRoaXMuYXV0aF9oYXNoID0gYXV0aF9oYXNoO1xuICAgIHRoaXMudXNlcl9pZCA9IHVzZXJfaWQ7XG5cbiAgICB0aGlzLmlzU3RvcHBlZCA9IGZhbHNlOyBcblxuXG4gICAgdGhpcy5pbml0UmVuZGVyZXIoKTtcbiAgICB0aGlzLmluaXRDdXN0b21VcGRhdGVyKCk7XG4gICAgdGhpcy5zZXR1cFZpZXdwb3J0cygpO1xuXG4gICAgdmFyIGNoZWNrQ29udGV4dCA9IGZ1bmN0aW9uKCl7XG4gICAgICAgIHZhciB0aGF0ID0gdGhpcztcblxuICAgICAgICB0aGlzLnN0YXJ0U2NlbmVMb2FkaW5nKClcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24oKXtcbiAgICAgICAgICAgIGNvbnNvbGUuaW5mbyhcIkdvIGxvYWRpbmdcIik7XG4gICAgICAgICAgICB0aGF0LmluaXRWaWV3cygpO1xuICAgICAgICAgICAgY29uc29sZS5pbmZvKFwiVmlld3MgaW5pdGVkXCIpO1xuICAgICAgICAgICAgdGhhdC5pbml0U3luY2luZygpO1xuICAgICAgICAgICAgY29uc29sZS5pbmZvKFwiU3luY2luZyBpbml0ZWRcIik7XG4gICAgICAgICAgICB0aGF0LnNldHVwTmV0d29ya0xpc3RlbmVycygpO1xuICAgICAgICAgICAgY29uc29sZS5pbmZvKFwibmV0d29yayBsaXN0ZW5lcnMgc2V0IHVwXCIpO1xuICAgICAgICB9KVxuICAgICAgICAudGhlbihmdW5jdGlvbigpe1xuICAgICAgICAgICAgY29uc29sZS5pbmZvKFwiR28gc2ltdWxhdGlvblwiKTtcbiAgICAgICAgICAgIHRoYXQuc3RhcnRTaW11bGF0aW9uKCk7XG4gICAgICAgIH0pXG4gICAgICAgIC5mYWlsKGZ1bmN0aW9uKHJlYXNvbil7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oIHJlYXNvbiApO1xuICAgICAgICAgICAgc2V0VGltZW91dCggY2hlY2tDb250ZXh0LCAzMDAwICk7XG4gICAgICAgICAgICB0aGF0LmNsZWFyKCk7XG4gICAgICAgICAgICBkZWxldGUgdGhhdDtcblxuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZSl7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpO1xuICAgICAgICAgICAgdGhhdC5jbGVhcigpO1xuICAgICAgICB9KS5kb25lKCk7XG4gICAgfTtcblxuICAgIGNoZWNrQ29udGV4dCA9IGNoZWNrQ29udGV4dC5iaW5kKHRoaXMpO1xuICAgIGNoZWNrQ29udGV4dCgpO1xuXG59O1xuXG53aW5kb3cuV29ybGQucHJvdG90eXBlID0gXy5leHRlbmQod2luZG93LldvcmxkLnByb3RvdHlwZSwge1xuICAgIFxuICAgIGNsZWFyOiBmdW5jdGlvbigpe1xuICAgICAgICBpZiAodGhpcy5zY2VuZXMpe1xuICAgICAgICAgICAgY29uc29sZS5pbmZvKCdjbGVhcmluZyBzY2VuZXMnKTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgaW4gdGhpcy5zY2VuZXMpe1xuICAgICAgICAgICAgICAgIHRoaXMuc2NlbmVzW2ldLmNsZWFyKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5zY2VuZXNbaV09IG51bGw7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuc2NlbmVzW2ldO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgIH1cblxuICAgICAgICBpZighICh0aGlzLnN5bmNocm9uaXplcikpe1xuICAgICAgICAgICAgdGhpcy5zeW5jaHJvbml6ZXIgPSBTeW5jaHJvbml6ZXJHZXR0ZXIoKTtcblxuICAgICAgICB9XG4gICAgICAgIHRoaXMuc3luY2hyb25pemVyLnN0b3AoKTtcblxuICAgIH0sXG4gICAgaW5pdFJlbmRlcmVyIDogZnVuY3Rpb24oKXtcbiAgICAgICAgdGhpcy5yZW5kZXJlciA9IG5ldyBSZW5kZXJlckdldHRlcigpO1xuICAgIH0sXG4gICAgc2V0dXBWaWV3cG9ydHMgOiBmdW5jdGlvbigpe1xuICAgICAgICB0aGlzLnZpZXdwb3J0U2VydmljZSA9IFZpZXdwb3J0U2VydmljZUdldHRlcigpO1xuICAgICAgICB0aGlzLnZpZXdwb3J0U2VydmljZS5zZXR1cCgpO1xuXG4gICAgfSxcblxuICAgIHN0YXJ0U2NlbmVMb2FkaW5nIDogZnVuY3Rpb24oKXtcbiAgICAgICAgdmFyIHNjZW5lUHJvbWlzZSA9IEdhbWVDb250ZXh0TG9hZGVyICggU29ja2V0U2VydmljZUdldHRlcigpIClcbiAgICAgICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgICAgICB0aGF0LnNjZW5lcyA9IHt9O1xuICAgICAgICB0aGF0LmFjdG9ycyA9IHt9O1xuICAgICAgICB0aGF0LmFjdG9yU2NlbmUgPSB7fTtcbiAgICAgICAgcmV0dXJuIHNjZW5lUHJvbWlzZS50aGVuKGZ1bmN0aW9uKGNvbnRleHQpe1xuICAgICAgICAgICAgXy5lYWNoKGNvbnRleHQuc2NlbmVzLCBmdW5jdGlvbihzY2VuZURlc2NyaXB0aW9uKXtcbiAgICAgICAgICAgICAgICB0aGF0LnNjZW5lc1tzY2VuZURlc2NyaXB0aW9uLnNjZW5lLkdVSURdID0gc2NlbmVEZXNjcmlwdGlvbi5zY2VuZTtcbiAgICAgICAgICAgICAgICBfLmVhY2goc2NlbmVEZXNjcmlwdGlvbi5hY3RvcnMsIGZ1bmN0aW9uKGFjdG9yKXtcbiAgICAgICAgICAgICAgICAgICAgaWYoY29udGV4dC5jdXJyZW50VXNlckFjdG9ycy5pbmRleE9mKGFjdG9yLkdVSUQpICE9PSAtMSl7IC8vIGFjdG9yLkdVSUQgaW4gY29udGV4dC5jdXJyZW50VXNlckFjdG9yc1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5hY3RvcnNbYWN0b3IuR1VJRF0gPSBhY3RvcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuYWN0b3JTY2VuZVthY3Rvci5HVUlEXSA9IHNjZW5lRGVzY3JpcHRpb24uc2NlbmU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgIH0sXG5cbiAgICBpbml0Vmlld3M6IGZ1bmN0aW9uKCl7XG4gICAgICAgIHZhciB0aGF0ID0gdGhpcztcbiAgICAgICAgdmFyIHZpZXdDb2xsZWN0aW9uID0gbmV3IFZpZXdDb2xsZWN0aW9uKCk7XG4gICAgICAgIF8uZWFjaCh0aGlzLmFjdG9ycywgZnVuY3Rpb24oYWN0b3Ipe1xuICAgICAgICAgICAgdmFyIHNjZW5lID0gdGhhdC5hY3RvclNjZW5lW2FjdG9yLkdVSURdO1xuICAgICAgICAgICAgdmFyIHZpZXdzID0gc2NlbmVcbiAgICAgICAgICAgICAgICAuZ2V0X29iamVjdChhY3Rvci5jb250cm9sLm9iamVjdF9ndWlkKVxuICAgICAgICAgICAgICAgIC53b3JrcG9pbnRzW2FjdG9yLmNvbnRyb2wud29ya3BvaW50XS52aWV3cztcbiAgICAgICAgICAgIHZhciBvYmplY3QgPSBzY2VuZS5nZXRfb2JqZWN0KGFjdG9yLmNvbnRyb2wub2JqZWN0X2d1aWQpXG4gICAgICAgICAgICB2YXIgbWVzaCA9IHNjZW5lLm1lc2hlc1thY3Rvci5jb250cm9sLm9iamVjdF9ndWlkXTtcbiAgICAgICAgICAgIHZhciB1aXMgPSBtZXNoLmdldFVJRm9yV1AoYWN0b3IuY29udHJvbC53b3JrcG9pbnQpO1xuICAgICAgICAgICAgXy5lYWNoKHZpZXdzLCBmdW5jdGlvbih2aWV3TmFtZSl7XG4gICAgICAgICAgICAgICAgdmFyIHZpZXdHbG9iYWxOYW1lID0gW29iamVjdC50eXBlLCBvYmplY3Quc3ViX3R5cGUsIGFjdG9yLmNvbnRyb2wud29ya3BvaW50LCB2aWV3TmFtZV0uam9pbignLicpO1xuICAgICAgICAgICAgICAgIHZhciB2aWV3SWRlbnRpdHkgPSBzY2VuZS5HVUlEICsgYWN0b3IuY29udHJvbC5vYmplY3RfZ3VpZCArIHZpZXdOYW1lO1xuICAgICAgICAgICAgICAgIHZhciB2aWV3ID0gbmV3IFZpZXcoc2NlbmUsIHZpZXdOYW1lLCBvYmplY3QsIG1lc2ggKTtcbiAgICAgICAgICAgICAgICB2aWV3Q29sbGVjdGlvbi5hZGQodmlld0lkZW50aXR5LCB2aWV3R2xvYmFsTmFtZSwgdmlldywgYWN0b3IsIHVpcyApO1xuXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZXdDb2xsZWN0aW9uID0gdmlld0NvbGxlY3Rpb247XG4gICAgICAgIHRoaXMudmlld3BvcnRTZXJ2aWNlLmJpbmRWaWV3cyh0aGlzLnZpZXdDb2xsZWN0aW9uKTtcblxuICAgIH0sXG5cbiAgICBpbml0U3luY2luZzogZnVuY3Rpb24oKXtcblxuICAgICAgICBjb25zb2xlLmluZm8oXCJTeW5jcm9uaXplciBpbml0ZWRcIik7XG5cbiAgICAgICAgdGhpcy5zeW5jaHJvbml6ZXIgPSBTeW5jaHJvbml6ZXJHZXR0ZXIoKTtcbiAgICAgICAgdGhpcy5zeW5jaHJvbml6ZXIuc3RhcnQoKTtcbiAgICB9LFxuXG4gICAgc2V0dXBOZXR3b3JrTGlzdGVuZXJzOiBmdW5jdGlvbigpe1xuXG4gICAgICAgIHZhciBzb2NrZXRTZXJ2aWNlID0gU29ja2V0U2VydmljZUdldHRlcigpO1xuICAgICAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgICAgIHNvY2tldFNlcnZpY2UuYWRkTGlzdGVuZXIoXCJGXCIsIGZ1bmN0aW9uKCBkYXRhICl7XG4gICAgICAgICAgICBpZihkYXRhLnNjZW5lIGluIHRoYXQuc2NlbmVzKXtcbiAgICAgICAgICAgICAgICB0aGF0LnNjZW5lc1tkYXRhLnNjZW5lXVxuICAgICAgICAgICAgICAgICAgICAuYWRkTmV0d29ya01lc3NhZ2UoZGF0YS5hKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pO1xuICAgICAgICBzb2NrZXRTZXJ2aWNlLmFkZExpc3RlbmVyKFwiQUxNXCIsIGZ1bmN0aW9uKCBkYXRhICl7XG4gICAgICAgICAgICBpZihkYXRhLnNjZW5lIGluIHRoYXQuc2NlbmVzKXtcbiAgICAgICAgICAgICAgICB0aGF0LnNjZW5lc1tkYXRhLnNjZW5lXS5zeW5jKGRhdGEuYWxtYW5hY2gpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIGluaXRDdXN0b21VcGRhdGVyIDogZnVuY3Rpb24oKXtcbiAgICBcbiAgICAgICAgdGhpcy5jdXN0b21VcGRhdGVycyA9IEN1c3RvbVVwZGF0ZXJHZXR0ZXIoKTtcbiAgICB9LFxuICAgIG1ha2VTY2VuZVRpY2tzIDogZnVuY3Rpb24oKXtcbiAgICAgICAgXy5lYWNoKHRoaXMuc2NlbmVzLCBmdW5jdGlvbiggc2NlbmUsIGd1aWQgKXtcbiAgICAgICAgICAgIHNjZW5lLnRpY2soKTtcbiAgICAgICAgfSlcbiAgICB9LFxuICAgIGFuaW1hdGU6IGZ1bmN0aW9uKCl7XG4gICAgICAgIHRoaXMubWFrZVNjZW5lVGlja3MoKTtcbiAgICAgICAgdGhpcy5jdXN0b21VcGRhdGVycy51cGRhdGUoKTtcbiAgICAgICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgICAgICBfLmVhY2godGhpcy52aWV3cG9ydFNlcnZpY2UuZ2V0Vmlld3BvcnRzKCksIGZ1bmN0aW9uKHZpZXdQb3J0KXtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiYW5pbWF0ZVwiKTtcbiAgICAgICAgICAgIGlmKHZpZXdQb3J0LnZpZXcpe1xuICAgICAgICAgICAgICAgIHRoYXQucmVuZGVyZXIucmVuZGVyKHZpZXdQb3J0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICAgaWYoIXRoaXMuaXNTdG9wcGVkKXtcbiAgICAgICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLmFuaW1hdGUuYmluZCh0aGlzKSApO1xuXG4gICAgICAgIH1cbiAgICAgICAgICAgIFxuXG4gICAgfSxcbiAgICBzdGFydFNpbXVsYXRpb246IGZ1bmN0aW9uKCl7XG4gICAgICAgIGlmKHRoaXMuaXNTdG9wcGVkKXtcbiAgICAgICAgICAgIHRoaXMuaXNTdG9wcGVkID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMuYW5pbWF0ZS5iaW5kKHRoaXMpKTtcbiAgICB9LFxuICAgIHN0b3BBbmltYXRpb24gOiBmdW5jdGlvbigpe1xuICAgICAgICB0aGlzLmlzU3RvcHBlZCA9IHRydWU7XG4gICAgfVxufSk7XG4iLCIoZnVuY3Rpb24gKCl7XG4gICAgdmFyIFN0YXRpY0xvZ2dlciA9IGZ1bmN0aW9uKCl7XG4gICAgICAgIHRoaXMuX3ZhbHMgPSB7fVxuICAgICAgICB0aGlzLnNldFZhbHVlID0gZnVuY3Rpb24ocGFyYW0sIHZhbCl7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhwYXJhbSwgdmFsKTtcbiAgICAgICAgICAgIHRoaXMuX3ZhbHNbcGFyYW1dID0gdmFsO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuaW5pdCA9IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICB0aGlzLmNvbnQgPSAkKFwiPGRpdj5cIikuY3NzKHtcbiAgICAgICAgICAgICAgICAncG9zaXRpb24nOidmaXhlZCcsXG4gICAgICAgICAgICAgICAgJ3RvcCc6MCxcbiAgICAgICAgICAgICAgICAncmlnaHQnOjAsXG4gICAgICAgICAgICAgICAgJ3dpZHRoJzo0MDAsXG4gICAgICAgICAgICAgICAgJ2JvdHRvbSc6MCxcbiAgICAgICAgICAgICAgICAnYmFja2dyb3VuZC1jb2xvcic6XCJyZ2JhKDAsMjAwLDEwMCwwLjcpXCJcbiAgICAgICAgICAgIH0pLmFwcGVuZFRvKCdib2R5Jyk7XG4gICAgICAgICAgICAvLyBcdGNvbnNvbGUubG9nKHRoaXMuY29udCk7XG5cbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJlZHJhdyA9IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICB0aGlzLmNvbnQuZmluZCgnKicpLnJlbW92ZSgpO1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyh0aGlzLl92YWxzKTtcbiAgICAgICAgICAgIGZvcih2YXIgaSBpbiB0aGlzLl92YWxzKXtcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdhc2RhJyk7XG4gICAgICAgICAgICAgICAgYyA9ICQoJzxkaXY+JykuYXBwZW5kVG8odGhpcy5jb250KVxuICAgICAgICAgICAgICAgIGwgPSAkKCc8c3Bhbj4nKS5odG1sKGkgKyBcIiZuYnNwOzogJm5ic3A7XCIpLmNzcygnZm9udC13ZWlnaHQnLCdib2xkJykuYXBwZW5kVG8oYyk7XG4gICAgICAgICAgICAgICAgdiA9ICQoJzxzcGFuPicpLnRleHQoIHRoaXMuX3ZhbHNbaV0gKS5hcHBlbmRUbyhjKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XG4gICAgd2luZG93LlNMID0gbmV3IFN0YXRpY0xvZ2dlcigpO1xuXG59KSgpO1xuXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=