window.GameContextLoader=function(e){var n=[],o=[],t=[],c=[],r=Q.defer();return e.request("CTX",{user_id:!0}).then(function(s){console.log("CONTEXT",s),_.each(s.contexts,function(r,s){var i=[];c.push(s);var a=r.GUID,u=Q.defer();if(-1===t.indexOf(a)){t.push(a),n.push(u.promise);var l=r.objects,h=r.actors;r.location.g.orbit&&o.push(e.get("celectial-recursive",{GUID:r.location.g.orbit.C})),_.each(l,function(n){var o=e.get("A",{id:n}).then(function(n){return e.get("T",{type:n.ship_type}).then(function(e){return n.ship_type=e,n})});i.push(o)}),Q.all(i).then(function(e){console.log("II",e);var n=new THREE.Scene,o=new Scene(n,self);o.GUID=a,o.onLoadCallback=function(){u.resolve({scene:o,threeScene:n,actors:r.actors})},_.each(h,function(e){o.join_actor(e)}),_.each(e,function(e){o.join_object(e,e.GUID)})}).catch(function(e){console.error(e)})}}),0==n.length?r.reject("No scenes to load"):Q.all(n).then(function(e){r.resolve({scenes:e,currentUserActors:c})})}).catch(function(e){console.error(e)}),r.promise};
window.KeyStateManager=function(e,t){if(void 0==e)return void console.error(" Keymap not given");if(void 0==syncronizer)return void console.error("Syncing is not set up");var n={x:0,y:0};this.mouseState=n;var i=this;document.addEventListener("mousemove",function(e){n.x=e.x,n.y=e.y},!1),this.renderer.domElement.addEventListener("mouseup",function(){i.input("lmouse",!1)}),this.renderer.domElement.addEventListener("mousedown",function(){i.input("lmouse",!0)}),document.addEventListener("keydown",function(e){var t=e.keyCode;i.input(t,!0)},!1),document.addEventListener("keyup",function(e){var t=e.keyCode;i.input(t,!1)},!1),this.keyCodes={},this.input=function(e,t){var n=(new Date).getTime();if(t)this.keyCodes[e]={in_action:!0,ts:n};else if(this.keyCodes[e]){var i=this.keyCodes[e].ts;this.keyCodes[e].in_action=!1,this.keyCodes[e].ts=n,this.keyCodes[e].delta=n-i}},this.getLatestActions=function(n){var i=[],s=this;return _.each(this.keyCodes,function(o,d){if(o.in_action){var r=n-o.ts,a=n;o.ts=n}else{var r=o.delta,a=o.ts;delete this.keyCodes[d]}_.clone(self.actions[d]);if(d in e){var u=e[d],c={mesh:u.mesh,dev:u.device,name:u.name,ts:a,ident:a+t._time_diff+t.avg_latencity,delta:r/1e3,wmouse:s.getMouseProjectionArray()};i.push(c)}}),i}};
window.NetworkManager=function(){this._callbacks={},this.on=function(t,c){t in this._callbacks?this._callbacks[t].push(c):this._callbacks[t]=[c]},this.socketListener=function(t,c){var i=this._callbacks[t];_.each(i,function(t){t(c)})},this.socketService=SocketServiceGetter(this.socketListener.bind(this))};
window.Renderer=function(){console.error("Renderer is not defined")};
window.SocketServiceGetter=function(e){"use strict";if(void 0==window._socketServiceCache){var n=function(){function n(){return f+=1,f%1e4}var t=function(e){var n=(Q.defer(),new XMLHttpRequest);n.open("GET","/my-auth-hash/",!0),n.send(),n.onreadystatechange=function(){if(4==n.readyState&&200==n.status){var t=JSON.parse(n.responseText);e(t)}}},r=io.connect(),o=!1,c=[],i=Q.defer();r.on("connected",function(){t(function(e){r.emit("auth_hash",{auth:e.hash})})}),r.on("auth_completed",function(e){e.err?i.reject(e.err):i.resolve(!0)}),i.promise.then(function(){o=!0;for(var e=0;e<c.length;e++)r.emit(c[e].T,c[e].p)});var u={},a={},f=0,s=function(e,t,i){var u=Q.defer(),f=n();a[f]={cb:u};var s={p:i};return s.cbix=f,s.T=t,o?r.emit(e,s):c.push({T:e,p:s}),u.promise},h=["Q","R","S"];return _.each(h,function(e){r.on(e,function(e){var n=e.cbix;a.hasOwnProperty(n)&&(a[n].cb.resolve(e.d),delete a[n])})}),r.on("F",function(n){e("F",n)}),r.on("ALM",function(n){e("ALM",n)}),u.get=function(e,n){return s("Q",e,n)},u.sync=function(){return s("S","",{})},u.request=function(e,n){return s("R",e,n)},u.action=function(e){r.emit("A",e)},u};window._socketServiceCache=new n}return window._socketServiceCache};
window.View=function(i,t){this.actors={},this.UIS=[],this.sceneGUID=i,this.viewName=t,this.addActor=function(i){this.actors[i.GUID]=i},this.addUI=function(i){this.UIS.push(i)}};
window.Viewport=function(i){this.config=i,this.doDrawUI=function(){return this.config.drawUI},this.bind=function(i){this.view=i}};
window.World=function(e,t){this.auth_hash=e,this.user_id=t,this.initRenderer(),this.setupViewports(),this.initNetworking();var i=function(){var e=this;this.startSceneLoading().then(function(){console.info("Go loading"),e.initViews(),e.collectActions(),e.initSyncing(),e.initKeymapping(e.getKeyBinding(),e.getSynchronizer())}).then(function(){console.info("Go simulation"),this.startSimulation()}).fail(function(t){console.warn(t),setTimeout(i,3e3),e.clear(),delete e}).catch(function(t){console.error(t),e.clear()}).done()};(i=i.bind(this))()},window.World.prototype=_.extend(window.World.prototype,{clear:function(){if(this.scenes){console.info("clearing scenes");for(var e in this.scenes)this.scenes[e].clear(),this.scenes[e]=null}},initRenderer:function(){this.renderer=new Renderer},setupViewports:function(){var e=this.renderer.width/4*3,t=this.renderer.width/4,i=this.renderer.height/2,n=[{l:0,t:0,w:this.renderer.width,h:this.renderer.height,drawUI:!0},{l:e,t:2*i,w:t,h:i},{l:e,t:i,w:t,h:i},{l:e,t:0,w:t,h:i}],o=[];_.each(n,function(e){o.push(new Viewport(e))}),this.viewPorts=o},initKeymapping:function(e,t){this.keyStateManager=new KeyStateManager(e,t)},initNetworking:function(){this.networkManager=new NetworkManager},startSceneLoading:function(){var e=GameContextLoader(this.networkManager.socketService),t=this;return t.scenes={},t.actors={},t.actorScene={},e.then(function(e){_.each(e.scenes,function(i){t.scenes[i.scene.GUID]=i.scene,_.each(i.actors,function(n){-1!==e.currentUserActors.indexOf(n.GUID)&&(t.actors[n.GUID]=n,t.actorScene[n.GUID]=i.scene)})})})},initViews:function(){var e=this,t={views:{},viewOrder:[],identityMap:{},add:function(e,t,i,n){e in this.views||(this.views[e]=t,this.viewOrder.push(e)),this.views[e].addActor(i),this.views[e].addUI(n)},get:function(e){return this.views[e]},getIx:function(e){var t=this.viewOrder[e];return this.get(t)}};_.each(this.actors,function(i){var n=e.actorScene[i.GUID],o=n.get_object(i.control.object_guid).workpoints[i.control.workpoint].views,r=n.meshes[i.control.object_guid],s=r.getUIForWP(i.control.workpoint);_.each(o,function(e){var o=n.GUID+i.control.object_guid+e,r=new View(n.GUID,e);t.add(o,r,i,s)})}),this.viewCollection=t,this.viewPorts[0].bind(this.viewCollection.getIx(0))},collectActions:function(){var e=this;_.each(this.viewPorts,function(t){if(t.doDrawUI()&&t.view){var i=t.view;_.each(i.actors,function(t){var i=e.actorScene[t.GUID].getActions()[t.control.object_guid];console.info("actions ",i,t)})}})}});
!function(){var t=function(){this._vals={},this.setValue=function(t,n){this._vals[t]=n},this.init=function(){this.cont=$("<div>").css({position:"fixed",top:0,right:0,width:400,bottom:0,"background-color":"rgba(0,200,100,0.7)"}).appendTo("body")},this.redraw=function(){this.cont.find("*").remove();for(var t in this._vals)c=$("<div>").appendTo(this.cont),l=$("<span>").html(t+"&nbsp;: &nbsp;").css("font-weight","bold").appendTo(c),v=$("<span>").text(this._vals[t]).appendTo(c)}};window.SL=new t}();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkdhbWVDb250ZXh0TG9hZGVyLmpzIiwiS2V5U3RhdGVNYW5hZ2VyLmpzIiwiTmV0d29ya01hbmFnZXIuanMiLCJSZW5kZXJlci5qcyIsIlNvY2tldFNlcnZpY2VHZXR0ZXIuanMiLCJWaWV3LmpzIiwiVmlld3BvcnQuanMiLCJXb3JsZC5qcyIsInN0YXRpY0xvZ2dlci5qcyJdLCJuYW1lcyI6WyJ3aW5kb3ciLCJHYW1lQ29udGV4dExvYWRlciIsInNvY2tldFNlcnZpY2UiLCJzY2VuZVByb21pc2VzIiwiY2VsZXN0aWFsUHJvbWlzZXMiLCJzY2VuZXNfaW5fcHJvY2VzcyIsImNvbnRleHRBY3RvcnMiLCJyZXR1cm5EZWZlciIsIlEiLCJkZWZlciIsInJlcXVlc3QiLCJ1c2VyX2lkIiwidGhlbiIsImNvbnRleHQiLCJjb25zb2xlIiwibG9nIiwiXyIsImVhY2giLCJjb250ZXh0cyIsInNjZW5lX2Rlc2MiLCJhY3Rvcl9ndWlkIiwib2JqZWN0UHJvbWlzZXMiLCJwdXNoIiwic2NlbmVfZ3VpZCIsIkdVSUQiLCJzY2VuZURlZiIsImluZGV4T2YiLCJwcm9taXNlIiwib2JqZWN0cyIsInNjZW5lX2FjdG9ycyIsImFjdG9ycyIsImxvY2F0aW9uIiwiZyIsIm9yYml0IiwiZ2V0IiwiQyIsIm9ndWlkIiwicCIsImlkIiwib2JqIiwidHlwZSIsInNoaXBfdHlwZSIsInQiLCJhbGwiLCJ0aHJlZVNjZW5lIiwiVEhSRUUiLCJTY2VuZSIsInNjZW5lIiwic2VsZiIsIm9uTG9hZENhbGxiYWNrIiwicmVzb2x2ZSIsImFjdCIsImpvaW5fYWN0b3IiLCJqb2luX29iamVjdCIsImNhdGNoIiwiZSIsImVycm9yIiwibGVuZ3RoIiwicmVqZWN0Iiwic2NlbmVzIiwiY3VycmVudFVzZXJBY3RvcnMiLCJLZXlTdGF0ZU1hbmFnZXIiLCJrZXlNYXAiLCJzeW5jaHJvbml6ZXIiLCJ1bmRlZmluZWQiLCJzeW5jcm9uaXplciIsIm1vdXNlU3RhdGUiLCJ4IiwieSIsInRoaXMiLCJ0aGF0IiwiZG9jdW1lbnQiLCJhZGRFdmVudExpc3RlbmVyIiwicmVuZGVyZXIiLCJkb21FbGVtZW50IiwiaW5wdXQiLCJjb2RlIiwia2V5Q29kZSIsImtleUNvZGVzIiwia2V5Y29kZSIsInVwX29yX2Rvd24iLCJ0cyIsIkRhdGUiLCJnZXRUaW1lIiwiaW5fYWN0aW9uIiwiZGVsdGEiLCJnZXRMYXRlc3RBY3Rpb25zIiwibm93IiwiYWN0aW9ucyIsImtfYWN0aW9uIiwiY2xvbmUiLCJhY3RfZGVzYyIsIm5ld19hY3Rpb24iLCJtZXNoIiwiZGV2IiwiZGV2aWNlIiwibmFtZSIsImlkZW50IiwiX3RpbWVfZGlmZiIsImF2Z19sYXRlbmNpdHkiLCJ3bW91c2UiLCJnZXRNb3VzZVByb2plY3Rpb25BcnJheSIsIk5ldHdvcmtNYW5hZ2VyIiwiX2NhbGxiYWNrcyIsIm9uIiwiZXZlbnQiLCJjYWxsYmFjayIsInNvY2tldExpc3RlbmVyIiwiZGF0YSIsImNicyIsImNiIiwiU29ja2V0U2VydmljZUdldHRlciIsImJpbmQiLCJSZW5kZXJlciIsImxpc3RlbmVyIiwiX3NvY2tldFNlcnZpY2VDYWNoZSIsIlNvY2tldFNlcnZpdmUiLCJnZXRDQkl4IiwiY3VyY2JpeCIsImF1dGhIYXNoRiIsInhociIsIlhNTEh0dHBSZXF1ZXN0Iiwib3BlbiIsInNlbmQiLCJvbnJlYWR5c3RhdGVjaGFuZ2UiLCJyZWFkeVN0YXRlIiwic3RhdHVzIiwianMiLCJKU09OIiwicGFyc2UiLCJyZXNwb25zZVRleHQiLCJzb2NrZXQiLCJpbyIsImNvbm5lY3QiLCJpc19yZWFkeSIsIlF1ZXVlIiwiaXNfYXV0aGVudGljYXRlZCIsImpzb24iLCJlbWl0IiwiYXV0aCIsImhhc2giLCJtc2ciLCJlcnIiLCJpIiwiVCIsIlMiLCJSZXEiLCJtdCIsImQiLCJjYml4IiwibyIsIm1lc3NhZ2VzX3RvX2hlYXIiLCJtZXNzYWdlX3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsInN5bmMiLCJhY3Rpb24iLCJtZXNzIiwiVmlldyIsInNjZW5lR1VJRCIsInZpZXdOYW1lIiwiVUlTIiwiYWRkQWN0b3IiLCJhY3RvciIsImFkZFVJIiwidWkiLCJWaWV3cG9ydCIsImNvbmZpZyIsImRvRHJhd1VJIiwiZHJhd1VJIiwidmlldyIsIldvcmxkIiwiYXV0aF9oYXNoIiwiaW5pdFJlbmRlcmVyIiwic2V0dXBWaWV3cG9ydHMiLCJpbml0TmV0d29ya2luZyIsImNoZWNrQ29udGV4dCIsInN0YXJ0U2NlbmVMb2FkaW5nIiwiaW5mbyIsImluaXRWaWV3cyIsImNvbGxlY3RBY3Rpb25zIiwiaW5pdFN5bmNpbmciLCJpbml0S2V5bWFwcGluZyIsImdldEtleUJpbmRpbmciLCJnZXRTeW5jaHJvbml6ZXIiLCJzdGFydFNpbXVsYXRpb24iLCJmYWlsIiwicmVhc29uIiwid2FybiIsInNldFRpbWVvdXQiLCJjbGVhciIsImRvbmUiLCJwcm90b3R5cGUiLCJleHRlbmQiLCJ3MzQiLCJ3aWR0aCIsInc0IiwiaDMiLCJoZWlnaHQiLCJ2aWV3cG9ydENvbmZpZ3MiLCJsIiwidyIsImgiLCJ2aWV3UG9ydHMiLCJrZXltYXAiLCJrZXlTdGF0ZU1hbmFnZXIiLCJuZXR3b3JrTWFuYWdlciIsInNjZW5lUHJvbWlzZSIsImFjdG9yU2NlbmUiLCJzY2VuZURlc2NyaXB0aW9uIiwidmlld0NvbGxlY3Rpb24iLCJ2aWV3cyIsInZpZXdPcmRlciIsImlkZW50aXR5TWFwIiwiYWRkIiwiaWRlbnRpdHkiLCJVSSIsImdldEl4IiwiaXgiLCJuIiwiZ2V0X29iamVjdCIsImNvbnRyb2wiLCJvYmplY3RfZ3VpZCIsIndvcmtwb2ludHMiLCJ3b3JrcG9pbnQiLCJtZXNoZXMiLCJ1aXMiLCJnZXRVSUZvcldQIiwidmlld0lkZW50aXR5IiwidnAiLCJhIiwiZ2V0QWN0aW9ucyIsIlN0YXRpY0xvZ2dlciIsIl92YWxzIiwic2V0VmFsdWUiLCJwYXJhbSIsInZhbCIsImluaXQiLCJjb250IiwiJCIsImNzcyIsInBvc2l0aW9uIiwidG9wIiwicmlnaHQiLCJib3R0b20iLCJiYWNrZ3JvdW5kLWNvbG9yIiwiYXBwZW5k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QUlYLEVBQUUsU0FBU08sU0FBU2hMLEtBQUt3SyxNQUM3QnRDLEVBQUl1QyxFQUFFLFVBQVVZLEtBQUszRyxFQUFJLGtCQUFrQmdHLElBQUksY0FBYyxRQUFRTSxTQUFTSSxHQUM5RUUsRUFBSWIsRUFBRSxVQUFVYyxLQUFNdkwsS0FBS21LLE1BQU16RixJQUFLc0csU0FBU0ksSUFJM0R6UCxRQUFPNlAsR0FBSyxHQUFJdEIiLCJmaWxlIjoiY2xpZW50Lm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIndpbmRvdy5HYW1lQ29udGV4dExvYWRlciA9IGZ1bmN0aW9uKHNvY2tldFNlcnZpY2Upe1xuXG4gICAgdmFyIHNjZW5lUHJvbWlzZXMgID0gW107XG4gICAgdmFyIGNlbGVzdGlhbFByb21pc2VzID0gW107XG5cbiAgICB2YXIgc2NlbmVzX2luX3Byb2Nlc3MgPSBbXTtcblxuICAgIHZhciBjb250ZXh0QWN0b3JzID0gW107XG4gICAgdmFyIHJldHVybkRlZmVyID0gUS5kZWZlcigpO1xuXG4gICAgc29ja2V0U2VydmljZS5yZXF1ZXN0KFwiQ1RYXCIsIHt1c2VyX2lkOnRydWV9KVxuICAgICAgICAudGhlbihmdW5jdGlvbihjb250ZXh0KXtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQ09OVEVYVFwiLCBjb250ZXh0KTtcbiAgICAgICAgICAgIF8uZWFjaChjb250ZXh0LmNvbnRleHRzLCBmdW5jdGlvbihzY2VuZV9kZXNjLCBhY3Rvcl9ndWlkKXtcbiAgICAgICAgICAgICAgICB2YXIgb2JqZWN0UHJvbWlzZXMgPSBbXTtcbiAgICAgICAgICAgICAgICBjb250ZXh0QWN0b3JzLnB1c2goYWN0b3JfZ3VpZCk7XG4gICAgICAgICAgICAgICAgdmFyIHNjZW5lX2d1aWQgPSBzY2VuZV9kZXNjLkdVSUQ7XG4gICAgICAgICAgICAgICAgdmFyIHNjZW5lRGVmID0gUS5kZWZlcigpO1xuICAgICAgICAgICAgICAgIGlmKHNjZW5lc19pbl9wcm9jZXNzLmluZGV4T2YoIHNjZW5lX2d1aWQgICkgIT09IC0xKXtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1lbHNle1xuXG4gICAgICAgICAgICAgICAgICAgIHNjZW5lc19pbl9wcm9jZXNzLnB1c2goc2NlbmVfZ3VpZCk7XG4gICAgICAgICAgICAgICAgICAgIHNjZW5lUHJvbWlzZXMucHVzaChzY2VuZURlZi5wcm9taXNlKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgb2JqZWN0cyA9IHNjZW5lX2Rlc2Mub2JqZWN0cztcbiAgICAgICAgICAgICAgICB2YXIgc2NlbmVfYWN0b3JzID0gc2NlbmVfZGVzYy5hY3RvcnM7XG4gICAgICAgICAgICAgICAgaWYoc2NlbmVfZGVzYy5sb2NhdGlvbi5nLm9yYml0KXtcbiAgICAgICAgICAgICAgICAgICAgY2VsZXN0aWFsUHJvbWlzZXMucHVzaChcbiAgICAgICAgICAgICAgICAgICAgICAgIHNvY2tldFNlcnZpY2UuZ2V0KFwiY2VsZWN0aWFsLXJlY3Vyc2l2ZVwiLCB7R1VJRDogc2NlbmVfZGVzYy5sb2NhdGlvbi5nLm9yYml0LkN9KVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBfLmVhY2gob2JqZWN0cywgZnVuY3Rpb24ob2d1aWQpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHAgPSBzb2NrZXRTZXJ2aWNlLmdldChcIkFcIiwge2lkOiBvZ3VpZH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAob2JqKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNvY2tldFNlcnZpY2UuZ2V0KFwiVFwiLCB7dHlwZTogb2JqLnNoaXBfdHlwZX0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICh0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouc2hpcF90eXBlID0gdDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvYmo7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgb2JqZWN0UHJvbWlzZXMucHVzaChwKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBRLmFsbChvYmplY3RQcm9taXNlcykudGhlbihmdW5jdGlvbihvYmplY3RzKXtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJJSVwiLCBvYmplY3RzKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRocmVlU2NlbmUgPSAgbmV3IFRIUkVFLlNjZW5lKCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzY2VuZSA9IG5ldyBTY2VuZSh0aHJlZVNjZW5lLCBzZWxmKTtcbiAgICAgICAgICAgICAgICAgICAgc2NlbmUuR1VJRCA9IHNjZW5lX2d1aWQ7XG4gICAgICAgICAgICAgICAgICAgIHNjZW5lLm9uTG9hZENhbGxiYWNrID0gZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjZW5lRGVmLnJlc29sdmUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjZW5lOnNjZW5lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocmVlU2NlbmU6IHRocmVlU2NlbmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0b3JzOiBzY2VuZV9kZXNjLmFjdG9yc1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIF8uZWFjaChzY2VuZV9hY3RvcnMsIGZ1bmN0aW9uKGFjdCl7XG4gICAgICAgICAgICAgICAgICAgICAgICBzY2VuZS5qb2luX2FjdG9yKGFjdCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIF8uZWFjaChvYmplY3RzLCBmdW5jdGlvbihvYmope1xuICAgICAgICAgICAgICAgICAgICAgICAgc2NlbmUuam9pbl9vYmplY3Qob2JqLCBvYmouR1VJRCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGUpe1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmKCBzY2VuZVByb21pc2VzLmxlbmd0aCA9PSAwKXtcbiAgICAgICAgICAgICAgICByZXR1cm5EZWZlci5yZWplY3QoXCJObyBzY2VuZXMgdG8gbG9hZFwiKTtcbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIFEuYWxsKCBzY2VuZVByb21pc2VzKS50aGVuKGZ1bmN0aW9uKHNjZW5lcyl7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybkRlZmVyLnJlc29sdmUoe3NjZW5lczpzY2VuZXMsIGN1cnJlbnRVc2VyQWN0b3JzOiBjb250ZXh0QWN0b3JzfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGUpe1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICAgICAgfSk7XG5cblxuXG5cbiAgICByZXR1cm4gcmV0dXJuRGVmZXIucHJvbWlzZTtcblxufSIsIndpbmRvdy5LZXlTdGF0ZU1hbmFnZXIgPSBmdW5jdGlvbigga2V5TWFwLCBzeW5jaHJvbml6ZXIgKXtcblxuICAgIGlmKGtleU1hcCA9PSB1bmRlZmluZWQpe1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiIEtleW1hcCBub3QgZ2l2ZW5cIik7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYoc3luY3Jvbml6ZXIgPT0gdW5kZWZpbmVkKXtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIlN5bmNpbmcgaXMgbm90IHNldCB1cFwiKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHZhciBtb3VzZVN0YXRlID0ge3g6MCwgeTowfTtcblxuICAgIHRoaXMubW91c2VTdGF0ZSA9IG1vdXNlU3RhdGU7XG5cbiAgICB2YXIgdGhhdCA9IHRoaXM7XG5cbiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAnbW91c2Vtb3ZlJywgZnVuY3Rpb24oZSl7XG4gICAgICAgIG1vdXNlU3RhdGUueCA9IGUueDtcbiAgICAgICAgbW91c2VTdGF0ZS55ID0gZS55O1xuICAgIH0sIGZhbHNlICk7XG5cblxuXG5cbiAgICB0aGlzLnJlbmRlcmVyLmRvbUVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGZ1bmN0aW9uKGUpe1xuXG4gICAgICAgIHRoYXQuaW5wdXQoICdsbW91c2UnLCBmYWxzZSlcbiAgICB9KTtcblxuICAgIHRoaXMucmVuZGVyZXIuZG9tRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBmdW5jdGlvbihlKXtcblxuICAgICAgICB0aGF0LmlucHV0KCAnbG1vdXNlJywgdHJ1ZSlcbiAgICB9KTtcblxuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBmdW5jdGlvbihlKXtcbiAgICAgICAgdmFyIGNvZGUgPSBlLmtleUNvZGU7XG4gICAgICAgIHRoYXQuaW5wdXQoIGNvZGUsIHRydWUpXG4gICAgfSwgZmFsc2UpO1xuXG4gICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5dXAnLCBmdW5jdGlvbihlKXtcbiAgICAgICAgdmFyIGNvZGUgPSBlLmtleUNvZGU7XG4gICAgICAgIHRoYXQuaW5wdXQoY29kZSwgZmFsc2UpXG4gICAgfSwgZmFsc2UpO1xuXG5cbiAgICB0aGlzLmtleUNvZGVzID0ge307XG4gICAgdGhpcy5pbnB1dCA9IGZ1bmN0aW9uKGtleWNvZGUsIHVwX29yX2Rvd24pe1xuICAgICAgICB2YXIgdHMgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcblxuXG4gICAgICAgIGlmKHVwX29yX2Rvd24pIHsvLyBkb3duID09IHRydWVcbiAgICAgICAgICAgIHRoaXMua2V5Q29kZXNba2V5Y29kZV0gPSB7aW5fYWN0aW9uOnRydWUsIHRzOnRzfTtcbiAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICBpZih0aGlzLmtleUNvZGVzW2tleWNvZGVdKXtcbiAgICAgICAgICAgICAgICAvLyDQn9C+0LvRjNC30L7QstCw0YLQtdC70Ywg0LzQvtCzINC90LDQttCw0YLRjCDQutC90L7Qv9C60YMg0LzRi9GI0Lgg0LIg0L7QtNC90L7QvCDQvNC10YHRgtC1IC0g0LAg0L7RgtC/0YPRgdGC0LjRgtGMINC90LDQtCDQtNGA0YPQs9C40LwuXG4gICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLmtleUNvZGVzW2tleWNvZGVdLnRzO1xuICAgICAgICAgICAgICAgIHRoaXMua2V5Q29kZXNba2V5Y29kZV0uaW5fYWN0aW9uID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdGhpcy5rZXlDb2Rlc1trZXljb2RlXS50cyA9IHRzO1xuICAgICAgICAgICAgICAgIHRoaXMua2V5Q29kZXNba2V5Y29kZV0uZGVsdGEgPSB0cyAtIHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5nZXRMYXRlc3RBY3Rpb25zID0gZnVuY3Rpb24oIG5vdyApe1xuXG4gICAgICAgIHZhciBhY3Rpb25zID0gW107XG4gICAgICAgIHZhciB0aGF0ID0gdGhpcztcbiAgICAgICAgXy5lYWNoKHRoaXMua2V5Q29kZXMsIGZ1bmN0aW9uKGtfYWN0aW9uLCBrZXljb2RlKXtcbiAgICAgICAgICAgIGlmKGtfYWN0aW9uLmluX2FjdGlvbil7XG4gICAgICAgICAgICAgICAgdmFyIGRlbHRhID0gbm93IC0ga19hY3Rpb24udHM7XG4gICAgICAgICAgICAgICAgdmFyIHRzID0gbm93O1xuICAgICAgICAgICAgICAgIGtfYWN0aW9uLnRzID0gbm93O1xuICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgdmFyIGRlbHRhID0ga19hY3Rpb24uZGVsdGE7XG4gICAgICAgICAgICAgICAgdmFyIHRzID0ga19hY3Rpb24udHM7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMua2V5Q29kZXNba2V5Y29kZV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgYWN0aW9uID0gXy5jbG9uZShzZWxmLmFjdGlvbnNba2V5Y29kZV0pO1xuXG4gICAgICAgICAgICBpZihrZXljb2RlIGluIGtleU1hcCl7XG4gICAgICAgICAgICAgICAgdmFyIGFjdF9kZXNjICA9IGtleU1hcFtrZXljb2RlXTtcbiAgICAgICAgICAgICAgICB2YXIgbmV3X2FjdGlvbiA9IHtcbiAgICAgICAgICAgICAgICAgICAgbWVzaCA6IGFjdF9kZXNjLm1lc2gsXG4gICAgICAgICAgICAgICAgICAgIGRldiA6IGFjdF9kZXNjLmRldmljZSxcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogYWN0X2Rlc2MubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgdHMgOnRzLFxuICAgICAgICAgICAgICAgICAgICBpZGVudDogdHMgKyBzeW5jaHJvbml6ZXIuX3RpbWVfZGlmZiArIHN5bmNocm9uaXplci5hdmdfbGF0ZW5jaXR5LFxuICAgICAgICAgICAgICAgICAgICBkZWx0YTogZGVsdGEvMTAwMCxcbiAgICAgICAgICAgICAgICAgICAgd21vdXNlOiB0aGF0LmdldE1vdXNlUHJvamVjdGlvbkFycmF5KClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYWN0aW9ucy5wdXNoKG5ld19hY3Rpb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGFjdGlvbnM7XG4gICAgfVxufTsiLCJ3aW5kb3cuTmV0d29ya01hbmFnZXIgPSBmdW5jdGlvbigpe1xuXG4gICAgdGhpcy5fY2FsbGJhY2tzID0ge31cbiAgICB0aGlzLm9uID0gZnVuY3Rpb24oZXZlbnQsIGNhbGxiYWNrKXtcbiAgICAgICAgaWYoZXZlbnQgaW4gdGhpcy5fY2FsbGJhY2tzKXtcbiAgICAgICAgICAgIHRoaXMuX2NhbGxiYWNrc1tldmVudF0ucHVzaChjYWxsYmFjayk7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgdGhpcy5fY2FsbGJhY2tzW2V2ZW50XSA9IFtjYWxsYmFja107XG4gICAgICAgIH1cblxuICAgIH07XG4gICAgdGhpcy5zb2NrZXRMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGRhdGEpe1xuICAgICAgICB2YXIgY2JzID0gdGhpcy5fY2FsbGJhY2tzW3R5cGVdO1xuICAgICAgICBfLmVhY2goY2JzLCBmdW5jdGlvbihjYil7XG4gICAgICAgICAgICBjYihkYXRhKTtcbiAgICAgICAgfSlcbiAgICB9O1xuXG4gICAgdGhpcy5zb2NrZXRTZXJ2aWNlID0gU29ja2V0U2VydmljZUdldHRlcih0aGlzLnNvY2tldExpc3RlbmVyLmJpbmQodGhpcykpO1xuXG5cbiAgICAvLyBPcmlnaW5hbCBTb2NrZXQgTGlzdGVuZXIgZm9yIHNjYWxlXG4gICAgLypcbiAgICB0aGlzLnNvY2tldExpc3RlbmVyID0gZnVuY3Rpb24odHlwZSwgZGF0YSl7XG4gICAgICAgIHN3aXRjaCh0eXBlKXtcbiAgICAgICAgICAgIGNhc2UgXCJBTE1cIjpcbiAgICAgICAgICAgICAgICBpZihzZWxmLnNjZW5lc1tkYXRhLnNjZW5lXSAhPT0gdW5kZWZpbmVkKXtcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5zY2VuZXNbZGF0YS5zY2VuZV0uc3luYyhkYXRhLmFsbWFuYWNoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiRlwiOlxuICAgICAgICAgICAgICAgIHNlbGYuc2NlbmVzW2RhdGEuc10uYWRkTmV0d29ya01lc3NhZ2UoZGF0YS5hKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICAqL1xuXG59Iiwid2luZG93LlJlbmRlcmVyID0gZnVuY3Rpb24oKXtcblxuICAgIGNvbnNvbGUuZXJyb3IoXCJSZW5kZXJlciBpcyBub3QgZGVmaW5lZFwiKTtcbn0iLCJ3aW5kb3cuU29ja2V0U2VydmljZUdldHRlciA9IGZ1bmN0aW9uKGxpc3RlbmVyKXtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICBpZih3aW5kb3cuX3NvY2tldFNlcnZpY2VDYWNoZSA9PSB1bmRlZmluZWQpe1xuICAgICAgICB2YXIgU29ja2V0U2Vydml2ZSA9IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICB2YXIgYXV0aEhhc2hGID0gZnVuY3Rpb24oY2Ipe1xuICAgICAgICAgICAgICAgIHZhciBkID0gUS5kZWZlcigpO1xuICAgICAgICAgICAgICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICAgICAgICAgICAgICB4aHIub3BlbignR0VUJywgJy9teS1hdXRoLWhhc2gvJywgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgeGhyLnNlbmQoKTtcblxuICAgICAgICAgICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHhoci5yZWFkeVN0YXRlID09IDQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHhoci5zdGF0dXMgPT0gMjAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGpzID0gSlNPTi5wYXJzZSh4aHIucmVzcG9uc2VUZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYihqcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHZhciBzb2NrZXQgPSBpby5jb25uZWN0KCk7XG4gICAgICAgICAgICB2YXIgaXNfcmVhZHkgPSBmYWxzZTtcbiAgICAgICAgICAgIHZhciBRdWV1ZSA9IFtdO1xuXG4gICAgICAgICAgICB2YXIgaXNfYXV0aGVudGljYXRlZCA9IFEuZGVmZXIoKTtcbiAgICAgICAgICAgIHNvY2tldC5vbignY29ubmVjdGVkJywgZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwicmVjb25uZWN0aW9uXCIpO1xuICAgICAgICAgICAgICAgIGF1dGhIYXNoRihmdW5jdGlvbihqc29uKXtcbiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCI+Pj5cIixqc29uKTtcbiAgICAgICAgICAgICAgICAgICAgc29ja2V0LmVtaXQoXCJhdXRoX2hhc2hcIiwge2F1dGg6IGpzb24uaGFzaH0pO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHNvY2tldC5vbihcImF1dGhfY29tcGxldGVkXCIsIGZ1bmN0aW9uKG1zZyl7XG4gICAgICAgICAgICAgICAgaWYobXNnLmVycil7XG4gICAgICAgICAgICAgICAgICAgIGlzX2F1dGhlbnRpY2F0ZWQucmVqZWN0KG1zZy5lcnIpO1xuICAgICAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwiPj5cIik7XG4gICAgICAgICAgICAgICAgICAgIGlzX2F1dGhlbnRpY2F0ZWQucmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgLy8kcm9vdFNjb3BlLiRhcHBseShmdW5jdGlvbigpe2lzX2F1dGhlbnRpY2F0ZWQucmVzb2x2ZSh0cnVlKX0pXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGlzX2F1dGhlbnRpY2F0ZWQpO1xuICAgICAgICAgICAgaXNfYXV0aGVudGljYXRlZC5wcm9taXNlLnRoZW4oZnVuY3Rpb24ocyxlKXtcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhpc19hdXRoZW50aWNhdGVkLCBzLGUpO1xuICAgICAgICAgICAgICAgIGlzX3JlYWR5ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPTA7aSA8UXVldWUubGVuZ3RoOyBpKyspe1xuICAgICAgICAgICAgICAgICAgICBzb2NrZXQuZW1pdChRdWV1ZVtpXS5ULCBRdWV1ZVtpXS5wKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdmFyIFMgPSB7fTtcbiAgICAgICAgICAgIHZhciBjYnMgPSB7fTtcbiAgICAgICAgICAgIHZhciBjdXJjYml4ID0gMDtcbiAgICAgICAgICAgIGZ1bmN0aW9uIGdldENCSXgoKXtcbiAgICAgICAgICAgICAgICBjdXJjYml4Kz0xO1xuICAgICAgICAgICAgICAgIHJldHVybiBjdXJjYml4ICUgMTAwMDA7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICB2YXIgUmVxID0gZnVuY3Rpb24obXQsIHQsIHApe1xuICAgICAgICAgICAgICAgIHZhciBkID0gUS5kZWZlcigpLFxuICAgICAgICAgICAgICAgICAgICBjYml4ID0gIGdldENCSXgoKTtcbiAgICAgICAgICAgICAgICBjYnNbY2JpeF0gPSB7XG4gICAgICAgICAgICAgICAgICAgIGNiOiBkXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB2YXIgbyA9IHtwOnB9O1xuICAgICAgICAgICAgICAgIG8uY2JpeCA9IGNiaXg7XG4gICAgICAgICAgICAgICAgby5UID0gdDtcbiAgICAgICAgICAgICAgICBpZighaXNfcmVhZHkpe1xuICAgICAgICAgICAgICAgICAgICBRdWV1ZS5wdXNoKHtUOm10LHA6b30pO1xuXG4gICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgIHNvY2tldC5lbWl0KG10LCBvKTtcblxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBkLnByb21pc2U7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICB2YXIgbWVzc2FnZXNfdG9faGVhciA9IFtcIlFcIiwgXCJSXCIsICdTJ107XG4gICAgICAgICAgICBfLmVhY2gobWVzc2FnZXNfdG9faGVhciwgZnVuY3Rpb24obWVzc2FnZV90eXBlKXtcbiAgICAgICAgICAgICAgICBzb2NrZXQub24obWVzc2FnZV90eXBlLCBmdW5jdGlvbihtc2cpe1xuICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIlI+Pj5cIiwgbXNnKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNiaXggPSBtc2cuY2JpeDtcbiAgICAgICAgICAgICAgICAgICAgaWYoY2JzLmhhc093blByb3BlcnR5KGNiaXgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYnNbY2JpeF0uY2IucmVzb2x2ZShtc2cuZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY2JzW2NiaXhdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHNvY2tldC5vbignRicsIGZ1bmN0aW9uKGRhdGEpe1xuICAgICAgICAgICAgICAgIGxpc3RlbmVyKFwiRlwiLCBkYXRhKTtcbiAgICAgICAgICAgIH0gKTtcbiAgICAgICAgICAgIHNvY2tldC5vbihcIkFMTVwiLCBmdW5jdGlvbihkYXRhKXtcbiAgICAgICAgICAgICAgICBsaXN0ZW5lcihcIkFMTVwiLCBkYXRhKTtcblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIFMuZ2V0ID0gZnVuY3Rpb24odCxwKXtcbiAgICAgICAgICAgICAgICByZXR1cm4gUmVxKFwiUVwiLCB0LHApXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgUy5zeW5jID0gZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICByZXR1cm4gUmVxKFwiU1wiLCcnLHt9KVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIFMucmVxdWVzdCA9IGZ1bmN0aW9uKHQscCl7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFJlcShcIlJcIiwgdCxwKVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIFMuYWN0aW9uID1mdW5jdGlvbihtZXNzKXtcbiAgICAgICAgICAgICAgICBzb2NrZXQuZW1pdChcIkFcIixtZXNzKVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHJldHVybiBTO1xuICAgICAgICB9O1xuICAgICAgICB3aW5kb3cuX3NvY2tldFNlcnZpY2VDYWNoZSA9IG5ldyBTb2NrZXRTZXJ2aXZlKCk7XG5cbiAgICB9XG4gICAgcmV0dXJuIHdpbmRvdy5fc29ja2V0U2VydmljZUNhY2hlO1xuXG5cblxuXG59Iiwid2luZG93LlZpZXcgPSBmdW5jdGlvbihzY2VuZUdVSUQsIHZpZXdOYW1lKXtcbiAgICB0aGlzLmFjdG9ycyA9IHt9O1xuICAgIHRoaXMuVUlTID0gW107XG4gICAgdGhpcy5zY2VuZUdVSUQgPSBzY2VuZUdVSUQ7XG4gICAgdGhpcy52aWV3TmFtZSA9IHZpZXdOYW1lO1xuXG4gICAgdGhpcy5hZGRBY3RvciA9IGZ1bmN0aW9uKCBhY3RvciApe1xuICAgICAgICB0aGlzLmFjdG9yc1thY3Rvci5HVUlEXSA9IGFjdG9yO1xuXG4gICAgfTtcbiAgICB0aGlzLmFkZFVJID0gZnVuY3Rpb24oIHVpICl7XG4gICAgICAgIHRoaXMuVUlTLnB1c2goIHVpICk7XG4gICAgfVxuXG5cbn0iLCJ3aW5kb3cuVmlld3BvcnQgPSBmdW5jdGlvbiggY29uZmlnICl7XG5cbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcblxuXG4gICAgdGhpcy5kb0RyYXdVSSA9IGZ1bmN0aW9uKCl7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbmZpZy5kcmF3VUk7XG5cbiAgICB9O1xuXG4gICAgdGhpcy5iaW5kID0gZnVuY3Rpb24oIHZpZXcgKXtcbiAgICAgICAgdGhpcy52aWV3ID0gdmlldztcblxuICAgIH1cbn0iLCJ3aW5kb3cuV29ybGQgPSBmdW5jdGlvbihhdXRoX2hhc2gsIHVzZXJfaWQpe1xuICAgIHRoaXMuYXV0aF9oYXNoID0gYXV0aF9oYXNoO1xuICAgIHRoaXMudXNlcl9pZCA9IHVzZXJfaWQ7XG5cbiAgICB0aGlzLmluaXRSZW5kZXJlcigpO1xuICAgIHRoaXMuc2V0dXBWaWV3cG9ydHMoKTtcbiAgICB0aGlzLmluaXROZXR3b3JraW5nKCk7XG5cbiAgICB2YXIgY2hlY2tDb250ZXh0ID0gZnVuY3Rpb24oKXtcbiAgICAgICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgICAgICB0aGlzLnN0YXJ0U2NlbmVMb2FkaW5nKClcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24oKXtcbiAgICAgICAgICAgIGNvbnNvbGUuaW5mbyhcIkdvIGxvYWRpbmdcIik7XG4gICAgICAgICAgICB0aGF0LmluaXRWaWV3cygpO1xuICAgICAgICAgICAgdGhhdC5jb2xsZWN0QWN0aW9ucygpO1xuICAgICAgICAgICAgdGhhdC5pbml0U3luY2luZygpO1xuICAgICAgICAgICAgdGhhdC5pbml0S2V5bWFwcGluZyh0aGF0LmdldEtleUJpbmRpbmcoKSwgdGhhdC5nZXRTeW5jaHJvbml6ZXIoKSApO1xuICAgICAgICB9KVxuICAgICAgICAudGhlbihmdW5jdGlvbigpe1xuICAgICAgICAgICAgY29uc29sZS5pbmZvKFwiR28gc2ltdWxhdGlvblwiKTtcbiAgICAgICAgICAgIHRoaXMuc3RhcnRTaW11bGF0aW9uKCk7XG4gICAgICAgIH0pXG4gICAgICAgIC5mYWlsKGZ1bmN0aW9uKHJlYXNvbil7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oIHJlYXNvbiApO1xuICAgICAgICAgICAgc2V0VGltZW91dCggY2hlY2tDb250ZXh0LCAzMDAwICk7XG4gICAgICAgICAgICB0aGF0LmNsZWFyKCk7XG4gICAgICAgICAgICBkZWxldGUgdGhhdDtcblxuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZSl7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpO1xuICAgICAgICAgICAgdGhhdC5jbGVhcigpO1xuICAgICAgICB9KS5kb25lKCk7XG4gICAgfTtcblxuICAgIGNoZWNrQ29udGV4dCA9IGNoZWNrQ29udGV4dC5iaW5kKHRoaXMpO1xuICAgIGNoZWNrQ29udGV4dCgpO1xuXG59O1xuXG53aW5kb3cuV29ybGQucHJvdG90eXBlID0gXy5leHRlbmQod2luZG93LldvcmxkLnByb3RvdHlwZSwge1xuICAgIGNsZWFyOiBmdW5jdGlvbigpe1xuICAgICAgICBpZiAodGhpcy5zY2VuZXMpe1xuICAgICAgICAgICAgY29uc29sZS5pbmZvKCdjbGVhcmluZyBzY2VuZXMnKTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgaW4gdGhpcy5zY2VuZXMpe1xuICAgICAgICAgICAgICAgIHRoaXMuc2NlbmVzW2ldLmNsZWFyKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5zY2VuZXNbaV09IG51bGw7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfVxuICAgIH0sXG4gICAgaW5pdFJlbmRlcmVyIDogZnVuY3Rpb24oKXtcbiAgICAgICAgdGhpcy5yZW5kZXJlciA9IG5ldyBSZW5kZXJlcigpO1xuICAgIH0sXG4gICAgc2V0dXBWaWV3cG9ydHMgOiBmdW5jdGlvbigpe1xuICAgICAgICB2YXIgdzM0ID0gdGhpcy5yZW5kZXJlci53aWR0aC80ICogMztcbiAgICAgICAgdmFyIHc0ICA9IHRoaXMucmVuZGVyZXIud2lkdGgvNDtcbiAgICAgICAgdmFyIGgzICA9IHRoaXMucmVuZGVyZXIuaGVpZ2h0LzI7XG5cbiAgICAgICAgdmFyIHZpZXdwb3J0Q29uZmlncyA9IFtcbiAgICAgICAgICAgIHtsOjAsIHQ6MCwgdzp0aGlzLnJlbmRlcmVyLndpZHRoLCBoOnRoaXMucmVuZGVyZXIuaGVpZ2h0LCBkcmF3VUk6IHRydWV9LFxuICAgICAgICAgICAge2w6dzM0LCB0OmgzKjIsIHc6dzQsIGg6aDN9LFxuICAgICAgICAgICAge2w6dzM0LCB0OmgzLCB3Onc0LCBoOmgzfSxcbiAgICAgICAgICAgIHtsOnczNCwgdDowLCB3Onc0LCBoOmgzfVxuICAgICAgICBdO1xuICAgICAgICB2YXIgdmlld1BvcnRzID0gW107XG4gICAgICAgIF8uZWFjaCh2aWV3cG9ydENvbmZpZ3MsIGZ1bmN0aW9uKGNvbmZpZyl7XG4gICAgICAgICAgICB2aWV3UG9ydHMucHVzaCggbmV3IFZpZXdwb3J0KGNvbmZpZykgKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMudmlld1BvcnRzID0gdmlld1BvcnRzO1xuXG4gICAgfSxcblxuICAgIGluaXRLZXltYXBwaW5nOiBmdW5jdGlvbihrZXltYXAsIHN5bmNocm9uaXplcil7XG4gICAgICAgIHRoaXMua2V5U3RhdGVNYW5hZ2VyID0gbmV3IEtleVN0YXRlTWFuYWdlcihrZXltYXAsIHN5bmNocm9uaXplcik7XG4gICAgfSxcbiAgICBpbml0TmV0d29ya2luZzogZnVuY3Rpb24oKXtcbiAgICAgICAgdGhpcy5uZXR3b3JrTWFuYWdlciA9IG5ldyBOZXR3b3JrTWFuYWdlcigpO1xuICAgIH0sXG4gICAgc3RhcnRTY2VuZUxvYWRpbmcgOiBmdW5jdGlvbigpe1xuICAgICAgICB2YXIgc2NlbmVQcm9taXNlID0gR2FtZUNvbnRleHRMb2FkZXIgKHRoaXMubmV0d29ya01hbmFnZXIuc29ja2V0U2VydmljZSk7XG4gICAgICAgIHZhciB0aGF0ID0gdGhpcztcbiAgICAgICAgdGhhdC5zY2VuZXMgPSB7fTtcbiAgICAgICAgdGhhdC5hY3RvcnMgPSB7fTtcbiAgICAgICAgdGhhdC5hY3RvclNjZW5lID0ge307XG4gICAgICAgIHJldHVybiBzY2VuZVByb21pc2UudGhlbihmdW5jdGlvbihjb250ZXh0KXtcbiAgICAgICAgICAgIF8uZWFjaChjb250ZXh0LnNjZW5lcywgZnVuY3Rpb24oc2NlbmVEZXNjcmlwdGlvbil7XG4gICAgICAgICAgICAgICAgdGhhdC5zY2VuZXNbc2NlbmVEZXNjcmlwdGlvbi5zY2VuZS5HVUlEXSA9IHNjZW5lRGVzY3JpcHRpb24uc2NlbmU7XG4gICAgICAgICAgICAgICAgXy5lYWNoKHNjZW5lRGVzY3JpcHRpb24uYWN0b3JzLCBmdW5jdGlvbihhY3Rvcil7XG4gICAgICAgICAgICAgICAgICAgIGlmKGNvbnRleHQuY3VycmVudFVzZXJBY3RvcnMuaW5kZXhPZihhY3Rvci5HVUlEKSAhPT0gLTEpeyAvLyBhY3Rvci5HVUlEIGluIGNvbnRleHQuY3VycmVudFVzZXJBY3RvcnNcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuYWN0b3JzW2FjdG9yLkdVSURdID0gYWN0b3I7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmFjdG9yU2NlbmVbYWN0b3IuR1VJRF0gPSBzY2VuZURlc2NyaXB0aW9uLnNjZW5lO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSlcbiAgICB9LFxuICAgIGluaXRWaWV3czogZnVuY3Rpb24oKXtcbiAgICAgICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgICAgICB2YXIgdmlld0NvbGxlY3Rpb24gPSB7XG4gICAgICAgICAgICB2aWV3czp7fSxcbiAgICAgICAgICAgIHZpZXdPcmRlcjogW10sXG4gICAgICAgICAgICBpZGVudGl0eU1hcCA6IHt9LFxuICAgICAgICAgICAgYWRkOiBmdW5jdGlvbihpZGVudGl0eSwgdmlldywgYWN0b3IsIFVJKXtcbiAgICAgICAgICAgICAgICBpZighKGlkZW50aXR5ICBpbiB0aGlzLnZpZXdzKSl7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudmlld3NbaWRlbnRpdHldID0gdmlldztcbiAgICAgICAgICAgICAgICAgICAgdGhpcy52aWV3T3JkZXIucHVzaChpZGVudGl0eSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMudmlld3NbaWRlbnRpdHldLmFkZEFjdG9yKCBhY3RvciApO1xuICAgICAgICAgICAgICAgIHRoaXMudmlld3NbaWRlbnRpdHldLmFkZFVJKCBVSSApO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oaWQpe1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnZpZXdzW2lkXTtcblxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGdldEl4IDpmdW5jdGlvbihpeCl7XG4gICAgICAgICAgICAgICAgdmFyIG4gPSB0aGlzLnZpZXdPcmRlcltpeF07XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KG4pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBfLmVhY2godGhpcy5hY3RvcnMsIGZ1bmN0aW9uKGFjdG9yKXtcbiAgICAgICAgICAgIHZhciBzY2VuZSA9IHRoYXQuYWN0b3JTY2VuZVthY3Rvci5HVUlEXTtcbiAgICAgICAgICAgIHZhciB2aWV3cyA9IHNjZW5lXG4gICAgICAgICAgICAgICAgLmdldF9vYmplY3QoYWN0b3IuY29udHJvbC5vYmplY3RfZ3VpZClcbiAgICAgICAgICAgICAgICAud29ya3BvaW50c1thY3Rvci5jb250cm9sLndvcmtwb2ludF0udmlld3M7XG4gICAgICAgICAgICB2YXIgbWVzaCA9IHNjZW5lLm1lc2hlc1thY3Rvci5jb250cm9sLm9iamVjdF9ndWlkXTtcbiAgICAgICAgICAgIHZhciB1aXMgPSBtZXNoLmdldFVJRm9yV1AoYWN0b3IuY29udHJvbC53b3JrcG9pbnQpO1xuICAgICAgICAgICAgXy5lYWNoKHZpZXdzLCBmdW5jdGlvbih2aWV3TmFtZSl7XG4gICAgICAgICAgICAgICAgdmFyIHZpZXdJZGVudGl0eSA9IHNjZW5lLkdVSUQgKyBhY3Rvci5jb250cm9sLm9iamVjdF9ndWlkICsgdmlld05hbWU7XG4gICAgICAgICAgICAgICAgdmFyIHZpZXcgPSBuZXcgVmlldyhzY2VuZS5HVUlELCB2aWV3TmFtZSApO1xuICAgICAgICAgICAgICAgIHZpZXdDb2xsZWN0aW9uLmFkZCh2aWV3SWRlbnRpdHksIHZpZXcsIGFjdG9yLCB1aXMgKTtcblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy52aWV3Q29sbGVjdGlvbiA9IHZpZXdDb2xsZWN0aW9uO1xuICAgICAgICB0aGlzLnZpZXdQb3J0c1swXS5iaW5kKHRoaXMudmlld0NvbGxlY3Rpb24uZ2V0SXgoMCkpO1xuXG4gICAgfSxcbiAgICBjb2xsZWN0QWN0aW9uczpmdW5jdGlvbigpe1xuICAgICAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgICAgIF8uZWFjaCh0aGlzLnZpZXdQb3J0cywgZnVuY3Rpb24odnApe1xuICAgICAgICAgICAgaWYodnAuZG9EcmF3VUkoKSAmJiB2cC52aWV3KXtcbiAgICAgICAgICAgICAgICB2YXIgdmlldyA9IHZwLnZpZXc7XG4gICAgICAgICAgICAgICAgXy5lYWNoKHZpZXcuYWN0b3JzLCBmdW5jdGlvbihhKXtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbnMgPSB0aGF0LmFjdG9yU2NlbmVbYS5HVUlEXS5nZXRBY3Rpb25zKClbYS5jb250cm9sLm9iamVjdF9ndWlkXTtcblxuICAgICAgICAgICAgICAgICAgICAvL3ZhciBzY2VuZV9hY3Rpb25zID0gdGhhdC5zY2VuZVthLnNjZW5lX2d1aWRcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKFwiYWN0aW9ucyBcIiwgYWN0aW9ucywgYSApO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuXG5cbiAgICAgICAgLypcbiAgICAgICAgXy5lYWNoKG12cC5hY3RvcnMsIGZ1bmN0aW9uKGFjdG9yKXtcbiAgICAgICAgICAgIC8vIGdldCBhY3Rpb25zIGZvciB0aGlzIGFjdG9yXG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhzZWxmLnNjZW5lQWN0aW9ucyk7XG4gICAgICAgICAgICB2YXIgc2NlbmVfZ3VpZCA9IHNlbGYuYWN0b3JTY2VuZVthY3Rvci5HVUlEXTtcbiAgICAgICAgICAgIHZhciB0b3RhbF9hY3Rpb25zID0gc2VsZi5zY2VuZUFjdGlvbnNbc2NlbmVfZ3VpZF1bYWN0b3IuY29udHJvbC5vYmplY3RfZ3VpZF1bYWN0b3IuY29udHJvbC53b3JrcG9pbnRdO1xuICAgICAgICAgICAgXy5lYWNoKHRvdGFsX2FjdGlvbnMsIGZ1bmN0aW9uKGFjdGlvbil7XG4gICAgICAgICAgICAgICAgaWYoYWN0aW9uLmRlZmF1bHRfa2V5KXtcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5faW5wdXRfa2V5bWFwW2FjdGlvbi5kZWZhdWx0X2tleV0gPSBhY3Rpb247XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKHRvdGFsX2FjdGlvbnMpO1xuICAgICAgICB9KVxuICAgICAgICAqL1xuXG5cblxuICAgICAgICAvL2NvbnNvbGUuZXJyb3IoXCJubyBjb2xsZWN0IEFjdGlvbnMgeWV0XCIpO1xuICAgIH1cblxuXG59KTsiLCIoZnVuY3Rpb24gKCl7XG4gICAgdmFyIFN0YXRpY0xvZ2dlciA9IGZ1bmN0aW9uKCl7XG4gICAgICAgIHRoaXMuX3ZhbHMgPSB7fVxuICAgICAgICB0aGlzLnNldFZhbHVlID0gZnVuY3Rpb24ocGFyYW0sIHZhbCl7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhwYXJhbSwgdmFsKTtcbiAgICAgICAgICAgIHRoaXMuX3ZhbHNbcGFyYW1dID0gdmFsO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuaW5pdCA9IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICB0aGlzLmNvbnQgPSAkKFwiPGRpdj5cIikuY3NzKHtcbiAgICAgICAgICAgICAgICAncG9zaXRpb24nOidmaXhlZCcsXG4gICAgICAgICAgICAgICAgJ3RvcCc6MCxcbiAgICAgICAgICAgICAgICAncmlnaHQnOjAsXG4gICAgICAgICAgICAgICAgJ3dpZHRoJzo0MDAsXG4gICAgICAgICAgICAgICAgJ2JvdHRvbSc6MCxcbiAgICAgICAgICAgICAgICAnYmFja2dyb3VuZC1jb2xvcic6XCJyZ2JhKDAsMjAwLDEwMCwwLjcpXCJcbiAgICAgICAgICAgIH0pLmFwcGVuZFRvKCdib2R5Jyk7XG4gICAgICAgICAgICAvLyBcdGNvbnNvbGUubG9nKHRoaXMuY29udCk7XG5cbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJlZHJhdyA9IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICB0aGlzLmNvbnQuZmluZCgnKicpLnJlbW92ZSgpO1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyh0aGlzLl92YWxzKTtcbiAgICAgICAgICAgIGZvcih2YXIgaSBpbiB0aGlzLl92YWxzKXtcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdhc2RhJyk7XG4gICAgICAgICAgICAgICAgYyA9ICQoJzxkaXY+JykuYXBwZW5kVG8odGhpcy5jb250KVxuICAgICAgICAgICAgICAgIGwgPSAkKCc8c3Bhbj4nKS5odG1sKGkgKyBcIiZuYnNwOzogJm5ic3A7XCIpLmNzcygnZm9udC13ZWlnaHQnLCdib2xkJykuYXBwZW5kVG8oYyk7XG4gICAgICAgICAgICAgICAgdiA9ICQoJzxzcGFuPicpLnRleHQoIHRoaXMuX3ZhbHNbaV0gKS5hcHBlbmRUbyhjKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XG4gICAgd2luZG93LlNMID0gbmV3IFN0YXRpY0xvZ2dlcigpO1xuXG59KSgpO1xuXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=