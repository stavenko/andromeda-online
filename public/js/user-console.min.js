var app = angular.module("user-console",["treeControl",'ngRoute']);

/*
app.run(["$rootScope","$location", function($rootScope, $location){
    $rootScope['user-console-globals']['$location'] = $location;
}])

*/


var uMap = {
        '':{ label:"Главная","controller": 'rootCont', "templateUrl":"/templates/Root.html"},
        "assets":{ label:"Активы", "controller": 'UserAllAssets', "templateUrl":"/templates/UserAllAssets.html"},
        "ships":{ label:"Мои корабли", "parent":"assets", "controller": 'UserShips', "templateUrl":"/templates/UserShips.html"},
        "goods":{ label:"Разные вещи", "parent":"assets", "controller": 'UserAssets', "templateUrl":"/templates/UserAssets.html"},
        
        "market":{ label:"Рынок", "controller": 'MarketCont', "templateUrl":"/templates/Market.html"},
        "production":{ label:"Производство", "controller": 'ProductionCont', "templateUrl":"/templates/Production.html"},
        "ownProd":{ label:"Собственные фабрики", parent:'production',  "controller": 'OwnPlantsCont', "templateUrl":"/templates/OwnPlants.html"},
        
        "missions":{ label:"Миссии", "controller": 'MissionsCont', "templateUrl":"/templates/Missions.html"},
        "mission-constructor":{ label:"Конструктор миссий", parent:'missions', "controller": 'MissionConstructorCont', "templateUrl":"/templates/MissionConstructor.html"}
        
}

app.constant("moduleUrlMap", uMap)


var getUrls = function(map){
    var url_list = {}

    var getUrl = function(addr, obj, map){
        var na = obj.parent;
        if (parent in map[na]){
            root = getUrl(na, map[na], map);
        }else{
            root = '/';
        }
        return root + na + "/" +addr;
    }

    for(var addr in map){
        var obj = map[addr];
        if('parent' in obj){
            var u = getUrl(addr, obj, map);
        }else{
            var u = "/" + addr;
        }

        var no = {url:u, _name: addr,  label:obj.label, ang:{controller:obj.controller, templateUrl:obj.templateUrl }};
        if('parent' in obj){
            no.parent = obj.parent;
        }
        url_list[u] = no;
    }
    return url_list;

}
var getUrlTree = function(map){
    // Надо составить индекс типа
    // {"/url/":[1,2] } - Цифры - это индексы итемов в дереве с чилдренами
    var tree = [];
    var objs = {};
    var roots = [];
    for (var item  in map){
        var obj = map[item];
        obj.children = []
        objs[obj._name] = obj;
        if('parent' in obj){
            // console.log("objs", objs, obj.parent, obj._name);
            objs[obj.parent].children.push(obj);
            // console.log(objs[obj.parent].children);
        }else{
            roots.push(obj._name);
            
        };
    }
    var rtree = [];
    for(var r in roots){
        // console.log("fuck", r);
        rtree.push( objs[roots[r]])
        
    }
    return rtree;
    
}
// getUrlTree(getUrls(uMap));

app.constant("moduleUrls", getUrls(uMap));
app.constant("navTree", getUrlTree(getUrls(uMap) ) );

app.config(["$routeProvider", "moduleUrlMap",  function($routeProvider, moduleUrlMap){
    
    var rp = $routeProvider;
    var map  = getUrls(moduleUrlMap);
    // console.log(">>", map);
    for(var url in map){
        // console.log(url);
        rp =  rp.when(url, map[url].ang)
    }
    // rp.otherwise({redirectTo:"/"})

}]);


app.controller("userConstructionCont", ["$scope","socketListeners", function($scope,  ws){
    
    ws.register("bookmarked-objects", function(message){
        console.log(message);
        $scope.bookmarkedObjects = message.objects;
        
    })
    
}])
app.controller('UserAllAssets', ["$scope", "socketPromise", "$q", function($scope, socketPromise, $q){
    socketPromise.get("A", {user_id: true }).then(function(res){
        $scope.assets = res;
        var promises = [];
        console.log(res);
        angular.forEach(res, function(asset, ix){
            console.log(asset);
            if(asset.location){
                var g = asset.location.g;
                if(g.orbit){
                    promises.push(socketPromise.get("celestials",{"GUID": g.orbit.C })
                        .then(function(a){console.log(a); return a;}) );
                }
                if(g.coordinates){
                    console.log("coordinates", g.coordinates);
                }
            }
        })
        $q.all(promises).then(function(cels){
            var celestials = {};
            angular.forEach(cels, function(C){
                celestials[C.GUID] = C;
            })
            $scope.celestials = celestials;

        })

    });
    $scope.d = ["a"];
    
    $scope.connect = function(position){
        // TODO Убрать возможность нажимать на кнопку еще хоть раз
        // TODO Заставлять гореть эту кнопку только если действительно не подключен     
        console.log("connect recv");
        position.user_id = true;
        socketPromise.request("C", position).then(function(res){
            console.log("something to return", res);
        })
    }
    
    $scope.shippositions = function(ship){
        socketPromise.get("T", {"type": ship.sub_type} ).then(function(res){
            $scope.positions =[]
            angular.forEach(res.workpoints, function(wp, wp_name){
                $scope.positions.push({name:wp_name, type:wp.type, object_guid: ship.GUID});
            })
        })
    }
    
    
}])

//app.controller("ShipPositionCont", ["$scope", "socketPromise", function($scope, socketPromise){
// }])

app.controller("rootCont", function($scope){
    $scope.hello = "Hello";
})

app.controller('consoleBrowser',['$scope', "$log", "$location", 'navTree',function($scope, $log, $location, navTree){
    $scope.vaar = "Hello cont";
    $log.log($location.path());
    $scope.location = $location;
   // $scope.route = r;
//     $scope.routeProvider = rp;

    //console.log("navTree", navTree);
    $scope.dataForTheTree = navTree;

    $scope.selected_node = navTree[1];
    
    $scope.showSelected = function(node){
        $log.log("showSelected", node);
        $location.url(node.url);
        
    }
    
}] );



app.service('authHash',['$http', '$log', function($http, $log){
    return {
        is_inited:false,
        _hash:null,
        _init:function(cb){
            if (this.is_inited){ return; }
            var that = this;
            this._hash = $http.get( '/my-auth-hash/')
            .then(function(resp){
                // $log.log("ah", resp);
                // that._hash = data.hash;
                cb(resp.data.hash, resp.data.user_id)
                
            })
            this.is_inited = true;
            
        },
        get: function( cb ){
            this._init( cb )
            //$log.log("L",this.q, this._hash);
            return this._hash; 
        }
    }
  }] )

app.factory('socket', ["$rootScope", "$q", "authHash",function ($rootScope,$q, authHash) {
    var socket = io.connect();
    is_authenticated = $q.defer();
    socket.on('connected', function(){
        // console.log("reconnection");
        authHash.get(function(hash, uid){
            socket.emit("auth_hash_console", {auth: hash});
        })
    })
    socket.on("auth_completed", function(msg){
        if(msg.err){
            is_authenticated.reject(msg.err);
        }else{
            is_authenticated.resolve();            
        }
        
    })
    // console.log(is_authenticated);
    is_authenticated.promise.then(function(){console.log("auth")})
    
    
  return {
    getState: function(){return "good"},
    on: function (eventName, callback) {
      socket.on(eventName, function () {  
        var args = arguments;
        $rootScope.$apply(function () {
          callback.apply(socket, args);
        });
      });
    },
    emit: function (eventName, data, callback) {
      
      socket.emit(eventName, data, function () {
        var args = arguments;
        // console.log("emitted");
        $rootScope.$apply(function () {
          if (callback) {
            callback.apply(socket, args);
          }
        });
      })
    }
  };
} ]);

app.factory("socketPromise",["$q", "$rootScope", "authHash", function( $q, $rootScope, authHash){
    var socket = io.connect();
    var is_ready = false;
    var Queue = [];
    
    is_authenticated = $q.defer();
    socket.on('connected', function(){
        // console.log("reconnection");
        authHash.get(function(hash, uid){
            socket.emit("auth_hash_console", {auth: hash});
        })
    })
    socket.on("auth_completed", function(msg){
        if(msg.err){
            is_authenticated.reject(msg.err);
        }else{

            $rootScope.$apply(function(){is_authenticated.resolve(true)})
        }
        
    })
    // console.log(is_authenticated);
    is_authenticated.promise.then(function(s,e){
        // console.log(is_authenticated, s,e);
        is_ready = true;
        for(var i =0;i <Queue.length; i++){
            socket.emit(Queue[i].T, Queue[i].p);
        }
    })
    
    var S = {};
    var cbs = {};
    var curcbix = 0;
    function getCBIx(){
        curcbix+=1;
        return curcbix % 10000;
    };
    
    var Req = function(mt, t, p){
        var d = $q.defer(),
        cbix =  getCBIx();
        cbs[cbix] = {
            cb: d
        }
        var o = {p:p};
        o.cbix = cbix;
        o.T = t;
        if(!is_ready){
            Queue.push({T:mt,p:o});
            
        }else{
            socket.emit(mt, o);
            
        }

        return d.promise;
    }
    
    var messages_to_hear = ["Q", "R"];
    angular.forEach(messages_to_hear, function(message_type){
        socket.on(message_type, function(msg){
            // console.log(">>>", msg);
            var cbix = msg.cbix;
            if(cbs.hasOwnProperty(cbix)) {
                $rootScope.$apply(cbs[cbix].cb.resolve(msg.d));
                delete cbs[cbix];
            }
        })
        
    })
    
    S.get = function(t,p){
        return Req("Q", t,p)
    }
    S.request = function(t,p){
        return Req("R", t,p)
    }
    return S;
}])

app.service("socketListeners",['socket', function(socket){
    // Здесь мы хотим создать службы, которая регистрирует несколько обновлений на любые входящие socket.io запросы
    var Listeners = {
        _listeners : {}
    }
    Listeners.register = function(eventType, cb) {
        if(this._listeners[eventType] == null){
            this._listeners[eventType] = [cb];
            return 0;
        }else{
            return this._listeners[eventType].push(cb) - 1; // current item index
        }
    }
    socket.on("W", function(message){
        var message_type = message.type;
        
        angular.forEach(Listeners._listeners[message_type], function(listener){
            listener(message);
        })
        
    })
    
    return Listeners;
    
    
}])
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImNvbnN0cnVjdGlvbi5qcyIsImNvbnRyb2xsZXJzLmpzIiwidHJlZXZpZXcuanMiLCJ3ZWJzb2NrZXQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDeEdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMxREE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6InVzZXItY29uc29sZS5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoXCJ1c2VyLWNvbnNvbGVcIixbXCJ0cmVlQ29udHJvbFwiLCduZ1JvdXRlJ10pO1xuXG4vKlxuYXBwLnJ1bihbXCIkcm9vdFNjb3BlXCIsXCIkbG9jYXRpb25cIiwgZnVuY3Rpb24oJHJvb3RTY29wZSwgJGxvY2F0aW9uKXtcbiAgICAkcm9vdFNjb3BlWyd1c2VyLWNvbnNvbGUtZ2xvYmFscyddWyckbG9jYXRpb24nXSA9ICRsb2NhdGlvbjtcbn1dKVxuXG4qL1xuXG5cbnZhciB1TWFwID0ge1xuICAgICAgICAnJzp7IGxhYmVsOlwi0JPQu9Cw0LLQvdCw0Y9cIixcImNvbnRyb2xsZXJcIjogJ3Jvb3RDb250JywgXCJ0ZW1wbGF0ZVVybFwiOlwiL3RlbXBsYXRlcy9Sb290Lmh0bWxcIn0sXG4gICAgICAgIFwiYXNzZXRzXCI6eyBsYWJlbDpcItCQ0LrRgtC40LLRi1wiLCBcImNvbnRyb2xsZXJcIjogJ1VzZXJBbGxBc3NldHMnLCBcInRlbXBsYXRlVXJsXCI6XCIvdGVtcGxhdGVzL1VzZXJBbGxBc3NldHMuaHRtbFwifSxcbiAgICAgICAgXCJzaGlwc1wiOnsgbGFiZWw6XCLQnNC+0Lgg0LrQvtGA0LDQsdC70LhcIiwgXCJwYXJlbnRcIjpcImFzc2V0c1wiLCBcImNvbnRyb2xsZXJcIjogJ1VzZXJTaGlwcycsIFwidGVtcGxhdGVVcmxcIjpcIi90ZW1wbGF0ZXMvVXNlclNoaXBzLmh0bWxcIn0sXG4gICAgICAgIFwiZ29vZHNcIjp7IGxhYmVsOlwi0KDQsNC30L3Ri9C1INCy0LXRidC4XCIsIFwicGFyZW50XCI6XCJhc3NldHNcIiwgXCJjb250cm9sbGVyXCI6ICdVc2VyQXNzZXRzJywgXCJ0ZW1wbGF0ZVVybFwiOlwiL3RlbXBsYXRlcy9Vc2VyQXNzZXRzLmh0bWxcIn0sXG4gICAgICAgIFxuICAgICAgICBcIm1hcmtldFwiOnsgbGFiZWw6XCLQoNGL0L3QvtC6XCIsIFwiY29udHJvbGxlclwiOiAnTWFya2V0Q29udCcsIFwidGVtcGxhdGVVcmxcIjpcIi90ZW1wbGF0ZXMvTWFya2V0Lmh0bWxcIn0sXG4gICAgICAgIFwicHJvZHVjdGlvblwiOnsgbGFiZWw6XCLQn9GA0L7QuNC30LLQvtC00YHRgtCy0L5cIiwgXCJjb250cm9sbGVyXCI6ICdQcm9kdWN0aW9uQ29udCcsIFwidGVtcGxhdGVVcmxcIjpcIi90ZW1wbGF0ZXMvUHJvZHVjdGlvbi5odG1sXCJ9LFxuICAgICAgICBcIm93blByb2RcIjp7IGxhYmVsOlwi0KHQvtCx0YHRgtCy0LXQvdC90YvQtSDRhNCw0LHRgNC40LrQuFwiLCBwYXJlbnQ6J3Byb2R1Y3Rpb24nLCAgXCJjb250cm9sbGVyXCI6ICdPd25QbGFudHNDb250JywgXCJ0ZW1wbGF0ZVVybFwiOlwiL3RlbXBsYXRlcy9Pd25QbGFudHMuaHRtbFwifSxcbiAgICAgICAgXG4gICAgICAgIFwibWlzc2lvbnNcIjp7IGxhYmVsOlwi0JzQuNGB0YHQuNC4XCIsIFwiY29udHJvbGxlclwiOiAnTWlzc2lvbnNDb250JywgXCJ0ZW1wbGF0ZVVybFwiOlwiL3RlbXBsYXRlcy9NaXNzaW9ucy5odG1sXCJ9LFxuICAgICAgICBcIm1pc3Npb24tY29uc3RydWN0b3JcIjp7IGxhYmVsOlwi0JrQvtC90YHRgtGA0YPQutGC0L7RgCDQvNC40YHRgdC40LlcIiwgcGFyZW50OidtaXNzaW9ucycsIFwiY29udHJvbGxlclwiOiAnTWlzc2lvbkNvbnN0cnVjdG9yQ29udCcsIFwidGVtcGxhdGVVcmxcIjpcIi90ZW1wbGF0ZXMvTWlzc2lvbkNvbnN0cnVjdG9yLmh0bWxcIn1cbiAgICAgICAgXG59XG5cbmFwcC5jb25zdGFudChcIm1vZHVsZVVybE1hcFwiLCB1TWFwKVxuXG5cbnZhciBnZXRVcmxzID0gZnVuY3Rpb24obWFwKXtcbiAgICB2YXIgdXJsX2xpc3QgPSB7fVxuXG4gICAgdmFyIGdldFVybCA9IGZ1bmN0aW9uKGFkZHIsIG9iaiwgbWFwKXtcbiAgICAgICAgdmFyIG5hID0gb2JqLnBhcmVudDtcbiAgICAgICAgaWYgKHBhcmVudCBpbiBtYXBbbmFdKXtcbiAgICAgICAgICAgIHJvb3QgPSBnZXRVcmwobmEsIG1hcFtuYV0sIG1hcCk7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgcm9vdCA9ICcvJztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcm9vdCArIG5hICsgXCIvXCIgK2FkZHI7XG4gICAgfVxuXG4gICAgZm9yKHZhciBhZGRyIGluIG1hcCl7XG4gICAgICAgIHZhciBvYmogPSBtYXBbYWRkcl07XG4gICAgICAgIGlmKCdwYXJlbnQnIGluIG9iail7XG4gICAgICAgICAgICB2YXIgdSA9IGdldFVybChhZGRyLCBvYmosIG1hcCk7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgdmFyIHUgPSBcIi9cIiArIGFkZHI7XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgbm8gPSB7dXJsOnUsIF9uYW1lOiBhZGRyLCAgbGFiZWw6b2JqLmxhYmVsLCBhbmc6e2NvbnRyb2xsZXI6b2JqLmNvbnRyb2xsZXIsIHRlbXBsYXRlVXJsOm9iai50ZW1wbGF0ZVVybCB9fTtcbiAgICAgICAgaWYoJ3BhcmVudCcgaW4gb2JqKXtcbiAgICAgICAgICAgIG5vLnBhcmVudCA9IG9iai5wYXJlbnQ7XG4gICAgICAgIH1cbiAgICAgICAgdXJsX2xpc3RbdV0gPSBubztcbiAgICB9XG4gICAgcmV0dXJuIHVybF9saXN0O1xuXG59XG52YXIgZ2V0VXJsVHJlZSA9IGZ1bmN0aW9uKG1hcCl7XG4gICAgLy8g0J3QsNC00L4g0YHQvtGB0YLQsNCy0LjRgtGMINC40L3QtNC10LrRgSDRgtC40L/QsFxuICAgIC8vIHtcIi91cmwvXCI6WzEsMl0gfSAtINCm0LjRhNGA0YsgLSDRjdGC0L4g0LjQvdC00LXQutGB0Ysg0LjRgtC10LzQvtCyINCyINC00LXRgNC10LLQtSDRgSDRh9C40LvQtNGA0LXQvdCw0LzQuFxuICAgIHZhciB0cmVlID0gW107XG4gICAgdmFyIG9ianMgPSB7fTtcbiAgICB2YXIgcm9vdHMgPSBbXTtcbiAgICBmb3IgKHZhciBpdGVtICBpbiBtYXApe1xuICAgICAgICB2YXIgb2JqID0gbWFwW2l0ZW1dO1xuICAgICAgICBvYmouY2hpbGRyZW4gPSBbXVxuICAgICAgICBvYmpzW29iai5fbmFtZV0gPSBvYmo7XG4gICAgICAgIGlmKCdwYXJlbnQnIGluIG9iail7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIm9ianNcIiwgb2Jqcywgb2JqLnBhcmVudCwgb2JqLl9uYW1lKTtcbiAgICAgICAgICAgIG9ianNbb2JqLnBhcmVudF0uY2hpbGRyZW4ucHVzaChvYmopO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2cob2Jqc1tvYmoucGFyZW50XS5jaGlsZHJlbik7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgcm9vdHMucHVzaChvYmouX25hbWUpO1xuICAgICAgICAgICAgXG4gICAgICAgIH07XG4gICAgfVxuICAgIHZhciBydHJlZSA9IFtdO1xuICAgIGZvcih2YXIgciBpbiByb290cyl7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwiZnVja1wiLCByKTtcbiAgICAgICAgcnRyZWUucHVzaCggb2Jqc1tyb290c1tyXV0pXG4gICAgICAgIFxuICAgIH1cbiAgICByZXR1cm4gcnRyZWU7XG4gICAgXG59XG4vLyBnZXRVcmxUcmVlKGdldFVybHModU1hcCkpO1xuXG5hcHAuY29uc3RhbnQoXCJtb2R1bGVVcmxzXCIsIGdldFVybHModU1hcCkpO1xuYXBwLmNvbnN0YW50KFwibmF2VHJlZVwiLCBnZXRVcmxUcmVlKGdldFVybHModU1hcCkgKSApO1xuXG5hcHAuY29uZmlnKFtcIiRyb3V0ZVByb3ZpZGVyXCIsIFwibW9kdWxlVXJsTWFwXCIsICBmdW5jdGlvbigkcm91dGVQcm92aWRlciwgbW9kdWxlVXJsTWFwKXtcbiAgICBcbiAgICB2YXIgcnAgPSAkcm91dGVQcm92aWRlcjtcbiAgICB2YXIgbWFwICA9IGdldFVybHMobW9kdWxlVXJsTWFwKTtcbiAgICAvLyBjb25zb2xlLmxvZyhcIj4+XCIsIG1hcCk7XG4gICAgZm9yKHZhciB1cmwgaW4gbWFwKXtcbiAgICAgICAgLy8gY29uc29sZS5sb2codXJsKTtcbiAgICAgICAgcnAgPSAgcnAud2hlbih1cmwsIG1hcFt1cmxdLmFuZylcbiAgICB9XG4gICAgLy8gcnAub3RoZXJ3aXNlKHtyZWRpcmVjdFRvOlwiL1wifSlcblxufV0pO1xuXG4iLCJhcHAuY29udHJvbGxlcihcInVzZXJDb25zdHJ1Y3Rpb25Db250XCIsIFtcIiRzY29wZVwiLFwic29ja2V0TGlzdGVuZXJzXCIsIGZ1bmN0aW9uKCRzY29wZSwgIHdzKXtcbiAgICBcbiAgICB3cy5yZWdpc3RlcihcImJvb2ttYXJrZWQtb2JqZWN0c1wiLCBmdW5jdGlvbihtZXNzYWdlKXtcbiAgICAgICAgY29uc29sZS5sb2cobWVzc2FnZSk7XG4gICAgICAgICRzY29wZS5ib29rbWFya2VkT2JqZWN0cyA9IG1lc3NhZ2Uub2JqZWN0cztcbiAgICAgICAgXG4gICAgfSlcbiAgICBcbn1dKSIsImFwcC5jb250cm9sbGVyKCdVc2VyQWxsQXNzZXRzJywgW1wiJHNjb3BlXCIsIFwic29ja2V0UHJvbWlzZVwiLCBcIiRxXCIsIGZ1bmN0aW9uKCRzY29wZSwgc29ja2V0UHJvbWlzZSwgJHEpe1xuICAgIHNvY2tldFByb21pc2UuZ2V0KFwiQVwiLCB7dXNlcl9pZDogdHJ1ZSB9KS50aGVuKGZ1bmN0aW9uKHJlcyl7XG4gICAgICAgICRzY29wZS5hc3NldHMgPSByZXM7XG4gICAgICAgIHZhciBwcm9taXNlcyA9IFtdO1xuICAgICAgICBjb25zb2xlLmxvZyhyZXMpO1xuICAgICAgICBhbmd1bGFyLmZvckVhY2gocmVzLCBmdW5jdGlvbihhc3NldCwgaXgpe1xuICAgICAgICAgICAgY29uc29sZS5sb2coYXNzZXQpO1xuICAgICAgICAgICAgaWYoYXNzZXQubG9jYXRpb24pe1xuICAgICAgICAgICAgICAgIHZhciBnID0gYXNzZXQubG9jYXRpb24uZztcbiAgICAgICAgICAgICAgICBpZihnLm9yYml0KXtcbiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZXMucHVzaChzb2NrZXRQcm9taXNlLmdldChcImNlbGVzdGlhbHNcIix7XCJHVUlEXCI6IGcub3JiaXQuQyB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oYSl7Y29uc29sZS5sb2coYSk7IHJldHVybiBhO30pICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmKGcuY29vcmRpbmF0ZXMpe1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImNvb3JkaW5hdGVzXCIsIGcuY29vcmRpbmF0ZXMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICAgJHEuYWxsKHByb21pc2VzKS50aGVuKGZ1bmN0aW9uKGNlbHMpe1xuICAgICAgICAgICAgdmFyIGNlbGVzdGlhbHMgPSB7fTtcbiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChjZWxzLCBmdW5jdGlvbihDKXtcbiAgICAgICAgICAgICAgICBjZWxlc3RpYWxzW0MuR1VJRF0gPSBDO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICRzY29wZS5jZWxlc3RpYWxzID0gY2VsZXN0aWFscztcblxuICAgICAgICB9KVxuXG4gICAgfSk7XG4gICAgJHNjb3BlLmQgPSBbXCJhXCJdO1xuICAgIFxuICAgICRzY29wZS5jb25uZWN0ID0gZnVuY3Rpb24ocG9zaXRpb24pe1xuICAgICAgICAvLyBUT0RPINCj0LHRgNCw0YLRjCDQstC+0LfQvNC+0LbQvdC+0YHRgtGMINC90LDQttC40LzQsNGC0Ywg0L3QsCDQutC90L7Qv9C60YMg0LXRidC1INGF0L7RgtGMINGA0LDQt1xuICAgICAgICAvLyBUT0RPINCX0LDRgdGC0LDQstC70Y/RgtGMINCz0L7RgNC10YLRjCDRjdGC0YMg0LrQvdC+0L/QutGDINGC0L7Qu9GM0LrQviDQtdGB0LvQuCDQtNC10LnRgdGC0LLQuNGC0LXQu9GM0L3QviDQvdC1INC/0L7QtNC60LvRjtGH0LXQvSAgICAgXG4gICAgICAgIGNvbnNvbGUubG9nKFwiY29ubmVjdCByZWN2XCIpO1xuICAgICAgICBwb3NpdGlvbi51c2VyX2lkID0gdHJ1ZTtcbiAgICAgICAgc29ja2V0UHJvbWlzZS5yZXF1ZXN0KFwiQ1wiLCBwb3NpdGlvbikudGhlbihmdW5jdGlvbihyZXMpe1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJzb21ldGhpbmcgdG8gcmV0dXJuXCIsIHJlcyk7XG4gICAgICAgIH0pXG4gICAgfVxuICAgIFxuICAgICRzY29wZS5zaGlwcG9zaXRpb25zID0gZnVuY3Rpb24oc2hpcCl7XG4gICAgICAgIHNvY2tldFByb21pc2UuZ2V0KFwiVFwiLCB7XCJ0eXBlXCI6IHNoaXAuc3ViX3R5cGV9ICkudGhlbihmdW5jdGlvbihyZXMpe1xuICAgICAgICAgICAgJHNjb3BlLnBvc2l0aW9ucyA9W11cbiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChyZXMud29ya3BvaW50cywgZnVuY3Rpb24od3AsIHdwX25hbWUpe1xuICAgICAgICAgICAgICAgICRzY29wZS5wb3NpdGlvbnMucHVzaCh7bmFtZTp3cF9uYW1lLCB0eXBlOndwLnR5cGUsIG9iamVjdF9ndWlkOiBzaGlwLkdVSUR9KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgfVxuICAgIFxuICAgIFxufV0pXG5cbi8vYXBwLmNvbnRyb2xsZXIoXCJTaGlwUG9zaXRpb25Db250XCIsIFtcIiRzY29wZVwiLCBcInNvY2tldFByb21pc2VcIiwgZnVuY3Rpb24oJHNjb3BlLCBzb2NrZXRQcm9taXNlKXtcbi8vIH1dKVxuXG5hcHAuY29udHJvbGxlcihcInJvb3RDb250XCIsIGZ1bmN0aW9uKCRzY29wZSl7XG4gICAgJHNjb3BlLmhlbGxvID0gXCJIZWxsb1wiO1xufSlcbiIsImFwcC5jb250cm9sbGVyKCdjb25zb2xlQnJvd3NlcicsWyckc2NvcGUnLCBcIiRsb2dcIiwgXCIkbG9jYXRpb25cIiwgJ25hdlRyZWUnLGZ1bmN0aW9uKCRzY29wZSwgJGxvZywgJGxvY2F0aW9uLCBuYXZUcmVlKXtcbiAgICAkc2NvcGUudmFhciA9IFwiSGVsbG8gY29udFwiO1xuICAgICRsb2cubG9nKCRsb2NhdGlvbi5wYXRoKCkpO1xuICAgICRzY29wZS5sb2NhdGlvbiA9ICRsb2NhdGlvbjtcbiAgIC8vICRzY29wZS5yb3V0ZSA9IHI7XG4vLyAgICAgJHNjb3BlLnJvdXRlUHJvdmlkZXIgPSBycDtcblxuICAgIC8vY29uc29sZS5sb2coXCJuYXZUcmVlXCIsIG5hdlRyZWUpO1xuICAgICRzY29wZS5kYXRhRm9yVGhlVHJlZSA9IG5hdlRyZWU7XG5cbiAgICAkc2NvcGUuc2VsZWN0ZWRfbm9kZSA9IG5hdlRyZWVbMV07XG4gICAgXG4gICAgJHNjb3BlLnNob3dTZWxlY3RlZCA9IGZ1bmN0aW9uKG5vZGUpe1xuICAgICAgICAkbG9nLmxvZyhcInNob3dTZWxlY3RlZFwiLCBub2RlKTtcbiAgICAgICAgJGxvY2F0aW9uLnVybChub2RlLnVybCk7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbn1dICk7XG5cbiIsIlxuYXBwLnNlcnZpY2UoJ2F1dGhIYXNoJyxbJyRodHRwJywgJyRsb2cnLCBmdW5jdGlvbigkaHR0cCwgJGxvZyl7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgaXNfaW5pdGVkOmZhbHNlLFxuICAgICAgICBfaGFzaDpudWxsLFxuICAgICAgICBfaW5pdDpmdW5jdGlvbihjYil7XG4gICAgICAgICAgICBpZiAodGhpcy5pc19pbml0ZWQpeyByZXR1cm47IH1cbiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcztcbiAgICAgICAgICAgIHRoaXMuX2hhc2ggPSAkaHR0cC5nZXQoICcvbXktYXV0aC1oYXNoLycpXG4gICAgICAgICAgICAudGhlbihmdW5jdGlvbihyZXNwKXtcbiAgICAgICAgICAgICAgICAvLyAkbG9nLmxvZyhcImFoXCIsIHJlc3ApO1xuICAgICAgICAgICAgICAgIC8vIHRoYXQuX2hhc2ggPSBkYXRhLmhhc2g7XG4gICAgICAgICAgICAgICAgY2IocmVzcC5kYXRhLmhhc2gsIHJlc3AuZGF0YS51c2VyX2lkKVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIHRoaXMuaXNfaW5pdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIFxuICAgICAgICB9LFxuICAgICAgICBnZXQ6IGZ1bmN0aW9uKCBjYiApe1xuICAgICAgICAgICAgdGhpcy5faW5pdCggY2IgKVxuICAgICAgICAgICAgLy8kbG9nLmxvZyhcIkxcIix0aGlzLnEsIHRoaXMuX2hhc2gpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hhc2g7IFxuICAgICAgICB9XG4gICAgfVxuICB9XSApXG5cbmFwcC5mYWN0b3J5KCdzb2NrZXQnLCBbXCIkcm9vdFNjb3BlXCIsIFwiJHFcIiwgXCJhdXRoSGFzaFwiLGZ1bmN0aW9uICgkcm9vdFNjb3BlLCRxLCBhdXRoSGFzaCkge1xuICAgIHZhciBzb2NrZXQgPSBpby5jb25uZWN0KCk7XG4gICAgaXNfYXV0aGVudGljYXRlZCA9ICRxLmRlZmVyKCk7XG4gICAgc29ja2V0Lm9uKCdjb25uZWN0ZWQnLCBmdW5jdGlvbigpe1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhcInJlY29ubmVjdGlvblwiKTtcbiAgICAgICAgYXV0aEhhc2guZ2V0KGZ1bmN0aW9uKGhhc2gsIHVpZCl7XG4gICAgICAgICAgICBzb2NrZXQuZW1pdChcImF1dGhfaGFzaF9jb25zb2xlXCIsIHthdXRoOiBoYXNofSk7XG4gICAgICAgIH0pXG4gICAgfSlcbiAgICBzb2NrZXQub24oXCJhdXRoX2NvbXBsZXRlZFwiLCBmdW5jdGlvbihtc2cpe1xuICAgICAgICBpZihtc2cuZXJyKXtcbiAgICAgICAgICAgIGlzX2F1dGhlbnRpY2F0ZWQucmVqZWN0KG1zZy5lcnIpO1xuICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgIGlzX2F1dGhlbnRpY2F0ZWQucmVzb2x2ZSgpOyAgICAgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIFxuICAgIH0pXG4gICAgLy8gY29uc29sZS5sb2coaXNfYXV0aGVudGljYXRlZCk7XG4gICAgaXNfYXV0aGVudGljYXRlZC5wcm9taXNlLnRoZW4oZnVuY3Rpb24oKXtjb25zb2xlLmxvZyhcImF1dGhcIil9KVxuICAgIFxuICAgIFxuICByZXR1cm4ge1xuICAgIGdldFN0YXRlOiBmdW5jdGlvbigpe3JldHVybiBcImdvb2RcIn0sXG4gICAgb246IGZ1bmN0aW9uIChldmVudE5hbWUsIGNhbGxiYWNrKSB7XG4gICAgICBzb2NrZXQub24oZXZlbnROYW1lLCBmdW5jdGlvbiAoKSB7ICBcbiAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7XG4gICAgICAgICRyb290U2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBjYWxsYmFjay5hcHBseShzb2NrZXQsIGFyZ3MpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0sXG4gICAgZW1pdDogZnVuY3Rpb24gKGV2ZW50TmFtZSwgZGF0YSwgY2FsbGJhY2spIHtcbiAgICAgIFxuICAgICAgc29ja2V0LmVtaXQoZXZlbnROYW1lLCBkYXRhLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzO1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhcImVtaXR0ZWRcIik7XG4gICAgICAgICRyb290U2NvcGUuJGFwcGx5KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KHNvY2tldCwgYXJncyk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgfVxuICB9O1xufSBdKTtcblxuYXBwLmZhY3RvcnkoXCJzb2NrZXRQcm9taXNlXCIsW1wiJHFcIiwgXCIkcm9vdFNjb3BlXCIsIFwiYXV0aEhhc2hcIiwgZnVuY3Rpb24oICRxLCAkcm9vdFNjb3BlLCBhdXRoSGFzaCl7XG4gICAgdmFyIHNvY2tldCA9IGlvLmNvbm5lY3QoKTtcbiAgICB2YXIgaXNfcmVhZHkgPSBmYWxzZTtcbiAgICB2YXIgUXVldWUgPSBbXTtcbiAgICBcbiAgICBpc19hdXRoZW50aWNhdGVkID0gJHEuZGVmZXIoKTtcbiAgICBzb2NrZXQub24oJ2Nvbm5lY3RlZCcsIGZ1bmN0aW9uKCl7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwicmVjb25uZWN0aW9uXCIpO1xuICAgICAgICBhdXRoSGFzaC5nZXQoZnVuY3Rpb24oaGFzaCwgdWlkKXtcbiAgICAgICAgICAgIHNvY2tldC5lbWl0KFwiYXV0aF9oYXNoX2NvbnNvbGVcIiwge2F1dGg6IGhhc2h9KTtcbiAgICAgICAgfSlcbiAgICB9KVxuICAgIHNvY2tldC5vbihcImF1dGhfY29tcGxldGVkXCIsIGZ1bmN0aW9uKG1zZyl7XG4gICAgICAgIGlmKG1zZy5lcnIpe1xuICAgICAgICAgICAgaXNfYXV0aGVudGljYXRlZC5yZWplY3QobXNnLmVycik7XG4gICAgICAgIH1lbHNle1xuXG4gICAgICAgICAgICAkcm9vdFNjb3BlLiRhcHBseShmdW5jdGlvbigpe2lzX2F1dGhlbnRpY2F0ZWQucmVzb2x2ZSh0cnVlKX0pXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgfSlcbiAgICAvLyBjb25zb2xlLmxvZyhpc19hdXRoZW50aWNhdGVkKTtcbiAgICBpc19hdXRoZW50aWNhdGVkLnByb21pc2UudGhlbihmdW5jdGlvbihzLGUpe1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhpc19hdXRoZW50aWNhdGVkLCBzLGUpO1xuICAgICAgICBpc19yZWFkeSA9IHRydWU7XG4gICAgICAgIGZvcih2YXIgaSA9MDtpIDxRdWV1ZS5sZW5ndGg7IGkrKyl7XG4gICAgICAgICAgICBzb2NrZXQuZW1pdChRdWV1ZVtpXS5ULCBRdWV1ZVtpXS5wKTtcbiAgICAgICAgfVxuICAgIH0pXG4gICAgXG4gICAgdmFyIFMgPSB7fTtcbiAgICB2YXIgY2JzID0ge307XG4gICAgdmFyIGN1cmNiaXggPSAwO1xuICAgIGZ1bmN0aW9uIGdldENCSXgoKXtcbiAgICAgICAgY3VyY2JpeCs9MTtcbiAgICAgICAgcmV0dXJuIGN1cmNiaXggJSAxMDAwMDtcbiAgICB9O1xuICAgIFxuICAgIHZhciBSZXEgPSBmdW5jdGlvbihtdCwgdCwgcCl7XG4gICAgICAgIHZhciBkID0gJHEuZGVmZXIoKSxcbiAgICAgICAgY2JpeCA9ICBnZXRDQkl4KCk7XG4gICAgICAgIGNic1tjYml4XSA9IHtcbiAgICAgICAgICAgIGNiOiBkXG4gICAgICAgIH1cbiAgICAgICAgdmFyIG8gPSB7cDpwfTtcbiAgICAgICAgby5jYml4ID0gY2JpeDtcbiAgICAgICAgby5UID0gdDtcbiAgICAgICAgaWYoIWlzX3JlYWR5KXtcbiAgICAgICAgICAgIFF1ZXVlLnB1c2goe1Q6bXQscDpvfSk7XG4gICAgICAgICAgICBcbiAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICBzb2NrZXQuZW1pdChtdCwgbyk7XG4gICAgICAgICAgICBcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBkLnByb21pc2U7XG4gICAgfVxuICAgIFxuICAgIHZhciBtZXNzYWdlc190b19oZWFyID0gW1wiUVwiLCBcIlJcIl07XG4gICAgYW5ndWxhci5mb3JFYWNoKG1lc3NhZ2VzX3RvX2hlYXIsIGZ1bmN0aW9uKG1lc3NhZ2VfdHlwZSl7XG4gICAgICAgIHNvY2tldC5vbihtZXNzYWdlX3R5cGUsIGZ1bmN0aW9uKG1zZyl7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIj4+PlwiLCBtc2cpO1xuICAgICAgICAgICAgdmFyIGNiaXggPSBtc2cuY2JpeDtcbiAgICAgICAgICAgIGlmKGNicy5oYXNPd25Qcm9wZXJ0eShjYml4KSkge1xuICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGFwcGx5KGNic1tjYml4XS5jYi5yZXNvbHZlKG1zZy5kKSk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIGNic1tjYml4XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICAgXG4gICAgfSlcbiAgICBcbiAgICBTLmdldCA9IGZ1bmN0aW9uKHQscCl7XG4gICAgICAgIHJldHVybiBSZXEoXCJRXCIsIHQscClcbiAgICB9XG4gICAgUy5yZXF1ZXN0ID0gZnVuY3Rpb24odCxwKXtcbiAgICAgICAgcmV0dXJuIFJlcShcIlJcIiwgdCxwKVxuICAgIH1cbiAgICByZXR1cm4gUztcbn1dKVxuXG5hcHAuc2VydmljZShcInNvY2tldExpc3RlbmVyc1wiLFsnc29ja2V0JywgZnVuY3Rpb24oc29ja2V0KXtcbiAgICAvLyDQl9C00LXRgdGMINC80Ysg0YXQvtGC0LjQvCDRgdC+0LfQtNCw0YLRjCDRgdC70YPQttCx0YssINC60L7RgtC+0YDQsNGPINGA0LXQs9C40YHRgtGA0LjRgNGD0LXRgiDQvdC10YHQutC+0LvRjNC60L4g0L7QsdC90L7QstC70LXQvdC40Lkg0L3QsCDQu9GO0LHRi9C1INCy0YXQvtC00Y/RidC40LUgc29ja2V0LmlvINC30LDQv9GA0L7RgdGLXG4gICAgdmFyIExpc3RlbmVycyA9IHtcbiAgICAgICAgX2xpc3RlbmVycyA6IHt9XG4gICAgfVxuICAgIExpc3RlbmVycy5yZWdpc3RlciA9IGZ1bmN0aW9uKGV2ZW50VHlwZSwgY2IpIHtcbiAgICAgICAgaWYodGhpcy5fbGlzdGVuZXJzW2V2ZW50VHlwZV0gPT0gbnVsbCl7XG4gICAgICAgICAgICB0aGlzLl9saXN0ZW5lcnNbZXZlbnRUeXBlXSA9IFtjYl07XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fbGlzdGVuZXJzW2V2ZW50VHlwZV0ucHVzaChjYikgLSAxOyAvLyBjdXJyZW50IGl0ZW0gaW5kZXhcbiAgICAgICAgfVxuICAgIH1cbiAgICBzb2NrZXQub24oXCJXXCIsIGZ1bmN0aW9uKG1lc3NhZ2Upe1xuICAgICAgICB2YXIgbWVzc2FnZV90eXBlID0gbWVzc2FnZS50eXBlO1xuICAgICAgICBcbiAgICAgICAgYW5ndWxhci5mb3JFYWNoKExpc3RlbmVycy5fbGlzdGVuZXJzW21lc3NhZ2VfdHlwZV0sIGZ1bmN0aW9uKGxpc3RlbmVyKXtcbiAgICAgICAgICAgIGxpc3RlbmVyKG1lc3NhZ2UpO1xuICAgICAgICB9KVxuICAgICAgICBcbiAgICB9KVxuICAgIFxuICAgIHJldHVybiBMaXN0ZW5lcnM7XG4gICAgXG4gICAgXG59XSkiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=