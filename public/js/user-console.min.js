var app = angular.module("user-console",["treeControl",'ngRoute']);

/*
app.run(["$rootScope","$location", function($rootScope, $location){
    $rootScope['user-console-globals']['$location'] = $location;
}])

*/


var uMap = {
        '':{ label:"Главная","controller": 'rootCont', "templateUrl":"/templates/Root.html"},
        "assets":{ label:"Активы", "controller": 'UserAllAssets', "templateUrl":"/templates/UserAllAssets.html"},
        "ships":{ label:"Мои корабли", "parent":"assets", "controller": 'UserShips', "templateUrl":"/templates/UserShips.html"},
        "goods":{ label:"Разные вещи", "parent":"assets", "controller": 'UserAssets', "templateUrl":"/templates/UserAssets.html"},
        
        "market":{ label:"Рынок", "controller": 'MarketCont', "templateUrl":"/templates/Market.html"},
        "production":{ label:"Производство", "controller": 'ProductionCont', "templateUrl":"/templates/Production.html"},
        "ownProd":{ label:"Собственные фабрики", parent:'production',  "controller": 'OwnPlantsCont', "templateUrl":"/templates/OwnPlants.html"},
        
        "missions":{ label:"Миссии", "controller": 'MissionsCont', "templateUrl":"/templates/Missions.html"},
        "mission-constructor":{ label:"Конструктор миссий", parent:'missions', "controller": 'MissionConstructorCont', "templateUrl":"/templates/MissionConstructor.html"}
        
}

app.constant("moduleUrlMap", uMap)


var getUrls = function(map){
    var url_list = {}

    var getUrl = function(addr, obj, map){
        var na = obj.parent;
        if (parent in map[na]){
            root = getUrl(na, map[na], map);
        }else{
            root = '/';
        }
        return root + na + "/" +addr;
    }

    for(var addr in map){
        var obj = map[addr];
        if('parent' in obj){
            var u = getUrl(addr, obj, map);
        }else{
            var u = "/" + addr;
        }

        var no = {url:u, _name: addr,  label:obj.label, ang:{controller:obj.controller, templateUrl:obj.templateUrl }};
        if('parent' in obj){
            no.parent = obj.parent;
        }
        url_list[u] = no;
    }
    return url_list;

}
var getUrlTree = function(map){
    // Надо составить индекс типа
    // {"/url/":[1,2] } - Цифры - это индексы итемов в дереве с чилдренами
    var tree = [];
    var objs = {};
    var roots = [];
    for (var item  in map){
        var obj = map[item];
        obj.children = []
        objs[obj._name] = obj;
        if('parent' in obj){
            // console.log("objs", objs, obj.parent, obj._name);
            objs[obj.parent].children.push(obj);
            // console.log(objs[obj.parent].children);
        }else{
            roots.push(obj._name);
            
        };
    }
    var rtree = [];
    for(var r in roots){
        // console.log("fuck", r);
        rtree.push( objs[roots[r]])
        
    }
    return rtree;
    
}
// getUrlTree(getUrls(uMap));

app.constant("moduleUrls", getUrls(uMap));
app.constant("navTree", getUrlTree(getUrls(uMap) ) );

app.config(["$routeProvider", "moduleUrlMap",  function($routeProvider, moduleUrlMap){
    
    var rp = $routeProvider;
    var map  = getUrls(moduleUrlMap);
    // console.log(">>", map);
    for(var url in map){
        // console.log(url);
        rp =  rp.when(url, map[url].ang)
    }
    // rp.otherwise({redirectTo:"/"})

}]);


app.controller("userConstructionCont", ["$scope","socketListeners", function($scope,  ws){
    
    ws.register("bookmarked-objects", function(message){
        console.log(message);
        $scope.bookmarkedObjects = message.objects;
        
    })
    
}])
app.controller('UserAllAssets', ["$scope", "socketPromise", "$q", function($scope, socketPromise, $q){
    socketPromise.get("A", {user_id: true }).then(function(res){
        $scope.assets = res;
        var promises = [];
        console.log(res);
        angular.forEach(res, function(asset, ix){
            console.log(asset);
            if(asset.location){
                var g = asset.location.g;
                if(g.orbit){
                    promises.push(socketPromise.get("celestials",{"GUID": g.orbit.C })
                        .then(function(a){console.log(a); return a;}) );
                }
                if(g.coordinates){
                    console.log("coordinates", g.coordinates);
                }
            }
        })
        $q.all(promises).then(function(cels){
            var celestials = {};
            angular.forEach(cels, function(C){
                console.log("CCC", C);
                celestials[C.GUID] = C;
            })
            console.log("Co", celestials);
            $scope.celestials = celestials;

        })

    });
    $scope.d = ["a"];
    
    $scope.connect = function(position){
        // TODO Убрать возможность нажимать на кнопку еще хоть раз
        // TODO Заставлять гореть эту кнопку только если действительно не подключен     
        console.log("connect recv");
        position.user_id = true;
        socketPromise.request("C", position).then(function(res){
            console.log("something to return", res);
        })
        // console.log(position);
    }
    
    $scope.shippositions = function(ship){
        //console.log(">>G", ship);
        socketPromise.get("T", {"type": ship.ship_type} ).then(function(res){
            // console.log(res);
            $scope.positions =[]
            angular.forEach(res.workpoints, function(wp, wp_name){
                $scope.positions.push({name:wp_name, type:wp.type, object_guid: ship.GUID});
            })
        })
    }
    
    
}])

//app.controller("ShipPositionCont", ["$scope", "socketPromise", function($scope, socketPromise){
// }])

app.controller("rootCont", function($scope){
    $scope.hello = "Hello";
})
app.controller('consoleBrowser',['$scope', "$log", "$location", 'navTree',function($scope, $log, $location, navTree){
    $scope.vaar = "Hello cont";
    $log.log($location.path());
    $scope.location = $location;
   // $scope.route = r;
//     $scope.routeProvider = rp;

    //console.log("navTree", navTree);
    $scope.dataForTheTree = navTree;

    $scope.selected_node = navTree[1];
    
    $scope.showSelected = function(node){
        $log.log("showSelected", node);
        $location.url(node.url);
        
    }
    
}] );



app.service('authHash',['$http', '$log', function($http, $log){
    return {
        is_inited:false,
        _hash:null,
        _init:function(cb){
            if (this.is_inited){ return; }
            var that = this;
            this._hash = $http.get( '/my-auth-hash/')
            .then(function(resp){
                // $log.log("ah", resp);
                // that._hash = data.hash;
                cb(resp.data.hash, resp.data.user_id)
                
            })
            this.is_inited = true;
            
        },
        get: function( cb ){
            this._init( cb )
            //$log.log("L",this.q, this._hash);
            return this._hash; 
        }
    }
  }] )

app.factory('socket', ["$rootScope", "$q", "authHash",function ($rootScope,$q, authHash) {
    var socket = io.connect();
    is_authenticated = $q.defer();
    socket.on('connected', function(){
        // console.log("reconnection");
        authHash.get(function(hash, uid){
            socket.emit("auth_hash_console", {auth: hash});
        })
    })
    socket.on("auth_completed", function(msg){
        if(msg.err){
            is_authenticated.reject(msg.err);
        }else{
            is_authenticated.resolve();            
        }
        
    })
    // console.log(is_authenticated);
    is_authenticated.promise.then(function(){console.log("auth")})
    
    
  return {
    getState: function(){return "good"},
    on: function (eventName, callback) {
      socket.on(eventName, function () {  
        var args = arguments;
        $rootScope.$apply(function () {
          callback.apply(socket, args);
        });
      });
    },
    emit: function (eventName, data, callback) {
      
      socket.emit(eventName, data, function () {
        var args = arguments;
        // console.log("emitted");
        $rootScope.$apply(function () {
          if (callback) {
            callback.apply(socket, args);
          }
        });
      })
    }
  };
} ]);

app.factory("socketPromise",["$q", "$rootScope", "authHash", function( $q, $rootScope, authHash){
    var socket = io.connect();
    var is_ready = false;
    var Queue = [];
    
    is_authenticated = $q.defer();
    socket.on('connected', function(){
        // console.log("reconnection");
        authHash.get(function(hash, uid){
            socket.emit("auth_hash_console", {auth: hash});
        })
    })
    socket.on("auth_completed", function(msg){
        if(msg.err){
            is_authenticated.reject(msg.err);
        }else{

            $rootScope.$apply(function(){is_authenticated.resolve(true)})
        }
        
    })
    // console.log(is_authenticated);
    is_authenticated.promise.then(function(s,e){
        // console.log(is_authenticated, s,e);
        is_ready = true;
        for(var i =0;i <Queue.length; i++){
            socket.emit(Queue[i].T, Queue[i].p);
        }
    })
    
    var S = {};
    var cbs = {};
    var curcbix = 0;
    function getCBIx(){
        curcbix+=1;
        return curcbix % 10000;
    };
    
    var Req = function(mt, t, p){
        var d = $q.defer(),
        cbix =  getCBIx();
        cbs[cbix] = {
            cb: d
        }
        var o = {p:p};
        o.cbix = cbix;
        o.T = t;
        if(!is_ready){
            Queue.push({T:mt,p:o});
            
        }else{
            socket.emit(mt, o);
            
        }

        return d.promise;
    }
    
    var messages_to_hear = ["Q", "R"];
    angular.forEach(messages_to_hear, function(message_type){
        socket.on(message_type, function(msg){
            // console.log(">>>", msg);
            var cbix = msg.cbix;
            if(cbs.hasOwnProperty(cbix)) {
                $rootScope.$apply(cbs[cbix].cb.resolve(msg.d));
                delete cbs[cbix];
            }
        })
        
    })
    
    S.get = function(t,p){
        return Req("Q", t,p)
    }
    S.request = function(t,p){
        return Req("R", t,p)
    }
    return S;
}])

app.service("socketListeners",['socket', function(socket){
    // Здесь мы хотим создать службы, которая регистрирует несколько обновлений на любые входящие socket.io запросы
    var Listeners = {
        _listeners : {}
    }
    Listeners.register = function(eventType, cb) {
        if(this._listeners[eventType] == null){
            this._listeners[eventType] = [cb];
            return 0;
        }else{
            return this._listeners[eventType].push(cb) - 1; // current item index
        }
    }
    socket.on("W", function(message){
        var message_type = message.type;
        
        angular.forEach(Listeners._listeners[message_type], function(listener){
            listener(message);
        })
        
    })
    
    return Listeners;
    
    
}])
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImNvbnN0cnVjdGlvbi5qcyIsImNvbnRyb2xsZXJzLmpzIiwidHJlZXZpZXcuanMiLCJ3ZWJzb2NrZXQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDeEdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzlEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNwQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoidXNlci1jb25zb2xlLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBhcHAgPSBhbmd1bGFyLm1vZHVsZShcInVzZXItY29uc29sZVwiLFtcInRyZWVDb250cm9sXCIsJ25nUm91dGUnXSk7XG5cbi8qXG5hcHAucnVuKFtcIiRyb290U2NvcGVcIixcIiRsb2NhdGlvblwiLCBmdW5jdGlvbigkcm9vdFNjb3BlLCAkbG9jYXRpb24pe1xuICAgICRyb290U2NvcGVbJ3VzZXItY29uc29sZS1nbG9iYWxzJ11bJyRsb2NhdGlvbiddID0gJGxvY2F0aW9uO1xufV0pXG5cbiovXG5cblxudmFyIHVNYXAgPSB7XG4gICAgICAgICcnOnsgbGFiZWw6XCLQk9C70LDQstC90LDRj1wiLFwiY29udHJvbGxlclwiOiAncm9vdENvbnQnLCBcInRlbXBsYXRlVXJsXCI6XCIvdGVtcGxhdGVzL1Jvb3QuaHRtbFwifSxcbiAgICAgICAgXCJhc3NldHNcIjp7IGxhYmVsOlwi0JDQutGC0LjQstGLXCIsIFwiY29udHJvbGxlclwiOiAnVXNlckFsbEFzc2V0cycsIFwidGVtcGxhdGVVcmxcIjpcIi90ZW1wbGF0ZXMvVXNlckFsbEFzc2V0cy5odG1sXCJ9LFxuICAgICAgICBcInNoaXBzXCI6eyBsYWJlbDpcItCc0L7QuCDQutC+0YDQsNCx0LvQuFwiLCBcInBhcmVudFwiOlwiYXNzZXRzXCIsIFwiY29udHJvbGxlclwiOiAnVXNlclNoaXBzJywgXCJ0ZW1wbGF0ZVVybFwiOlwiL3RlbXBsYXRlcy9Vc2VyU2hpcHMuaHRtbFwifSxcbiAgICAgICAgXCJnb29kc1wiOnsgbGFiZWw6XCLQoNCw0LfQvdGL0LUg0LLQtdGJ0LhcIiwgXCJwYXJlbnRcIjpcImFzc2V0c1wiLCBcImNvbnRyb2xsZXJcIjogJ1VzZXJBc3NldHMnLCBcInRlbXBsYXRlVXJsXCI6XCIvdGVtcGxhdGVzL1VzZXJBc3NldHMuaHRtbFwifSxcbiAgICAgICAgXG4gICAgICAgIFwibWFya2V0XCI6eyBsYWJlbDpcItCg0YvQvdC+0LpcIiwgXCJjb250cm9sbGVyXCI6ICdNYXJrZXRDb250JywgXCJ0ZW1wbGF0ZVVybFwiOlwiL3RlbXBsYXRlcy9NYXJrZXQuaHRtbFwifSxcbiAgICAgICAgXCJwcm9kdWN0aW9uXCI6eyBsYWJlbDpcItCf0YDQvtC40LfQstC+0LTRgdGC0LLQvlwiLCBcImNvbnRyb2xsZXJcIjogJ1Byb2R1Y3Rpb25Db250JywgXCJ0ZW1wbGF0ZVVybFwiOlwiL3RlbXBsYXRlcy9Qcm9kdWN0aW9uLmh0bWxcIn0sXG4gICAgICAgIFwib3duUHJvZFwiOnsgbGFiZWw6XCLQodC+0LHRgdGC0LLQtdC90L3Ri9C1INGE0LDQsdGA0LjQutC4XCIsIHBhcmVudDoncHJvZHVjdGlvbicsICBcImNvbnRyb2xsZXJcIjogJ093blBsYW50c0NvbnQnLCBcInRlbXBsYXRlVXJsXCI6XCIvdGVtcGxhdGVzL093blBsYW50cy5odG1sXCJ9LFxuICAgICAgICBcbiAgICAgICAgXCJtaXNzaW9uc1wiOnsgbGFiZWw6XCLQnNC40YHRgdC40LhcIiwgXCJjb250cm9sbGVyXCI6ICdNaXNzaW9uc0NvbnQnLCBcInRlbXBsYXRlVXJsXCI6XCIvdGVtcGxhdGVzL01pc3Npb25zLmh0bWxcIn0sXG4gICAgICAgIFwibWlzc2lvbi1jb25zdHJ1Y3RvclwiOnsgbGFiZWw6XCLQmtC+0L3RgdGC0YDRg9C60YLQvtGAINC80LjRgdGB0LjQuVwiLCBwYXJlbnQ6J21pc3Npb25zJywgXCJjb250cm9sbGVyXCI6ICdNaXNzaW9uQ29uc3RydWN0b3JDb250JywgXCJ0ZW1wbGF0ZVVybFwiOlwiL3RlbXBsYXRlcy9NaXNzaW9uQ29uc3RydWN0b3IuaHRtbFwifVxuICAgICAgICBcbn1cblxuYXBwLmNvbnN0YW50KFwibW9kdWxlVXJsTWFwXCIsIHVNYXApXG5cblxudmFyIGdldFVybHMgPSBmdW5jdGlvbihtYXApe1xuICAgIHZhciB1cmxfbGlzdCA9IHt9XG5cbiAgICB2YXIgZ2V0VXJsID0gZnVuY3Rpb24oYWRkciwgb2JqLCBtYXApe1xuICAgICAgICB2YXIgbmEgPSBvYmoucGFyZW50O1xuICAgICAgICBpZiAocGFyZW50IGluIG1hcFtuYV0pe1xuICAgICAgICAgICAgcm9vdCA9IGdldFVybChuYSwgbWFwW25hXSwgbWFwKTtcbiAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICByb290ID0gJy8nO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByb290ICsgbmEgKyBcIi9cIiArYWRkcjtcbiAgICB9XG5cbiAgICBmb3IodmFyIGFkZHIgaW4gbWFwKXtcbiAgICAgICAgdmFyIG9iaiA9IG1hcFthZGRyXTtcbiAgICAgICAgaWYoJ3BhcmVudCcgaW4gb2JqKXtcbiAgICAgICAgICAgIHZhciB1ID0gZ2V0VXJsKGFkZHIsIG9iaiwgbWFwKTtcbiAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICB2YXIgdSA9IFwiL1wiICsgYWRkcjtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBubyA9IHt1cmw6dSwgX25hbWU6IGFkZHIsICBsYWJlbDpvYmoubGFiZWwsIGFuZzp7Y29udHJvbGxlcjpvYmouY29udHJvbGxlciwgdGVtcGxhdGVVcmw6b2JqLnRlbXBsYXRlVXJsIH19O1xuICAgICAgICBpZigncGFyZW50JyBpbiBvYmope1xuICAgICAgICAgICAgbm8ucGFyZW50ID0gb2JqLnBhcmVudDtcbiAgICAgICAgfVxuICAgICAgICB1cmxfbGlzdFt1XSA9IG5vO1xuICAgIH1cbiAgICByZXR1cm4gdXJsX2xpc3Q7XG5cbn1cbnZhciBnZXRVcmxUcmVlID0gZnVuY3Rpb24obWFwKXtcbiAgICAvLyDQndCw0LTQviDRgdC+0YHRgtCw0LLQuNGC0Ywg0LjQvdC00LXQutGBINGC0LjQv9CwXG4gICAgLy8ge1wiL3VybC9cIjpbMSwyXSB9IC0g0KbQuNGE0YDRiyAtINGN0YLQviDQuNC90LTQtdC60YHRiyDQuNGC0LXQvNC+0LIg0LIg0LTQtdGA0LXQstC1INGBINGH0LjQu9C00YDQtdC90LDQvNC4XG4gICAgdmFyIHRyZWUgPSBbXTtcbiAgICB2YXIgb2JqcyA9IHt9O1xuICAgIHZhciByb290cyA9IFtdO1xuICAgIGZvciAodmFyIGl0ZW0gIGluIG1hcCl7XG4gICAgICAgIHZhciBvYmogPSBtYXBbaXRlbV07XG4gICAgICAgIG9iai5jaGlsZHJlbiA9IFtdXG4gICAgICAgIG9ianNbb2JqLl9uYW1lXSA9IG9iajtcbiAgICAgICAgaWYoJ3BhcmVudCcgaW4gb2JqKXtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwib2Jqc1wiLCBvYmpzLCBvYmoucGFyZW50LCBvYmouX25hbWUpO1xuICAgICAgICAgICAgb2Jqc1tvYmoucGFyZW50XS5jaGlsZHJlbi5wdXNoKG9iaik7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhvYmpzW29iai5wYXJlbnRdLmNoaWxkcmVuKTtcbiAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICByb290cy5wdXNoKG9iai5fbmFtZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgfTtcbiAgICB9XG4gICAgdmFyIHJ0cmVlID0gW107XG4gICAgZm9yKHZhciByIGluIHJvb3RzKXtcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJmdWNrXCIsIHIpO1xuICAgICAgICBydHJlZS5wdXNoKCBvYmpzW3Jvb3RzW3JdXSlcbiAgICAgICAgXG4gICAgfVxuICAgIHJldHVybiBydHJlZTtcbiAgICBcbn1cbi8vIGdldFVybFRyZWUoZ2V0VXJscyh1TWFwKSk7XG5cbmFwcC5jb25zdGFudChcIm1vZHVsZVVybHNcIiwgZ2V0VXJscyh1TWFwKSk7XG5hcHAuY29uc3RhbnQoXCJuYXZUcmVlXCIsIGdldFVybFRyZWUoZ2V0VXJscyh1TWFwKSApICk7XG5cbmFwcC5jb25maWcoW1wiJHJvdXRlUHJvdmlkZXJcIiwgXCJtb2R1bGVVcmxNYXBcIiwgIGZ1bmN0aW9uKCRyb3V0ZVByb3ZpZGVyLCBtb2R1bGVVcmxNYXApe1xuICAgIFxuICAgIHZhciBycCA9ICRyb3V0ZVByb3ZpZGVyO1xuICAgIHZhciBtYXAgID0gZ2V0VXJscyhtb2R1bGVVcmxNYXApO1xuICAgIC8vIGNvbnNvbGUubG9nKFwiPj5cIiwgbWFwKTtcbiAgICBmb3IodmFyIHVybCBpbiBtYXApe1xuICAgICAgICAvLyBjb25zb2xlLmxvZyh1cmwpO1xuICAgICAgICBycCA9ICBycC53aGVuKHVybCwgbWFwW3VybF0uYW5nKVxuICAgIH1cbiAgICAvLyBycC5vdGhlcndpc2Uoe3JlZGlyZWN0VG86XCIvXCJ9KVxuXG59XSk7XG5cbiIsImFwcC5jb250cm9sbGVyKFwidXNlckNvbnN0cnVjdGlvbkNvbnRcIiwgW1wiJHNjb3BlXCIsXCJzb2NrZXRMaXN0ZW5lcnNcIiwgZnVuY3Rpb24oJHNjb3BlLCAgd3Mpe1xuICAgIFxuICAgIHdzLnJlZ2lzdGVyKFwiYm9va21hcmtlZC1vYmplY3RzXCIsIGZ1bmN0aW9uKG1lc3NhZ2Upe1xuICAgICAgICBjb25zb2xlLmxvZyhtZXNzYWdlKTtcbiAgICAgICAgJHNjb3BlLmJvb2ttYXJrZWRPYmplY3RzID0gbWVzc2FnZS5vYmplY3RzO1xuICAgICAgICBcbiAgICB9KVxuICAgIFxufV0pIiwiYXBwLmNvbnRyb2xsZXIoJ1VzZXJBbGxBc3NldHMnLCBbXCIkc2NvcGVcIiwgXCJzb2NrZXRQcm9taXNlXCIsIFwiJHFcIiwgZnVuY3Rpb24oJHNjb3BlLCBzb2NrZXRQcm9taXNlLCAkcSl7XG4gICAgc29ja2V0UHJvbWlzZS5nZXQoXCJBXCIsIHt1c2VyX2lkOiB0cnVlIH0pLnRoZW4oZnVuY3Rpb24ocmVzKXtcbiAgICAgICAgJHNjb3BlLmFzc2V0cyA9IHJlcztcbiAgICAgICAgdmFyIHByb21pc2VzID0gW107XG4gICAgICAgIGNvbnNvbGUubG9nKHJlcyk7XG4gICAgICAgIGFuZ3VsYXIuZm9yRWFjaChyZXMsIGZ1bmN0aW9uKGFzc2V0LCBpeCl7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhhc3NldCk7XG4gICAgICAgICAgICBpZihhc3NldC5sb2NhdGlvbil7XG4gICAgICAgICAgICAgICAgdmFyIGcgPSBhc3NldC5sb2NhdGlvbi5nO1xuICAgICAgICAgICAgICAgIGlmKGcub3JiaXQpe1xuICAgICAgICAgICAgICAgICAgICBwcm9taXNlcy5wdXNoKHNvY2tldFByb21pc2UuZ2V0KFwiY2VsZXN0aWFsc1wiLHtcIkdVSURcIjogZy5vcmJpdC5DIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbihhKXtjb25zb2xlLmxvZyhhKTsgcmV0dXJuIGE7fSkgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYoZy5jb29yZGluYXRlcyl7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiY29vcmRpbmF0ZXNcIiwgZy5jb29yZGluYXRlcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgICAkcS5hbGwocHJvbWlzZXMpLnRoZW4oZnVuY3Rpb24oY2Vscyl7XG4gICAgICAgICAgICB2YXIgY2VsZXN0aWFscyA9IHt9O1xuICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGNlbHMsIGZ1bmN0aW9uKEMpe1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQ0NDXCIsIEMpO1xuICAgICAgICAgICAgICAgIGNlbGVzdGlhbHNbQy5HVUlEXSA9IEM7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJDb1wiLCBjZWxlc3RpYWxzKTtcbiAgICAgICAgICAgICRzY29wZS5jZWxlc3RpYWxzID0gY2VsZXN0aWFscztcblxuICAgICAgICB9KVxuXG4gICAgfSk7XG4gICAgJHNjb3BlLmQgPSBbXCJhXCJdO1xuICAgIFxuICAgICRzY29wZS5jb25uZWN0ID0gZnVuY3Rpb24ocG9zaXRpb24pe1xuICAgICAgICAvLyBUT0RPINCj0LHRgNCw0YLRjCDQstC+0LfQvNC+0LbQvdC+0YHRgtGMINC90LDQttC40LzQsNGC0Ywg0L3QsCDQutC90L7Qv9C60YMg0LXRidC1INGF0L7RgtGMINGA0LDQt1xuICAgICAgICAvLyBUT0RPINCX0LDRgdGC0LDQstC70Y/RgtGMINCz0L7RgNC10YLRjCDRjdGC0YMg0LrQvdC+0L/QutGDINGC0L7Qu9GM0LrQviDQtdGB0LvQuCDQtNC10LnRgdGC0LLQuNGC0LXQu9GM0L3QviDQvdC1INC/0L7QtNC60LvRjtGH0LXQvSAgICAgXG4gICAgICAgIGNvbnNvbGUubG9nKFwiY29ubmVjdCByZWN2XCIpO1xuICAgICAgICBwb3NpdGlvbi51c2VyX2lkID0gdHJ1ZTtcbiAgICAgICAgc29ja2V0UHJvbWlzZS5yZXF1ZXN0KFwiQ1wiLCBwb3NpdGlvbikudGhlbihmdW5jdGlvbihyZXMpe1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJzb21ldGhpbmcgdG8gcmV0dXJuXCIsIHJlcyk7XG4gICAgICAgIH0pXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKHBvc2l0aW9uKTtcbiAgICB9XG4gICAgXG4gICAgJHNjb3BlLnNoaXBwb3NpdGlvbnMgPSBmdW5jdGlvbihzaGlwKXtcbiAgICAgICAgLy9jb25zb2xlLmxvZyhcIj4+R1wiLCBzaGlwKTtcbiAgICAgICAgc29ja2V0UHJvbWlzZS5nZXQoXCJUXCIsIHtcInR5cGVcIjogc2hpcC5zaGlwX3R5cGV9ICkudGhlbihmdW5jdGlvbihyZXMpe1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2cocmVzKTtcbiAgICAgICAgICAgICRzY29wZS5wb3NpdGlvbnMgPVtdXG4gICAgICAgICAgICBhbmd1bGFyLmZvckVhY2gocmVzLndvcmtwb2ludHMsIGZ1bmN0aW9uKHdwLCB3cF9uYW1lKXtcbiAgICAgICAgICAgICAgICAkc2NvcGUucG9zaXRpb25zLnB1c2goe25hbWU6d3BfbmFtZSwgdHlwZTp3cC50eXBlLCBvYmplY3RfZ3VpZDogc2hpcC5HVUlEfSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgIH1cbiAgICBcbiAgICBcbn1dKVxuXG4vL2FwcC5jb250cm9sbGVyKFwiU2hpcFBvc2l0aW9uQ29udFwiLCBbXCIkc2NvcGVcIiwgXCJzb2NrZXRQcm9taXNlXCIsIGZ1bmN0aW9uKCRzY29wZSwgc29ja2V0UHJvbWlzZSl7XG4vLyB9XSlcblxuYXBwLmNvbnRyb2xsZXIoXCJyb290Q29udFwiLCBmdW5jdGlvbigkc2NvcGUpe1xuICAgICRzY29wZS5oZWxsbyA9IFwiSGVsbG9cIjtcbn0pIiwiYXBwLmNvbnRyb2xsZXIoJ2NvbnNvbGVCcm93c2VyJyxbJyRzY29wZScsIFwiJGxvZ1wiLCBcIiRsb2NhdGlvblwiLCAnbmF2VHJlZScsZnVuY3Rpb24oJHNjb3BlLCAkbG9nLCAkbG9jYXRpb24sIG5hdlRyZWUpe1xuICAgICRzY29wZS52YWFyID0gXCJIZWxsbyBjb250XCI7XG4gICAgJGxvZy5sb2coJGxvY2F0aW9uLnBhdGgoKSk7XG4gICAgJHNjb3BlLmxvY2F0aW9uID0gJGxvY2F0aW9uO1xuICAgLy8gJHNjb3BlLnJvdXRlID0gcjtcbi8vICAgICAkc2NvcGUucm91dGVQcm92aWRlciA9IHJwO1xuXG4gICAgLy9jb25zb2xlLmxvZyhcIm5hdlRyZWVcIiwgbmF2VHJlZSk7XG4gICAgJHNjb3BlLmRhdGFGb3JUaGVUcmVlID0gbmF2VHJlZTtcblxuICAgICRzY29wZS5zZWxlY3RlZF9ub2RlID0gbmF2VHJlZVsxXTtcbiAgICBcbiAgICAkc2NvcGUuc2hvd1NlbGVjdGVkID0gZnVuY3Rpb24obm9kZSl7XG4gICAgICAgICRsb2cubG9nKFwic2hvd1NlbGVjdGVkXCIsIG5vZGUpO1xuICAgICAgICAkbG9jYXRpb24udXJsKG5vZGUudXJsKTtcbiAgICAgICAgXG4gICAgfVxuICAgIFxufV0gKTtcblxuIiwiXG5hcHAuc2VydmljZSgnYXV0aEhhc2gnLFsnJGh0dHAnLCAnJGxvZycsIGZ1bmN0aW9uKCRodHRwLCAkbG9nKXtcbiAgICByZXR1cm4ge1xuICAgICAgICBpc19pbml0ZWQ6ZmFsc2UsXG4gICAgICAgIF9oYXNoOm51bGwsXG4gICAgICAgIF9pbml0OmZ1bmN0aW9uKGNiKXtcbiAgICAgICAgICAgIGlmICh0aGlzLmlzX2luaXRlZCl7IHJldHVybjsgfVxuICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgICAgICAgICAgdGhpcy5faGFzaCA9ICRodHRwLmdldCggJy9teS1hdXRoLWhhc2gvJylcbiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3Ape1xuICAgICAgICAgICAgICAgIC8vICRsb2cubG9nKFwiYWhcIiwgcmVzcCk7XG4gICAgICAgICAgICAgICAgLy8gdGhhdC5faGFzaCA9IGRhdGEuaGFzaDtcbiAgICAgICAgICAgICAgICBjYihyZXNwLmRhdGEuaGFzaCwgcmVzcC5kYXRhLnVzZXJfaWQpXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgdGhpcy5pc19pbml0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgXG4gICAgICAgIH0sXG4gICAgICAgIGdldDogZnVuY3Rpb24oIGNiICl7XG4gICAgICAgICAgICB0aGlzLl9pbml0KCBjYiApXG4gICAgICAgICAgICAvLyRsb2cubG9nKFwiTFwiLHRoaXMucSwgdGhpcy5faGFzaCk7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5faGFzaDsgXG4gICAgICAgIH1cbiAgICB9XG4gIH1dIClcblxuYXBwLmZhY3RvcnkoJ3NvY2tldCcsIFtcIiRyb290U2NvcGVcIiwgXCIkcVwiLCBcImF1dGhIYXNoXCIsZnVuY3Rpb24gKCRyb290U2NvcGUsJHEsIGF1dGhIYXNoKSB7XG4gICAgdmFyIHNvY2tldCA9IGlvLmNvbm5lY3QoKTtcbiAgICBpc19hdXRoZW50aWNhdGVkID0gJHEuZGVmZXIoKTtcbiAgICBzb2NrZXQub24oJ2Nvbm5lY3RlZCcsIGZ1bmN0aW9uKCl7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwicmVjb25uZWN0aW9uXCIpO1xuICAgICAgICBhdXRoSGFzaC5nZXQoZnVuY3Rpb24oaGFzaCwgdWlkKXtcbiAgICAgICAgICAgIHNvY2tldC5lbWl0KFwiYXV0aF9oYXNoX2NvbnNvbGVcIiwge2F1dGg6IGhhc2h9KTtcbiAgICAgICAgfSlcbiAgICB9KVxuICAgIHNvY2tldC5vbihcImF1dGhfY29tcGxldGVkXCIsIGZ1bmN0aW9uKG1zZyl7XG4gICAgICAgIGlmKG1zZy5lcnIpe1xuICAgICAgICAgICAgaXNfYXV0aGVudGljYXRlZC5yZWplY3QobXNnLmVycik7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgaXNfYXV0aGVudGljYXRlZC5yZXNvbHZlKCk7ICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgfSlcbiAgICAvLyBjb25zb2xlLmxvZyhpc19hdXRoZW50aWNhdGVkKTtcbiAgICBpc19hdXRoZW50aWNhdGVkLnByb21pc2UudGhlbihmdW5jdGlvbigpe2NvbnNvbGUubG9nKFwiYXV0aFwiKX0pXG4gICAgXG4gICAgXG4gIHJldHVybiB7XG4gICAgZ2V0U3RhdGU6IGZ1bmN0aW9uKCl7cmV0dXJuIFwiZ29vZFwifSxcbiAgICBvbjogZnVuY3Rpb24gKGV2ZW50TmFtZSwgY2FsbGJhY2spIHtcbiAgICAgIHNvY2tldC5vbihldmVudE5hbWUsIGZ1bmN0aW9uICgpIHsgIFxuICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cztcbiAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KHNvY2tldCwgYXJncyk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSxcbiAgICBlbWl0OiBmdW5jdGlvbiAoZXZlbnROYW1lLCBkYXRhLCBjYWxsYmFjaykge1xuICAgICAgXG4gICAgICBzb2NrZXQuZW1pdChldmVudE5hbWUsIGRhdGEsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwiZW1pdHRlZFwiKTtcbiAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkoc29ja2V0LCBhcmdzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSlcbiAgICB9XG4gIH07XG59IF0pO1xuXG5hcHAuZmFjdG9yeShcInNvY2tldFByb21pc2VcIixbXCIkcVwiLCBcIiRyb290U2NvcGVcIiwgXCJhdXRoSGFzaFwiLCBmdW5jdGlvbiggJHEsICRyb290U2NvcGUsIGF1dGhIYXNoKXtcbiAgICB2YXIgc29ja2V0ID0gaW8uY29ubmVjdCgpO1xuICAgIHZhciBpc19yZWFkeSA9IGZhbHNlO1xuICAgIHZhciBRdWV1ZSA9IFtdO1xuICAgIFxuICAgIGlzX2F1dGhlbnRpY2F0ZWQgPSAkcS5kZWZlcigpO1xuICAgIHNvY2tldC5vbignY29ubmVjdGVkJywgZnVuY3Rpb24oKXtcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJyZWNvbm5lY3Rpb25cIik7XG4gICAgICAgIGF1dGhIYXNoLmdldChmdW5jdGlvbihoYXNoLCB1aWQpe1xuICAgICAgICAgICAgc29ja2V0LmVtaXQoXCJhdXRoX2hhc2hfY29uc29sZVwiLCB7YXV0aDogaGFzaH0pO1xuICAgICAgICB9KVxuICAgIH0pXG4gICAgc29ja2V0Lm9uKFwiYXV0aF9jb21wbGV0ZWRcIiwgZnVuY3Rpb24obXNnKXtcbiAgICAgICAgaWYobXNnLmVycil7XG4gICAgICAgICAgICBpc19hdXRoZW50aWNhdGVkLnJlamVjdChtc2cuZXJyKTtcbiAgICAgICAgfWVsc2V7XG5cbiAgICAgICAgICAgICRyb290U2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCl7aXNfYXV0aGVudGljYXRlZC5yZXNvbHZlKHRydWUpfSlcbiAgICAgICAgfVxuICAgICAgICBcbiAgICB9KVxuICAgIC8vIGNvbnNvbGUubG9nKGlzX2F1dGhlbnRpY2F0ZWQpO1xuICAgIGlzX2F1dGhlbnRpY2F0ZWQucHJvbWlzZS50aGVuKGZ1bmN0aW9uKHMsZSl7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKGlzX2F1dGhlbnRpY2F0ZWQsIHMsZSk7XG4gICAgICAgIGlzX3JlYWR5ID0gdHJ1ZTtcbiAgICAgICAgZm9yKHZhciBpID0wO2kgPFF1ZXVlLmxlbmd0aDsgaSsrKXtcbiAgICAgICAgICAgIHNvY2tldC5lbWl0KFF1ZXVlW2ldLlQsIFF1ZXVlW2ldLnApO1xuICAgICAgICB9XG4gICAgfSlcbiAgICBcbiAgICB2YXIgUyA9IHt9O1xuICAgIHZhciBjYnMgPSB7fTtcbiAgICB2YXIgY3VyY2JpeCA9IDA7XG4gICAgZnVuY3Rpb24gZ2V0Q0JJeCgpe1xuICAgICAgICBjdXJjYml4Kz0xO1xuICAgICAgICByZXR1cm4gY3VyY2JpeCAlIDEwMDAwO1xuICAgIH07XG4gICAgXG4gICAgdmFyIFJlcSA9IGZ1bmN0aW9uKG10LCB0LCBwKXtcbiAgICAgICAgdmFyIGQgPSAkcS5kZWZlcigpLFxuICAgICAgICBjYml4ID0gIGdldENCSXgoKTtcbiAgICAgICAgY2JzW2NiaXhdID0ge1xuICAgICAgICAgICAgY2I6IGRcbiAgICAgICAgfVxuICAgICAgICB2YXIgbyA9IHtwOnB9O1xuICAgICAgICBvLmNiaXggPSBjYml4O1xuICAgICAgICBvLlQgPSB0O1xuICAgICAgICBpZighaXNfcmVhZHkpe1xuICAgICAgICAgICAgUXVldWUucHVzaCh7VDptdCxwOm99KTtcbiAgICAgICAgICAgIFxuICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgIHNvY2tldC5lbWl0KG10LCBvKTtcbiAgICAgICAgICAgIFxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGQucHJvbWlzZTtcbiAgICB9XG4gICAgXG4gICAgdmFyIG1lc3NhZ2VzX3RvX2hlYXIgPSBbXCJRXCIsIFwiUlwiXTtcbiAgICBhbmd1bGFyLmZvckVhY2gobWVzc2FnZXNfdG9faGVhciwgZnVuY3Rpb24obWVzc2FnZV90eXBlKXtcbiAgICAgICAgc29ja2V0Lm9uKG1lc3NhZ2VfdHlwZSwgZnVuY3Rpb24obXNnKXtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiPj4+XCIsIG1zZyk7XG4gICAgICAgICAgICB2YXIgY2JpeCA9IG1zZy5jYml4O1xuICAgICAgICAgICAgaWYoY2JzLmhhc093blByb3BlcnR5KGNiaXgpKSB7XG4gICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkoY2JzW2NiaXhdLmNiLnJlc29sdmUobXNnLmQpKTtcbiAgICAgICAgICAgICAgICBkZWxldGUgY2JzW2NiaXhdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgICBcbiAgICB9KVxuICAgIFxuICAgIFMuZ2V0ID0gZnVuY3Rpb24odCxwKXtcbiAgICAgICAgcmV0dXJuIFJlcShcIlFcIiwgdCxwKVxuICAgIH1cbiAgICBTLnJlcXVlc3QgPSBmdW5jdGlvbih0LHApe1xuICAgICAgICByZXR1cm4gUmVxKFwiUlwiLCB0LHApXG4gICAgfVxuICAgIHJldHVybiBTO1xufV0pXG5cbmFwcC5zZXJ2aWNlKFwic29ja2V0TGlzdGVuZXJzXCIsWydzb2NrZXQnLCBmdW5jdGlvbihzb2NrZXQpe1xuICAgIC8vINCX0LTQtdGB0Ywg0LzRiyDRhdC+0YLQuNC8INGB0L7Qt9C00LDRgtGMINGB0LvRg9C20LHRiywg0LrQvtGC0L7RgNCw0Y8g0YDQtdCz0LjRgdGC0YDQuNGA0YPQtdGCINC90LXRgdC60L7Qu9GM0LrQviDQvtCx0L3QvtCy0LvQtdC90LjQuSDQvdCwINC70Y7QsdGL0LUg0LLRhdC+0LTRj9GJ0LjQtSBzb2NrZXQuaW8g0LfQsNC/0YDQvtGB0YtcbiAgICB2YXIgTGlzdGVuZXJzID0ge1xuICAgICAgICBfbGlzdGVuZXJzIDoge31cbiAgICB9XG4gICAgTGlzdGVuZXJzLnJlZ2lzdGVyID0gZnVuY3Rpb24oZXZlbnRUeXBlLCBjYikge1xuICAgICAgICBpZih0aGlzLl9saXN0ZW5lcnNbZXZlbnRUeXBlXSA9PSBudWxsKXtcbiAgICAgICAgICAgIHRoaXMuX2xpc3RlbmVyc1tldmVudFR5cGVdID0gW2NiXTtcbiAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9saXN0ZW5lcnNbZXZlbnRUeXBlXS5wdXNoKGNiKSAtIDE7IC8vIGN1cnJlbnQgaXRlbSBpbmRleFxuICAgICAgICB9XG4gICAgfVxuICAgIHNvY2tldC5vbihcIldcIiwgZnVuY3Rpb24obWVzc2FnZSl7XG4gICAgICAgIHZhciBtZXNzYWdlX3R5cGUgPSBtZXNzYWdlLnR5cGU7XG4gICAgICAgIFxuICAgICAgICBhbmd1bGFyLmZvckVhY2goTGlzdGVuZXJzLl9saXN0ZW5lcnNbbWVzc2FnZV90eXBlXSwgZnVuY3Rpb24obGlzdGVuZXIpe1xuICAgICAgICAgICAgbGlzdGVuZXIobWVzc2FnZSk7XG4gICAgICAgIH0pXG4gICAgICAgIFxuICAgIH0pXG4gICAgXG4gICAgcmV0dXJuIExpc3RlbmVycztcbiAgICBcbiAgICBcbn1dKSJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==