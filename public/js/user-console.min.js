var app = angular.module("user-console",["treeControl",'ngRoute']);

/*
app.run(["$rootScope","$location", function($rootScope, $location){
    $rootScope['user-console-globals']['$location'] = $location;
}])

*/


var uMap = {
        '':{ label:"Главная","controller": 'rootCont', "templateUrl":"/templates/Root.html"},
        "assets":{ label:"Активы", "controller": 'UserAllAssets', "templateUrl":"/templates/UserAllAssets.html"},
        "ships":{ label:"Мои корабли", "parent":"assets", "controller": 'UserShips', "templateUrl":"/templates/UserShips.html"},
        "goods":{ label:"Разные вещи", "parent":"assets", "controller": 'UserAssets', "templateUrl":"/templates/UserAssets.html"},
        
        "market":{ label:"Рынок", "controller": 'MarketCont', "templateUrl":"/templates/Market.html"},
        "production":{ label:"Производство", "controller": 'ProductionCont', "templateUrl":"/templates/Production.html"},
        "ownProd":{ label:"Собственные фабрики", parent:'production',  "controller": 'OwnPlantsCont', "templateUrl":"/templates/OwnPlants.html"},
        
        "missions":{ label:"Миссии", "controller": 'MissionsCont', "templateUrl":"/templates/Missions.html"},
        "mission-constructor":{ label:"Конструктор миссий", parent:'missions', "controller": 'MissionConstructorCont', "templateUrl":"/templates/MissionConstructor.html"}
        
}

app.constant("moduleUrlMap", uMap)


var getUrls = function(map){
    var url_list = {}

    var getUrl = function(addr, obj, map){
        var na = obj.parent;
        if (parent in map[na]){
            root = getUrl(na, map[na], map);
        }else{
            root = '/';
        }
        return root + na + "/" +addr;
    }

    for(var addr in map){
        var obj = map[addr];
        if('parent' in obj){
            var u = getUrl(addr, obj, map);
        }else{
            var u = "/" + addr;
        }
        // console.log("R",u);
        var no = {url:u, _name: addr,  label:obj.label, ang:{controller:obj.controller, templateUrl:obj.templateUrl }};
        if('parent' in obj){
            no.parent = obj.parent;
        }
        url_list[u] = no;
    }
    return url_list;

}
var getUrlTree = function(map){
    // Надо составить индекс типа
    // {"/url/":[1,2] } - Цифры - это индексы итемов в дереве с чилдренами
    var tree = [];
    var objs = {};
    var roots = [];
    for (var item  in map){
        var obj = map[item];
        obj.children = []
        objs[obj._name] = obj;
        if('parent' in obj){
            // console.log("objs", objs, obj.parent, obj._name);
            objs[obj.parent].children.push(obj);
            // console.log(objs[obj.parent].children);
        }else{
            roots.push(obj._name);
            
        };
    }
    var rtree = [];
    for(var r in roots){
        // console.log("fuck", r);
        rtree.push( objs[roots[r]])
        
    }
    return rtree;
    
}
// getUrlTree(getUrls(uMap));

app.constant("moduleUrls", getUrls(uMap));
app.constant("navTree", getUrlTree(getUrls(uMap) ) );

app.config(["$routeProvider", "moduleUrlMap",  function($routeProvider, moduleUrlMap){
    // $log.log(">>>");
    // $routeScope['user-console-globals'] = {}
    
    var rp = $routeProvider;
    var map  = getUrls(moduleUrlMap);
    // console.log(">>", map);
    for(var url in map){
        // console.log(url);
        rp =  rp.when(url, map[url].ang)
    }
    // rp.otherwise({redirectTo:"/"})
    /*
    $routeProvider
    .when("/assets",{
        controller:"UserAllAssets",
        templateUrl:"/templates/UserAllAssets.html"
    })
    .when("/", {
        controller: "rootCont",
        templateUrl:"/templates/Root.html"
        
    })
    .otherwise({redirectTo:"/"})
    */
}]);


app.controller("userConstructionCont", ["$scope","socketListeners", function($scope,  ws){
    
    ws.register("bookmarked-objects", function(message){
        console.log(message);
        $scope.bookmarkedObjects = message.objects;
        
    })
    
}])
app.controller('UserAllAssets', function($scope, $log, $location, moduleUrls){
    
    var url = $scope.$parent.location.url();
    
    var node = moduleUrls[url];
    
    // $scope.$parent.selected_node = node;
    
    
    $scope.assets = [
    {name:'ble-bla', type:'ship', loc:{}},
    {name:'white Widow', type:'ship', loc:{}},
    {name:'Mavericks', type:'rockets', loc:{ }}
    ]  
    
    
})
app.controller("rootCont", function($scope){
    $scope.hello = "Hello";
})
app.controller('consoleBrowser',['$scope', "$log", "$location", 'navTree',function($scope, $log, $location, navTree){
    $scope.vaar = "Hello cont";
    $log.log($location.path());
    $scope.location = $location;
   // $scope.route = r;
//     $scope.routeProvider = rp;

    //console.log("navTree", navTree);
    $scope.dataForTheTree = navTree;

    $scope.selected_node = navTree[1];
    
    $scope.showSelected = function(node){
        $log.log("showSelected", node);
        $location.url(node.url);
        
    }
    
}] );



app.service('authHash',['$http', '$log', function($http, $log){
    return {
        is_inited:false,
        _hash:null,
        _init:function(cb){
            var that = this;
            this._hash = $http.get( '/my-auth-hash/')
            .then(function(resp){
                $log.log("ah", resp);
                // that._hash = data.hash;
                cb(resp.data.hash)
                
            })
            
        },
        get: function( cb ){
            this._init( cb )
            $log.log("L",this.q, this._hash);
            return this._hash; 
        }
    }
  }] )

app.factory('socket', function ($rootScope, authHash) {
    var socket = io.connect();
    socket.on('connected', function(){
        // console.log("reconnection");
        authHash.get(function(hash){
            // console.log("auth_hash", hash);
            socket.emit("auth_hash_console", {auth: hash})
            
        })
    })
  return {
    getState: function(){return "good"},
    on: function (eventName, callback) {
      socket.on(eventName, function () {  
        var args = arguments;
        $rootScope.$apply(function () {
          callback.apply(socket, args);
        });
      });
    },
    emit: function (eventName, data, callback) {
      socket.emit(eventName, data, function () {
        var args = arguments;
        $rootScope.$apply(function () {
          if (callback) {
            callback.apply(socket, args);
          }
        });
      })
    }
  };
});

app.service("socketListeners",['socket', function(socket){
    // Здесь мы хотим создать службы, которая регистрирует несколько обновлений на любые входящие socket.io запросы
    var Listeners = {
        _listeners : {}
    }
    Listeners.register = function(eventType, cb) {
        if(this._listeners[eventType] == null){
            this._listeners[eventType] = [cb];
            return 0;
        }else{
            return this._listeners[eventType].push(cb) - 1; // current item index
        }
    }
    socket.on("user-console", function(message){
        var message_type = message.type;
        
        angular.forEach(Listeners._listeners[message_type], function(listener){
            listener(message);
        })
        
    })
    
    return Listeners;
    
    
}])
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImNvbnN0cnVjdGlvbi5qcyIsImNvbnRyb2xsZXJzLmpzIiwidHJlZXZpZXcuanMiLCJ3ZWJzb2NrZXQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3RIQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNSQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbkJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3BCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6InVzZXItY29uc29sZS5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoXCJ1c2VyLWNvbnNvbGVcIixbXCJ0cmVlQ29udHJvbFwiLCduZ1JvdXRlJ10pO1xuXG4vKlxuYXBwLnJ1bihbXCIkcm9vdFNjb3BlXCIsXCIkbG9jYXRpb25cIiwgZnVuY3Rpb24oJHJvb3RTY29wZSwgJGxvY2F0aW9uKXtcbiAgICAkcm9vdFNjb3BlWyd1c2VyLWNvbnNvbGUtZ2xvYmFscyddWyckbG9jYXRpb24nXSA9ICRsb2NhdGlvbjtcbn1dKVxuXG4qL1xuXG5cbnZhciB1TWFwID0ge1xuICAgICAgICAnJzp7IGxhYmVsOlwi0JPQu9Cw0LLQvdCw0Y9cIixcImNvbnRyb2xsZXJcIjogJ3Jvb3RDb250JywgXCJ0ZW1wbGF0ZVVybFwiOlwiL3RlbXBsYXRlcy9Sb290Lmh0bWxcIn0sXG4gICAgICAgIFwiYXNzZXRzXCI6eyBsYWJlbDpcItCQ0LrRgtC40LLRi1wiLCBcImNvbnRyb2xsZXJcIjogJ1VzZXJBbGxBc3NldHMnLCBcInRlbXBsYXRlVXJsXCI6XCIvdGVtcGxhdGVzL1VzZXJBbGxBc3NldHMuaHRtbFwifSxcbiAgICAgICAgXCJzaGlwc1wiOnsgbGFiZWw6XCLQnNC+0Lgg0LrQvtGA0LDQsdC70LhcIiwgXCJwYXJlbnRcIjpcImFzc2V0c1wiLCBcImNvbnRyb2xsZXJcIjogJ1VzZXJTaGlwcycsIFwidGVtcGxhdGVVcmxcIjpcIi90ZW1wbGF0ZXMvVXNlclNoaXBzLmh0bWxcIn0sXG4gICAgICAgIFwiZ29vZHNcIjp7IGxhYmVsOlwi0KDQsNC30L3Ri9C1INCy0LXRidC4XCIsIFwicGFyZW50XCI6XCJhc3NldHNcIiwgXCJjb250cm9sbGVyXCI6ICdVc2VyQXNzZXRzJywgXCJ0ZW1wbGF0ZVVybFwiOlwiL3RlbXBsYXRlcy9Vc2VyQXNzZXRzLmh0bWxcIn0sXG4gICAgICAgIFxuICAgICAgICBcIm1hcmtldFwiOnsgbGFiZWw6XCLQoNGL0L3QvtC6XCIsIFwiY29udHJvbGxlclwiOiAnTWFya2V0Q29udCcsIFwidGVtcGxhdGVVcmxcIjpcIi90ZW1wbGF0ZXMvTWFya2V0Lmh0bWxcIn0sXG4gICAgICAgIFwicHJvZHVjdGlvblwiOnsgbGFiZWw6XCLQn9GA0L7QuNC30LLQvtC00YHRgtCy0L5cIiwgXCJjb250cm9sbGVyXCI6ICdQcm9kdWN0aW9uQ29udCcsIFwidGVtcGxhdGVVcmxcIjpcIi90ZW1wbGF0ZXMvUHJvZHVjdGlvbi5odG1sXCJ9LFxuICAgICAgICBcIm93blByb2RcIjp7IGxhYmVsOlwi0KHQvtCx0YHRgtCy0LXQvdC90YvQtSDRhNCw0LHRgNC40LrQuFwiLCBwYXJlbnQ6J3Byb2R1Y3Rpb24nLCAgXCJjb250cm9sbGVyXCI6ICdPd25QbGFudHNDb250JywgXCJ0ZW1wbGF0ZVVybFwiOlwiL3RlbXBsYXRlcy9Pd25QbGFudHMuaHRtbFwifSxcbiAgICAgICAgXG4gICAgICAgIFwibWlzc2lvbnNcIjp7IGxhYmVsOlwi0JzQuNGB0YHQuNC4XCIsIFwiY29udHJvbGxlclwiOiAnTWlzc2lvbnNDb250JywgXCJ0ZW1wbGF0ZVVybFwiOlwiL3RlbXBsYXRlcy9NaXNzaW9ucy5odG1sXCJ9LFxuICAgICAgICBcIm1pc3Npb24tY29uc3RydWN0b3JcIjp7IGxhYmVsOlwi0JrQvtC90YHRgtGA0YPQutGC0L7RgCDQvNC40YHRgdC40LlcIiwgcGFyZW50OidtaXNzaW9ucycsIFwiY29udHJvbGxlclwiOiAnTWlzc2lvbkNvbnN0cnVjdG9yQ29udCcsIFwidGVtcGxhdGVVcmxcIjpcIi90ZW1wbGF0ZXMvTWlzc2lvbkNvbnN0cnVjdG9yLmh0bWxcIn1cbiAgICAgICAgXG59XG5cbmFwcC5jb25zdGFudChcIm1vZHVsZVVybE1hcFwiLCB1TWFwKVxuXG5cbnZhciBnZXRVcmxzID0gZnVuY3Rpb24obWFwKXtcbiAgICB2YXIgdXJsX2xpc3QgPSB7fVxuXG4gICAgdmFyIGdldFVybCA9IGZ1bmN0aW9uKGFkZHIsIG9iaiwgbWFwKXtcbiAgICAgICAgdmFyIG5hID0gb2JqLnBhcmVudDtcbiAgICAgICAgaWYgKHBhcmVudCBpbiBtYXBbbmFdKXtcbiAgICAgICAgICAgIHJvb3QgPSBnZXRVcmwobmEsIG1hcFtuYV0sIG1hcCk7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgcm9vdCA9ICcvJztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcm9vdCArIG5hICsgXCIvXCIgK2FkZHI7XG4gICAgfVxuXG4gICAgZm9yKHZhciBhZGRyIGluIG1hcCl7XG4gICAgICAgIHZhciBvYmogPSBtYXBbYWRkcl07XG4gICAgICAgIGlmKCdwYXJlbnQnIGluIG9iail7XG4gICAgICAgICAgICB2YXIgdSA9IGdldFVybChhZGRyLCBvYmosIG1hcCk7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgdmFyIHUgPSBcIi9cIiArIGFkZHI7XG4gICAgICAgIH1cbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJSXCIsdSk7XG4gICAgICAgIHZhciBubyA9IHt1cmw6dSwgX25hbWU6IGFkZHIsICBsYWJlbDpvYmoubGFiZWwsIGFuZzp7Y29udHJvbGxlcjpvYmouY29udHJvbGxlciwgdGVtcGxhdGVVcmw6b2JqLnRlbXBsYXRlVXJsIH19O1xuICAgICAgICBpZigncGFyZW50JyBpbiBvYmope1xuICAgICAgICAgICAgbm8ucGFyZW50ID0gb2JqLnBhcmVudDtcbiAgICAgICAgfVxuICAgICAgICB1cmxfbGlzdFt1XSA9IG5vO1xuICAgIH1cbiAgICByZXR1cm4gdXJsX2xpc3Q7XG5cbn1cbnZhciBnZXRVcmxUcmVlID0gZnVuY3Rpb24obWFwKXtcbiAgICAvLyDQndCw0LTQviDRgdC+0YHRgtCw0LLQuNGC0Ywg0LjQvdC00LXQutGBINGC0LjQv9CwXG4gICAgLy8ge1wiL3VybC9cIjpbMSwyXSB9IC0g0KbQuNGE0YDRiyAtINGN0YLQviDQuNC90LTQtdC60YHRiyDQuNGC0LXQvNC+0LIg0LIg0LTQtdGA0LXQstC1INGBINGH0LjQu9C00YDQtdC90LDQvNC4XG4gICAgdmFyIHRyZWUgPSBbXTtcbiAgICB2YXIgb2JqcyA9IHt9O1xuICAgIHZhciByb290cyA9IFtdO1xuICAgIGZvciAodmFyIGl0ZW0gIGluIG1hcCl7XG4gICAgICAgIHZhciBvYmogPSBtYXBbaXRlbV07XG4gICAgICAgIG9iai5jaGlsZHJlbiA9IFtdXG4gICAgICAgIG9ianNbb2JqLl9uYW1lXSA9IG9iajtcbiAgICAgICAgaWYoJ3BhcmVudCcgaW4gb2JqKXtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwib2Jqc1wiLCBvYmpzLCBvYmoucGFyZW50LCBvYmouX25hbWUpO1xuICAgICAgICAgICAgb2Jqc1tvYmoucGFyZW50XS5jaGlsZHJlbi5wdXNoKG9iaik7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhvYmpzW29iai5wYXJlbnRdLmNoaWxkcmVuKTtcbiAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICByb290cy5wdXNoKG9iai5fbmFtZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgfTtcbiAgICB9XG4gICAgdmFyIHJ0cmVlID0gW107XG4gICAgZm9yKHZhciByIGluIHJvb3RzKXtcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJmdWNrXCIsIHIpO1xuICAgICAgICBydHJlZS5wdXNoKCBvYmpzW3Jvb3RzW3JdXSlcbiAgICAgICAgXG4gICAgfVxuICAgIHJldHVybiBydHJlZTtcbiAgICBcbn1cbi8vIGdldFVybFRyZWUoZ2V0VXJscyh1TWFwKSk7XG5cbmFwcC5jb25zdGFudChcIm1vZHVsZVVybHNcIiwgZ2V0VXJscyh1TWFwKSk7XG5hcHAuY29uc3RhbnQoXCJuYXZUcmVlXCIsIGdldFVybFRyZWUoZ2V0VXJscyh1TWFwKSApICk7XG5cbmFwcC5jb25maWcoW1wiJHJvdXRlUHJvdmlkZXJcIiwgXCJtb2R1bGVVcmxNYXBcIiwgIGZ1bmN0aW9uKCRyb3V0ZVByb3ZpZGVyLCBtb2R1bGVVcmxNYXApe1xuICAgIC8vICRsb2cubG9nKFwiPj4+XCIpO1xuICAgIC8vICRyb3V0ZVNjb3BlWyd1c2VyLWNvbnNvbGUtZ2xvYmFscyddID0ge31cbiAgICBcbiAgICB2YXIgcnAgPSAkcm91dGVQcm92aWRlcjtcbiAgICB2YXIgbWFwICA9IGdldFVybHMobW9kdWxlVXJsTWFwKTtcbiAgICAvLyBjb25zb2xlLmxvZyhcIj4+XCIsIG1hcCk7XG4gICAgZm9yKHZhciB1cmwgaW4gbWFwKXtcbiAgICAgICAgLy8gY29uc29sZS5sb2codXJsKTtcbiAgICAgICAgcnAgPSAgcnAud2hlbih1cmwsIG1hcFt1cmxdLmFuZylcbiAgICB9XG4gICAgLy8gcnAub3RoZXJ3aXNlKHtyZWRpcmVjdFRvOlwiL1wifSlcbiAgICAvKlxuICAgICRyb3V0ZVByb3ZpZGVyXG4gICAgLndoZW4oXCIvYXNzZXRzXCIse1xuICAgICAgICBjb250cm9sbGVyOlwiVXNlckFsbEFzc2V0c1wiLFxuICAgICAgICB0ZW1wbGF0ZVVybDpcIi90ZW1wbGF0ZXMvVXNlckFsbEFzc2V0cy5odG1sXCJcbiAgICB9KVxuICAgIC53aGVuKFwiL1wiLCB7XG4gICAgICAgIGNvbnRyb2xsZXI6IFwicm9vdENvbnRcIixcbiAgICAgICAgdGVtcGxhdGVVcmw6XCIvdGVtcGxhdGVzL1Jvb3QuaHRtbFwiXG4gICAgICAgIFxuICAgIH0pXG4gICAgLm90aGVyd2lzZSh7cmVkaXJlY3RUbzpcIi9cIn0pXG4gICAgKi9cbn1dKTtcblxuIiwiYXBwLmNvbnRyb2xsZXIoXCJ1c2VyQ29uc3RydWN0aW9uQ29udFwiLCBbXCIkc2NvcGVcIixcInNvY2tldExpc3RlbmVyc1wiLCBmdW5jdGlvbigkc2NvcGUsICB3cyl7XG4gICAgXG4gICAgd3MucmVnaXN0ZXIoXCJib29rbWFya2VkLW9iamVjdHNcIiwgZnVuY3Rpb24obWVzc2FnZSl7XG4gICAgICAgIGNvbnNvbGUubG9nKG1lc3NhZ2UpO1xuICAgICAgICAkc2NvcGUuYm9va21hcmtlZE9iamVjdHMgPSBtZXNzYWdlLm9iamVjdHM7XG4gICAgICAgIFxuICAgIH0pXG4gICAgXG59XSkiLCJhcHAuY29udHJvbGxlcignVXNlckFsbEFzc2V0cycsIGZ1bmN0aW9uKCRzY29wZSwgJGxvZywgJGxvY2F0aW9uLCBtb2R1bGVVcmxzKXtcbiAgICBcbiAgICB2YXIgdXJsID0gJHNjb3BlLiRwYXJlbnQubG9jYXRpb24udXJsKCk7XG4gICAgXG4gICAgdmFyIG5vZGUgPSBtb2R1bGVVcmxzW3VybF07XG4gICAgXG4gICAgLy8gJHNjb3BlLiRwYXJlbnQuc2VsZWN0ZWRfbm9kZSA9IG5vZGU7XG4gICAgXG4gICAgXG4gICAgJHNjb3BlLmFzc2V0cyA9IFtcbiAgICB7bmFtZTonYmxlLWJsYScsIHR5cGU6J3NoaXAnLCBsb2M6e319LFxuICAgIHtuYW1lOid3aGl0ZSBXaWRvdycsIHR5cGU6J3NoaXAnLCBsb2M6e319LFxuICAgIHtuYW1lOidNYXZlcmlja3MnLCB0eXBlOidyb2NrZXRzJywgbG9jOnsgfX1cbiAgICBdICBcbiAgICBcbiAgICBcbn0pXG5hcHAuY29udHJvbGxlcihcInJvb3RDb250XCIsIGZ1bmN0aW9uKCRzY29wZSl7XG4gICAgJHNjb3BlLmhlbGxvID0gXCJIZWxsb1wiO1xufSkiLCJhcHAuY29udHJvbGxlcignY29uc29sZUJyb3dzZXInLFsnJHNjb3BlJywgXCIkbG9nXCIsIFwiJGxvY2F0aW9uXCIsICduYXZUcmVlJyxmdW5jdGlvbigkc2NvcGUsICRsb2csICRsb2NhdGlvbiwgbmF2VHJlZSl7XG4gICAgJHNjb3BlLnZhYXIgPSBcIkhlbGxvIGNvbnRcIjtcbiAgICAkbG9nLmxvZygkbG9jYXRpb24ucGF0aCgpKTtcbiAgICAkc2NvcGUubG9jYXRpb24gPSAkbG9jYXRpb247XG4gICAvLyAkc2NvcGUucm91dGUgPSByO1xuLy8gICAgICRzY29wZS5yb3V0ZVByb3ZpZGVyID0gcnA7XG5cbiAgICAvL2NvbnNvbGUubG9nKFwibmF2VHJlZVwiLCBuYXZUcmVlKTtcbiAgICAkc2NvcGUuZGF0YUZvclRoZVRyZWUgPSBuYXZUcmVlO1xuXG4gICAgJHNjb3BlLnNlbGVjdGVkX25vZGUgPSBuYXZUcmVlWzFdO1xuICAgIFxuICAgICRzY29wZS5zaG93U2VsZWN0ZWQgPSBmdW5jdGlvbihub2RlKXtcbiAgICAgICAgJGxvZy5sb2coXCJzaG93U2VsZWN0ZWRcIiwgbm9kZSk7XG4gICAgICAgICRsb2NhdGlvbi51cmwobm9kZS51cmwpO1xuICAgICAgICBcbiAgICB9XG4gICAgXG59XSApO1xuXG4iLCJcbmFwcC5zZXJ2aWNlKCdhdXRoSGFzaCcsWyckaHR0cCcsICckbG9nJywgZnVuY3Rpb24oJGh0dHAsICRsb2cpe1xuICAgIHJldHVybiB7XG4gICAgICAgIGlzX2luaXRlZDpmYWxzZSxcbiAgICAgICAgX2hhc2g6bnVsbCxcbiAgICAgICAgX2luaXQ6ZnVuY3Rpb24oY2Ipe1xuICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgICAgICAgICAgdGhpcy5faGFzaCA9ICRodHRwLmdldCggJy9teS1hdXRoLWhhc2gvJylcbiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3Ape1xuICAgICAgICAgICAgICAgICRsb2cubG9nKFwiYWhcIiwgcmVzcCk7XG4gICAgICAgICAgICAgICAgLy8gdGhhdC5faGFzaCA9IGRhdGEuaGFzaDtcbiAgICAgICAgICAgICAgICBjYihyZXNwLmRhdGEuaGFzaClcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBcbiAgICAgICAgfSxcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiggY2IgKXtcbiAgICAgICAgICAgIHRoaXMuX2luaXQoIGNiIClcbiAgICAgICAgICAgICRsb2cubG9nKFwiTFwiLHRoaXMucSwgdGhpcy5faGFzaCk7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5faGFzaDsgXG4gICAgICAgIH1cbiAgICB9XG4gIH1dIClcblxuYXBwLmZhY3RvcnkoJ3NvY2tldCcsIGZ1bmN0aW9uICgkcm9vdFNjb3BlLCBhdXRoSGFzaCkge1xuICAgIHZhciBzb2NrZXQgPSBpby5jb25uZWN0KCk7XG4gICAgc29ja2V0Lm9uKCdjb25uZWN0ZWQnLCBmdW5jdGlvbigpe1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhcInJlY29ubmVjdGlvblwiKTtcbiAgICAgICAgYXV0aEhhc2guZ2V0KGZ1bmN0aW9uKGhhc2gpe1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCJhdXRoX2hhc2hcIiwgaGFzaCk7XG4gICAgICAgICAgICBzb2NrZXQuZW1pdChcImF1dGhfaGFzaF9jb25zb2xlXCIsIHthdXRoOiBoYXNofSlcbiAgICAgICAgICAgIFxuICAgICAgICB9KVxuICAgIH0pXG4gIHJldHVybiB7XG4gICAgZ2V0U3RhdGU6IGZ1bmN0aW9uKCl7cmV0dXJuIFwiZ29vZFwifSxcbiAgICBvbjogZnVuY3Rpb24gKGV2ZW50TmFtZSwgY2FsbGJhY2spIHtcbiAgICAgIHNvY2tldC5vbihldmVudE5hbWUsIGZ1bmN0aW9uICgpIHsgIFxuICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cztcbiAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkoZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KHNvY2tldCwgYXJncyk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSxcbiAgICBlbWl0OiBmdW5jdGlvbiAoZXZlbnROYW1lLCBkYXRhLCBjYWxsYmFjaykge1xuICAgICAgc29ja2V0LmVtaXQoZXZlbnROYW1lLCBkYXRhLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzO1xuICAgICAgICAkcm9vdFNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgICAgICBjYWxsYmFjay5hcHBseShzb2NrZXQsIGFyZ3MpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9KVxuICAgIH1cbiAgfTtcbn0pO1xuXG5hcHAuc2VydmljZShcInNvY2tldExpc3RlbmVyc1wiLFsnc29ja2V0JywgZnVuY3Rpb24oc29ja2V0KXtcbiAgICAvLyDQl9C00LXRgdGMINC80Ysg0YXQvtGC0LjQvCDRgdC+0LfQtNCw0YLRjCDRgdC70YPQttCx0YssINC60L7RgtC+0YDQsNGPINGA0LXQs9C40YHRgtGA0LjRgNGD0LXRgiDQvdC10YHQutC+0LvRjNC60L4g0L7QsdC90L7QstC70LXQvdC40Lkg0L3QsCDQu9GO0LHRi9C1INCy0YXQvtC00Y/RidC40LUgc29ja2V0LmlvINC30LDQv9GA0L7RgdGLXG4gICAgdmFyIExpc3RlbmVycyA9IHtcbiAgICAgICAgX2xpc3RlbmVycyA6IHt9XG4gICAgfVxuICAgIExpc3RlbmVycy5yZWdpc3RlciA9IGZ1bmN0aW9uKGV2ZW50VHlwZSwgY2IpIHtcbiAgICAgICAgaWYodGhpcy5fbGlzdGVuZXJzW2V2ZW50VHlwZV0gPT0gbnVsbCl7XG4gICAgICAgICAgICB0aGlzLl9saXN0ZW5lcnNbZXZlbnRUeXBlXSA9IFtjYl07XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fbGlzdGVuZXJzW2V2ZW50VHlwZV0ucHVzaChjYikgLSAxOyAvLyBjdXJyZW50IGl0ZW0gaW5kZXhcbiAgICAgICAgfVxuICAgIH1cbiAgICBzb2NrZXQub24oXCJ1c2VyLWNvbnNvbGVcIiwgZnVuY3Rpb24obWVzc2FnZSl7XG4gICAgICAgIHZhciBtZXNzYWdlX3R5cGUgPSBtZXNzYWdlLnR5cGU7XG4gICAgICAgIFxuICAgICAgICBhbmd1bGFyLmZvckVhY2goTGlzdGVuZXJzLl9saXN0ZW5lcnNbbWVzc2FnZV90eXBlXSwgZnVuY3Rpb24obGlzdGVuZXIpe1xuICAgICAgICAgICAgbGlzdGVuZXIobWVzc2FnZSk7XG4gICAgICAgIH0pXG4gICAgICAgIFxuICAgIH0pXG4gICAgXG4gICAgcmV0dXJuIExpc3RlbmVycztcbiAgICBcbiAgICBcbn1dKSJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==